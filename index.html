<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketing Manager</title>
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    body {
      background: #fff;
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .btn-primary {
      background-color: #6B46C1;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-primary:hover {
      background-color: #553C9A;
    }
    .btn-secondary {
      background-color: #9F7AEA;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-secondary:hover {
      background-color: #805AD5;
    }
    .btn-remove {
      background-color: #EF4444;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-remove:hover {
      background-color: #DC2626;
    }
    .btn-remove-light {
      background-color: #FFEB3B;
      color: #7C6F00;
      transition: background-color 0.3s;
      border: 1px solid #FBC02D;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      width: 100%;
    }
    .btn-remove-light:hover {
      background-color: #FFF176;
    }
    
    /* Campaign table styles */
    .crm-table {
      border-collapse: collapse;
      font-size: 13px;
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
      background: #fff;
      width: 100%;
    }
    .crm-table th, .crm-table td {
      font-weight: normal;
      padding: 0.32rem 0.6rem 0.32rem 0.6rem;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-left: none;
      vertical-align: middle;
      white-space: nowrap;
      height: 34px;
      min-width: 110px;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #fff;
    }
    .crm-table th {
      background: #f8f9fa;
      color: #222;
      font-size: 13px;
      font-weight: bold;
      border-bottom: 1.5px solid #d0d0d0;
    }
    .crm-table tbody tr:hover {
      background: #f4f7fa;
    }
    .crm-table tr:last-child td {
      border-bottom: 1px solid #e0e0e0;
    }
    .crm-table th:not(:last-child), .crm-table td:not(:last-child) {
      border-right: 1px solid #e0e0e0;
    }
    .crm-table td:last-child {
      white-space: normal;
      overflow: visible;
      min-width: 120px;
      max-width: none;
    }
    .crm-table td:last-child .btn {
      margin: 1px;
      font-size: 11px;
      padding: 2px 6px;
    }
    
    /* Filter styles */
    .form-control-sm {
      height: 28px;
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      width: 100%;
    }
    .form-control-sm:focus {
      border-color: #6B46C1;
      outline: none;
      box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
    }
    .mt-1 {
      margin-top: 2px;
    }
    .section {
      width: 100%;
      padding: 1.25rem 0;
    }

    .card {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    
    /* Custom tooltip styles */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: "Tags can only be generated automatically";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      margin-bottom: 3px;
      z-index: 1000;
    }
  </style>
</head>
  <!-- Login Form -->
  <div id="login-form" class="min-h-screen flex items-center justify-center bg-white" style="display: none;">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Trichy Gold</h1>
        <h2 class="text-lg font-semibold text-purple-600">Campaign Manager</h2>
      </div>
      
      <!-- Login Form -->
      <form class="space-y-8" id="loginForm">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input id="username" name="username" type="text" required autocomplete="username"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your username">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input id="password" name="password" type="password" required autocomplete="current-password"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your password">
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-md text-sm"></div>
        <div>
          <button type="submit" 
                  class="w-full py-3 px-4 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
            Sign in
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="min-h-screen flex items-center justify-center">
  <!-- MAIN CARD - ALL UI SECTIONS MUST BE INSIDE THIS DIV -->
    <div class="card w-full p-6 relative">
            <h1 class="text-2xl font-bold text-center text-purple-700 mb-6">Trichy Gold Marketing Manager</h1>
    
    <!-- Main Menu -->
    <div class="mb-8">
      <div class="flex gap-4 justify-center">
        <button onclick="showSection('campaigns-table')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üìä</span>
          <span>Marketing Table</span>
        </button>
        <button onclick="showSection('new-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">‚ûï</span>
          <span>Add New</span>
        </button>
        <button onclick="showSection('query-campaign')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üîç</span>
          <span>Query</span>
        </button>
        <button onclick="showSection('edit-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">‚úèÔ∏è</span>
          <span>Edit</span>
        </button>
        <button onclick="showSection('delete-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center delete-campaign-btn" style="display: none;">
          <span class="mr-2">üóëÔ∏è</span>
          <span>Delete</span>
        </button>

        <button onclick="showSection('export-campaign')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üì•</span>
          <span>Export Table</span>
        </button>
        <button onclick="showSection('impression-tracking')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üìà</span>
          <span>Impression Tracking</span>
        </button>
        <button onclick="showSection('user-manager')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.485 0 4.797.657 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>User & Role Manager</span>
        </button>
        <button onclick="showSection('channel-manager')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span>Channel Manager</span>
        </button>

        <button onclick="window.sessionManager.logout()" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Campaigns Table Section -->
    <div id="campaigns-table" class="section">
      


      <!-- Campaigns Table -->
      <div class="mb-4">
        <div class="mb-2"><b>Total Records:</b> <span id="campaigns-count">0</span></div>
      </div>
      <div style="overflow-x: auto; width: 100%; border-bottom: 1.5px solid #d0d0d0;">
        <table class="crm-table" style="min-width: max-content; width: 100%;">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th style="width: 60px;">#</th>
                              <th style="width: 120px;">Marketing ID</th>
              <th style="width: 150px;">Name</th>
              <th style="width: 120px;">Description</th>
              <th style="width: 100px;">Work Start Date</th>
              <th style="width: 100px;">Start Date</th>
              <th style="width: 100px;">End Date</th>
              <th style="width: 100px;">Budget (AED)</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 120px;">Job Assigned To</th>
              <th style="width: 120px;">Target Age</th>
              <th style="width: 100px;">Target Gender</th>
              <th style="width: 100px;">Goal Sales</th>
              <th style="width: 100px;">Goal Impressions</th>
              <th style="width: 100px;">Goal Conversions</th>
              <th style="width: 120px;">Achvd Sales</th>
              <th style="width: 120px;">Achvd Impressions</th>
              <th style="width: 120px;">Achvd Conversions</th>
              <th style="width: 150px;">Channels</th>
              <th style="width: 150px;">Channel Tag</th>
              <th style="width: 150px;">Reference Codes</th>
              <th style="width: 100px;">Image</th>
            </tr>
            <tr>
              <th><!-- No filter for checkbox --></th>
              <th><!-- No filter for # --></th>
                              <th><input type="text" id="filter-campaign-id" placeholder="Filter Marketing ID" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-campaign-name" placeholder="Filter Name" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-offers" placeholder="Filter Description" class="form-control form-control-sm"></th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center" style="font-weight: normal;">Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-work-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px; font-weight: normal;">
                  <input type="date" id="filter-work-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important; font-weight: normal;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center" style="font-weight: normal;">Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px; font-weight: normal;">
                  <input type="date" id="filter-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important; font-weight: normal;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center" style="font-weight: normal;">Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-end-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px; font-weight: normal;">
                  <input type="date" id="filter-end-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important; font-weight: normal;">
                </div>
              </th>
              <th>
                <input type="number" id="filter-budget-min" class="form-control form-control-sm" placeholder="Min">
                <input type="number" id="filter-budget-max" class="form-control form-control-sm mt-1" placeholder="Max">
              </th>
              <th>
                <select id="filter-status" class="form-control form-control-sm">
                  <option value="">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </th>
              <th>
                <select id="filter-job-assigned-to" class="form-control form-control-sm">
                  <option value="">All Job Assigned To</option>
                </select>
              </th>
              <th><input type="text" id="filter-target-age" placeholder="Filter Age" class="form-control form-control-sm"></th>
              <th>
                <select id="filter-target-gender" class="form-control form-control-sm">
                  <option value="">All</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Everyone">Everyone</option>
                </select>
              </th>
              <th>
                <input type="number" id="filter-goal-sales-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-sales-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-goal-impressions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-impressions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-goal-conversions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-conversions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-sales-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-sales-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-impressions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-impressions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-conversions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-conversions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <select id="filter-channels" class="form-control form-control-sm">
                  <option value="">All Channels</option>
                  <option value="Instagram">Instagram</option>
                  <option value="Facebook">Facebook</option>
                  <option value="TikTok">TikTok</option>
                  <option value="YouTube">YouTube</option>
                  <option value="Snapchat">Snapchat</option>
                  <option value="Google">Google</option>
                  <option value="Website">Website</option>
                  <option value="SMS">SMS</option>
                  <option value="Email">Email</option>
                  <option value="Radio">Radio</option>
                  <option value="Television">Television</option>
                  <option value="WhatsApp Group">WhatsApp Group</option>
                  <option value="Social organisations">Social organisations</option>
                  <option value="Gold councils">Gold councils</option>
                  <option value="Residential Community">Residential Community</option>
                  <option value="Lang/Cultural group">Lang/Cultural group</option>
                  <option value="Religious group">Religious group</option>
                  <option value="Bluecollar Camp">Bluecollar Camp</option>
                  <option value="Neighbourhood Community">Neighbourhood Community</option>
                  <option value="Event">Event</option>
                  <option value="Exhibition">Exhibition</option>
                  <option value="Channel Partners">Channel Partners</option>
                  <option value="Corporate Partners">Corporate Partners</option>
                  <option value="Hotel">Hotel</option>
                  <option value="Tour Driver">Tour Driver</option>
                  <option value="Tours&Travel Agency">Tours&Travel Agency</option>
                  <option value="New collection Launch">New collection Launch</option>
                  <option value="Print Media">Print Media</option>
                  <option value="Referral">Referral</option>
                  <option value="Storefront">Storefront</option>
                  <option value="Outdoor Ads">Outdoor Ads</option>
                  <option value="Others">Others</option>
                </select>
              </th>
              <th>
                <input type="text" id="filter-channel-tags" list="filterChannelTagList" placeholder="Filter Channel Tags" class="form-control form-control-sm" autocomplete="off">
                <datalist id="filterChannelTagList">
                  <!-- Options will be populated dynamically -->
                </datalist>
              </th>
              <th>
                <input type="text" id="filter-tag-numbers" placeholder="Filter Reference Codes" class="form-control form-control-sm">
              </th>
              <th><!-- No filter for Image --></th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body">
            <!-- Campaigns will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>


    <div id="new-campaign" class="section hidden">
              <h2 class="text-lg font-semibold text-purple-700 mb-4">Create New</h2>
      <div class="space-y-6">
        <!-- Campaign Form -->
        <div class="mb-6">
          <div class="space-y-6">
            <!-- Campaign ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="campaignId" class="block text-sm font-medium text-purple-700">Marketing ID</label>
                <input id="campaignId" type="text" readonly class="w-full p-2 border rounded-md bg-gray-100 focus:outline-none" placeholder="Will be assigned automatically">
              </div>
              <div>
                <label for="name" class="block text-sm font-medium text-purple-700">Name</label>
                <input id="name" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Description -->
            <div>
              <label for="description" class="block text-sm font-medium text-purple-700">Description</label>
              <input id="description" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            

            <!-- Work Start Date, Start Date and End Date -->
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label for="workStartDate" class="block text-sm font-medium text-purple-700">Work Start Date</label>
                <input id="workStartDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="startDate" class="block text-sm font-medium text-purple-700">Start Date</label>
                <input id="startDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="endDate" class="block text-sm font-medium text-purple-700">End Date</label>
                <input id="endDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Budget, Status and Job Assigned To -->
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label for="budget" class="block text-sm font-medium text-purple-700">Budget (AED)</label>
                <input id="budget" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="status" class="block text-sm font-medium text-purple-700">Status</label>
                <select id="status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required> 
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label for="jobAssignedTo" class="block text-sm font-medium text-purple-700">Job Assigned To</label>
                <select id="jobAssignedTo" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">Select Employee</option>
                </select>
              </div>
            </div>
            
            <!-- Target Audience -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Target Audience</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="targetAge" class="block text-sm font-medium text-purple-700">Age</label>
                  <input id="targetAge" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g. 18-30">
                </div>
                <div>
                  <label for="targetGender" class="block text-sm font-medium text-purple-700">Gender <span class="text-red-500">*</span></label>
                  <select id="targetGender" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    <option value="" selected>Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Everyone">Everyone</option>
                  </select>
                </div>
              </div>
              
            </div>
            
            
            <!-- Goals -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Goals</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label for="goalSales" class="block text-sm font-medium text-purple-700">Sales (AED)</label>
                  <input id="goalSales" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                  <label for="goalImpressions" class="block text-sm font-medium text-purple-700">Impressions</label>
                  <input id="goalImpressions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                  <label for="goalConversions" class="block text-sm font-medium text-purple-700">Conversions</label>
                  <input id="goalConversions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
              </div>
            </div>
            
            <!-- Achieved -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-green-600 mb-2">üéØ Achieved</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label for="achievedSales" class="block text-sm font-medium text-green-700">Sales (AED)</label>
                  <input id="achievedSales" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label for="achievedImpressions" class="block text-sm font-medium text-green-700">Impressions</label>
                  <input id="achievedImpressions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label for="achievedConversions" class="block text-sm font-medium text-green-700">Conversions</label>
                  <input id="achievedConversions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
              </div>
            </div>
            
            <!-- Channels -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Channels</h3>
              <div id="channelContainer" class="space-y-8">
                <div class="channelEntry grid grid-cols-8 gap-2 items-end p-4 border border-gray-200 rounded-lg bg-gray-50">
                  <div class="col-span-1">
                    <label class="block text-sm font-medium text-purple-700">Channel Type</label>
                    <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
                      <option value="">Select Channel</option>
                      <option value="Instagram">Instagram</option>
                      <option value="Facebook">Facebook</option>
                      <option value="TikTok">TikTok</option>
                      <option value="YouTube">YouTube</option>
                      <option value="Snapchat">Snapchat</option>
                      <option value="Google">Google</option>
                      <option value="Website">Website</option>
                      <option value="SMS">SMS</option>
                      <option value="Email">Email</option>
                      <option value="Radio">Radio</option>
                      <option value="Television">Television</option>
                      <option value="WhatsApp Group">WhatsApp Group</option>
                      <option value="Social organisations">Social organisations</option>
                      <option value="Gold councils">Gold councils</option>
                      <option value="Residential Community">Residential Community</option>
                      <option value="Lang/Cultural group">Lang/Cultural group</option>
                      <option value="Religious group">Religious group</option>
                      <option value="Bluecollar Camp">Bluecollar Camp</option>
                      <option value="Neighbourhood Community">Neighbourhood Community</option>
                      <option value="Event">Event</option>
                      <option value="Exhibition">Exhibition</option>
                      <option value="Channel Partners">Channel Partners</option>
                      <option value="Corporate Partners">Corporate Partners</option>
                      <option value="Hotel">Hotel</option>
                      <option value="Tour Driver">Tour Driver</option>
                      <option value="Tours&Travel Agency">Tours&Travel Agency</option>
                      <option value="New collection Launch">New collection Launch</option>
                      <option value="Print Media">Print Media</option>
                      <option value="Referral">Referral</option>
                      <option value="Storefront">Storefront</option>
                      <option value="Outdoor Ads">Outdoor Ads</option>
                      <option value="Others">Others</option>
                    </select>
                  </div>
                  <div class="col-span-1">
                    <label class="block text-sm font-medium text-purple-700">Channel Tag</label>
                    <input 
                      type="text" 
                      class="channelTag p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" 
                      list="channelTagList" 
                      placeholder="Optional - Select or type"
                      autocomplete="off"
                    >
                    <datalist id="channelTagList">
                      <!-- Options will be populated dynamically -->
                    </datalist>
                  </div>
                  <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
                  <div class="col-span-1 flex items-center justify-start">
                    <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
                      Remove
                    </button>
                  </div>
                </div>
              </div>
              <button class="btn-secondary mt-2 py-2 px-4 rounded-md" onclick="addChannelEntry()">Add Channel</button>
            </div>
            
            <!-- Campaign Images -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Campaign Images</h3>
              <div id="imageUploadContainer">
                <div class="image-upload-item mb-4">
                  <input type="file" accept="image/*" class="image-upload-input w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <p class="text-xs text-gray-500 mt-1">Upload an image for this campaign (JPG, PNG, GIF - Max 5MB)</p>
                  <div class="image-preview mt-2 hidden">
                    <img src="" alt="Campaign Preview" class="max-w-xs h-32 object-cover rounded-md border">
                    <button type="button" class="remove-image-btn mt-1 text-sm text-red-600 hover:text-red-800">Remove Image</button>
                  </div>
                </div>
              </div>
              <button type="button" id="addImageBtn" class="btn-secondary py-2 px-4 rounded-md">Add More Images</button>
            </div>
            
            <button onclick="submitCampaign()" class="btn-primary w-full py-2 rounded-md">Create New</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Campaign Section -->
    <div id="edit-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Edit</h2>
      <div class="space-y-6">
        <div class="mb-6">
          <label for="editCampaignId" class="block text-sm font-medium text-gray-700 mb-2">Enter Marketing ID to Edit</label>
          <div class="flex items-center space-x-4">
            <input id="editCampaignId" type="text" 
                   class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   placeholder="e.g., MK_000001">
            <button onclick="loadCampaignForEdit()" 
                    class="btn-secondary py-2 px-4 rounded-md whitespace-nowrap ml-12">
              Load
            </button>
          </div>
        </div>
        <div id="editCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign form will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Query Campaign Section -->
    <div id="query-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Query</h2>
      <div class="space-y-4">
        <!-- Manual Campaign Code Entry -->
        <div id="queryManualEntryContainer" class="flex gap-2 items-end">
          <input id="queryCampaignCodeInput" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter Marketing Code (e.g., MK_000001)">
          <button id="queryLoadBtn" class="btn-secondary py-2 px-4 rounded-md">Load</button>
          </div>
        <div id="queryCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign details form will be loaded here -->
</div>
</div>
<button id="downloadExcelBtn" class="btn-secondary mt-3 py-2 px-4 rounded-md hidden" onclick="exportQueriedCampaign()">Export Table</button>
<script>
        // Helper to show/hide query campaign input section
        function setQueryCampaignInputVisibility(visible) {
          const manualInput = document.getElementById('queryManualEntryContainer');
          if (manualInput) {
            if (visible) {
              manualInput.classList.remove('hidden');
            } else {
              manualInput.classList.add('hidden');
            }
          }
          // Also hide the query form if not visible
          const queryForm = document.getElementById('queryCampaignForm');
          if (!visible && queryForm) {
            queryForm.classList.remove('hidden');
          }
        }

        // Update query section menu functionality to handle both entry points
        function addQueryCampaignMenuFunctionality() {
          const queryMenuBtn = document.querySelector("button[onclick=\"showSection('query-campaign')\"]");
          if (!queryMenuBtn) { console.log('Query menu button not found'); return; }
          queryMenuBtn.addEventListener('click', function(event) {
            event.preventDefault();
            // Find selected campaign
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
            if (selectedRadio) {
              // Query via radio selection: hide input, show form
              setQueryCampaignInputVisibility(false);
              showSection('query-campaign');
              window.querySelectedCampaign();
              // Ensure the query form is visible
              const queryForm = document.getElementById('queryCampaignForm');
              if (queryForm) queryForm.classList.remove('hidden');
            } else {
              // Query via menu: show input, hide form
              showSection('query-campaign');
              setQueryCampaignInputVisibility(true);
              const queryForm = document.getElementById('queryCampaignForm');
              if (queryForm) queryForm.classList.add('hidden');
            }
          });
        }

        // Manual campaign code entry logic for Query
  document.addEventListener('DOMContentLoaded', function() {
          addQueryCampaignMenuFunctionality();
            const queryLoadBtn = document.getElementById('queryLoadBtn');
            if (queryLoadBtn) {
              queryLoadBtn.addEventListener('click', function() {
                const code = document.getElementById('queryCampaignCodeInput').value.trim();
                if (!code) {
                  alert('Please enter a marketing code.');
                  return;
                }
                // Find by campaignId (not _id)
                const campaign = originalCampaigns.find(c => c.campaignId === code);
                if (!campaign) {
                  alert('Campaign not found.');
                  return;
                }
                // Simulate radio selection logic
                window.querySelectedCampaignById(campaign._id);
              });
            }
            // Update visibility on page load
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          setQueryCampaignInputVisibility(!selectedRadio);
            // Update visibility on radio selection change
            document.addEventListener('change', function(e) {
              if (e.target && e.target.name === 'selected_campaign') {
              setQueryCampaignInputVisibility(false);
              window.querySelectedCampaign();
              }
            });
          });
          // Helper to trigger query by _id
          window.querySelectedCampaignById = function(campaignId) {
            if (typeof window.querySelectedCampaign === 'function') {
              window.querySelectedCampaign(campaignId);
            }
          }
</script>
    </div>

    <!-- Export Section -->
    <div id="export-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Export All Marketing Records to Excel</h2>
              <button onclick="exportCampaigns()" class="btn-primary w-full py-2 rounded-md">Export Table</button>
    </div>

    <!-- Impression Tracking Section -->
    <div id="impression-tracking" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Impression & Conversion Tracking & Analytics</h2>
      
      <!-- Function Buttons with Descriptions -->
      <div class="mb-6">
        <p class="text-base font-medium text-gray-700 mb-4">Select a function below to view or manage impression data.</p>
        <div class="flex flex-wrap gap-4 mb-4 justify-center">
          <button onclick="toggleImpressionSection('overallStats')" class="btn-primary py-2 px-4 rounded-lg text-xs w-24" title="View summary total impressions, conversions, and channel breakdowns">üìä Stats</button>
          <button onclick="toggleImpressionSection('updateImpressions')" class="btn-primary py-2 px-4 rounded-lg text-xs w-24" title="Edit impression and conversion for channels by Marketing ID">‚úèÔ∏è Update</button>
          <button onclick="toggleImpressionSection('searchByTag')" class="btn-primary py-2 px-4 rounded-lg text-xs w-24" title="Find channels and marketing initiatives by searching with Reference Code (tag number)">üîç Search</button>
          <button onclick="toggleImpressionSection('tagCounters')" class="btn-primary py-2 px-4 rounded-lg text-xs w-24" title="View Reference Code counters showing the last used number">üî¢ Counters</button>
        </div>
      </div>

      <!-- Impression Statistics -->
      <div id="overallStats" class="mb-6 hidden">
        <h3 class="text-md font-medium text-blue-600 mb-3">üìä Overall Statistics</h3>
        <button onclick="loadImpressionStats()" class="btn-secondary mb-4 py-2 px-4 rounded-md">Refresh Statistics</button>
        <div id="impressionStats">
          <!-- Stats will be loaded here -->
        </div>
      </div>

      <!-- Update Impressions -->
      <div id="updateImpressions" class="mb-6 hidden">
        <h3 class="text-md font-medium text-orange-600 mb-3">‚úèÔ∏è Update Impressions</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="updateCampaignId" class="block text-sm font-medium text-purple-700">Marketing ID</label>
              <input id="updateCampaignId" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., MK_000001">
            </div>
            <div class="flex items-end">
              <button onclick="loadCampaignChannels()" class="btn-secondary py-2 px-4 rounded-md">Load Campaign</button>
            </div>
          </div>
          
          <!-- Marketing Achieved Impressions and Conversions -->
          <div id="marketingAchievedDisplay" class="hidden mt-4 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h4 class="text-sm font-medium text-blue-700 mb-3">Marketing Achieved Impressions & Conversions</h4>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm font-medium text-gray-700 mb-1">Current Impressions</p>
                <p class="text-lg font-bold text-blue-600" id="currentMarketingImpressions">0</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">New Impressions</label>
                <input type="number" 
                       id="marketingImpressions" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       placeholder="Enter new value" 
                       min="0">
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700 mb-1">Current Conversions</p>
                <p class="text-lg font-bold text-green-600" id="currentMarketingConversions">0</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">New Conversions</label>
                <input type="number" 
                       id="marketingConversions" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       placeholder="Enter new value" 
                       min="0">
              </div>
            </div>
            <div class="mt-4">
              <button onclick="updateMarketingAchieved()" class="btn-primary py-2 px-4 rounded-md">Update Marketing Achieved</button>
            </div>
          </div>
          
          <!-- Campaign Channels Display -->
          <div id="campaignChannelsDisplay" class="hidden mt-4">
            <h4 class="text-sm font-medium text-purple-700 mb-3">Campaign Channels</h4>
            <div id="channelsList" class="space-y-3">
              <!-- Channels will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Tag Search -->
      <div id="searchByTag" class="mb-6 hidden">
        <h3 class="text-md font-medium text-indigo-600 mb-3">üîç Search by Reference Code</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="searchTagNumber" class="block text-sm font-medium text-purple-700">Reference Code</label>
              <input id="searchTagNumber" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., IG00001, FB00002">
            </div>
            <div class="flex items-end">
              <button onclick="searchByTag()" class="btn-primary py-2 px-4 rounded-md">Search</button>
            </div>
          </div>
          <div id="tagSearchResults" class="mt-4">
            <!-- Search results will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Tag Counters -->
      <div id="tagCounters" class="mb-6 hidden">
        <h3 class="text-md font-medium text-teal-600 mb-3">üî¢ Reference Code Counters</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <button onclick="loadTagCounters()" class="btn-secondary mb-4 py-2 px-4 rounded-md">Refresh Counters</button>
          <div id="tagCountersContent" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <!-- Tag counters will be displayed here -->
          </div>
        </div>
      </div>

    </div>

    <!-- User & Role Manager Section -->
    <div id="user-manager" class="section hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4">User & Role Manager</h2>
          <div class="flex gap-4 mb-6">
        <button id="toggleUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">User</button>
        <button id="toggleRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Role</button>
        <button id="toggleEmployeeBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Employee</button>
          </div>
          <div id="user-manager-user-section">
                      <div class="flex gap-4 mb-6">
                <button id="addUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add User</button>
                <button id="addRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add Role</button>
              </div>
        
        <!-- User Table -->
        <div id="user-table-section">
            <div class="w-full overflow-x-auto">
              <table class="crm-table w-full mb-6 whitespace-nowrap">
                <thead>
                  <tr>
                    <th class="text-lg font-bold">Username</th>
                  <th class="text-lg font-bold">Email</th>
                    <th class="text-lg font-bold">Role</th>
                    <th class="text-lg font-bold">Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
          </div>
        </div>
        
        <!-- User Create Form -->
        <div id="user-create-form-section" class="hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left">Create New User</h2>
          
          <div class="w-full max-w-xl mx-auto">
            <form id="createUserForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
              <div class="sm:col-span-2">
                <label for="newUserUsername" class="block text-sm font-medium text-purple-700">Username</label>
                <input id="newUserUsername" name="username" type="text" required autocomplete="username" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newUserEmail" class="block text-sm font-medium text-purple-700">Email</label>
                <input id="newUserEmail" name="email" type="email" required autocomplete="email" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newUserPassword" class="block text-sm font-medium text-purple-700">Password</label>
                <input id="newUserPassword" name="password" type="password" required autocomplete="new-password" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2 flex flex-col">
                <label for="newUserRoles" class="block text-sm font-medium text-purple-700">Role</label>
                <select id="newUserRoles" name="roles" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full"></select>
              </div>
              <div class="col-span-full flex justify-end gap-2">
                <button type="button" id="cancelCreateUserBtn" class="btn-secondary py-2 px-6 rounded-md">Cancel</button>
                <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create User</button>
              </div>
            </form>
          </div>
            </div>
          </div>
          <div id="user-manager-role-section" class="hidden">
        <div class="w-full max-w-xl mx-auto mb-6 hidden" id="role-create-form-container">
              <form id="createRoleForm" class="grid grid-cols-1 gap-4 bg-white p-8 rounded-lg shadow">
                <div>
                  <label for="newRoleName" class="block text-sm font-medium text-purple-700">Role Name</label>
                  <input id="newRoleName" name="roleName" type="text" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
                </div>
            <div>
              <label for="newRoleDescription" class="block text-sm font-medium text-purple-700">Description</label>
              <textarea id="newRoleDescription" name="roleDescription" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" rows="3" placeholder="Describe what this role can do..."></textarea>
                </div>
            <div>
              <label class="block text-sm font-medium text-purple-700 mb-3">Permissions</label>
              <div class="grid grid-cols-1 gap-3">
                <div class="flex items-center">
                  <input type="checkbox" id="perm_create_campaigns" name="permissions" value="create_campaigns" class="mr-3">
                  <label for="perm_create_campaigns" class="text-sm">Create Campaigns</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_edit_campaigns" name="permissions" value="edit_campaigns" class="mr-3">
                  <label for="perm_edit_campaigns" class="text-sm">Edit Campaigns</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_delete_campaigns" name="permissions" value="delete_campaigns" class="mr-3">
                  <label for="perm_delete_campaigns" class="text-sm">Delete Campaigns</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_campaigns" name="permissions" value="view_campaigns" class="mr-3" checked>
                  <label for="perm_view_campaigns" class="text-sm">View Campaigns</label>
        </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_reports" name="permissions" value="view_reports" class="mr-3">
                  <label for="perm_view_reports" class="text-sm">View Reports</label>
      </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_export_data" name="permissions" value="export_data" class="mr-3">
                  <label for="perm_export_data" class="text-sm">Export Data</label>
    </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_users" name="permissions" value="manage_users" class="mr-3">
                  <label for="perm_manage_users" class="text-sm">Manage Users</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_roles" name="permissions" value="manage_roles" class="mr-3">
                  <label for="perm_manage_roles" class="text-sm">Manage Roles</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_channels" name="permissions" value="manage_channels" class="mr-3">
                  <label for="perm_manage_channels" class="text-sm">Manage Channels</label>
          </div>
              </div>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="backToRolesBtn" class="btn-secondary py-2 px-6 rounded-md">Back to Roles</button>
              <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create Role</button>
          </div>
        </form>
        </div>
        <div class="w-full max-w-xl mx-auto" id="roles-table-container">
          <div class="mb-3">
            <h3 class="text-lg font-semibold text-purple-700">Roles</h3>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role Name</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="roles-table-body">
                <!-- Roles will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Employee Manager Section -->
      <div id="user-manager-employee-section" class="hidden">
        <div class="flex gap-4 mb-6">
          <button id="addEmployeeBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add Employee</button>
    </div>

        <!-- Employee Table -->
        <div id="employee-table-section">
          <div class="w-full overflow-x-auto">
            <table class="crm-table w-full mb-6 whitespace-nowrap">
              <thead>
                <tr>
                  <th class="text-lg font-bold">Employee ID</th>
                  <th class="text-lg font-bold">Name</th>
                  <th class="text-lg font-bold">Email</th>
                  <th class="text-lg font-bold">Phone</th>
                  <th class="text-lg font-bold">Department</th>
                  <th class="text-lg font-bold">Position</th>
                  <th class="text-lg font-bold">Actions</th>
                </tr>
              </thead>
              <tbody id="employees-table-body">
                <!-- Employees will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Employee Create Form -->
        <div id="employee-create-form-section" class="hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left">Create New Employee</h2>
          
          <div class="w-full max-w-xl mx-auto">
            <form id="createEmployeeForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
              <div class="sm:col-span-2">
                <label for="newEmployeeName" class="block text-sm font-medium text-purple-700">Name</label>
                <input id="newEmployeeName" name="name" type="text" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newEmployeeEmail" class="block text-sm font-medium text-purple-700">Email</label>
                <input id="newEmployeeEmail" name="email" type="email" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newEmployeePhone" class="block text-sm font-medium text-purple-700">Phone</label>
                <input id="newEmployeePhone" name="phone" type="tel" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newEmployeeDepartment" class="block text-sm font-medium text-purple-700">Department</label>
                <input id="newEmployeeDepartment" name="department" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newEmployeePosition" class="block text-sm font-medium text-purple-700">Position</label>
                <input id="newEmployeePosition" name="position" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2 flex gap-2">
                <button type="button" onclick="hideEmployeeForm()" class="btn-secondary py-2 px-6 rounded-md flex-1">Cancel</button>
                <button type="submit" class="btn-primary py-2 px-6 rounded-md flex-1">Create Employee</button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- Employee Edit Form -->
        <div id="employee-edit-form-section" class="hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left">Edit Employee</h2>
          
          <div class="w-full max-w-xl mx-auto">
            <form id="editEmployeeForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
              <input type="hidden" id="editEmployeeId" name="employeeId">
              <div class="sm:col-span-2">
                <label for="editEmployeeName" class="block text-sm font-medium text-purple-700">Name</label>
                <input id="editEmployeeName" name="name" type="text" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="editEmployeeEmail" class="block text-sm font-medium text-purple-700">Email</label>
                <input id="editEmployeeEmail" name="email" type="email" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="editEmployeePhone" class="block text-sm font-medium text-purple-700">Phone</label>
                <input id="editEmployeePhone" name="phone" type="tel" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="editEmployeeDepartment" class="block text-sm font-medium text-purple-700">Department</label>
                <input id="editEmployeeDepartment" name="department" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="editEmployeePosition" class="block text-sm font-medium text-purple-700">Position</label>
                <input id="editEmployeePosition" name="position" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2 flex gap-2">
                <button type="button" onclick="hideEmployeeEditForm()" class="btn-secondary py-2 px-6 rounded-md flex-1">Cancel</button>
                <button type="submit" class="btn-primary py-2 px-6 rounded-md flex-1">Update Employee</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Channel Manager Section -->
    <div id="channel-manager" class="section hidden">
      <h2 class="text-3xl font-semibold text-purple-700 mb-4">Channel Manager</h2>
      
      <div class="flex gap-4 mb-6">
        <button id="addChannelBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add New</button>
        <button onclick="exportChannels()" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px] flex items-center">
          <span class="mr-2">üì•</span>
          <span>Export to Excel</span>
        </button>
        <button onclick="togglePriorityChannels()" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[200px] flex items-center">
          <span class="mr-2">‚≠ê</span>
          <span>Priority Channels</span>
        </button>
      </div>

      <!-- Channel Table -->
      <div id="channel-table-section">
        <div class="w-full overflow-x-auto">
          <table class="crm-table w-full mb-6 whitespace-nowrap">
            <thead>
              <tr>
                <th class="text-lg font-bold">Channel ID</th>
                <th class="text-lg font-bold">Channel Type</th>
                <th class="text-lg font-bold">Channel Tag</th>
                <th class="text-lg font-bold">Add Tag</th>
                <th class="text-lg font-bold">Mobile No</th>
                <th class="text-lg font-bold">Company Name</th>
                <th class="text-lg font-bold">Total Impressions</th>
                <th class="text-lg font-bold">Total Conversions</th>
                <th class="text-lg font-bold">Actions</th>
              </tr>
            </thead>
            <tbody id="channels-table-body">
              <!-- Channels will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Channel Create/Edit Form -->
      <div id="channel-form-section" class="hidden">
        <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left" id="channel-form-title">Create New Channel</h2>
        
        <div class="w-full max-w-2xl mx-auto">
          <form id="channelForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
            <div class="sm:col-span-2">
              <label for="channelId" class="block text-sm font-medium text-purple-700">Channel ID</label>
              <input id="channelId" type="text" readonly class="p-2 border rounded-md bg-gray-100 focus:outline-none w-full" placeholder="Auto-generated">
            </div>
            <div class="sm:col-span-2">
              <label for="channelType" class="block text-sm font-medium text-purple-700">Channel Type <span class="text-red-500">*</span></label>
              <select id="channelType" name="channel_type" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
                <option value="">Select Channel Type</option>
                <option value="Instagram">Instagram</option>
                <option value="Facebook">Facebook</option>
                <option value="TikTok">TikTok</option>
                <option value="YouTube">YouTube</option>
                <option value="Snapchat">Snapchat</option>
                <option value="Google">Google</option>
                <option value="Website">Website</option>
                <option value="SMS">SMS</option>
                <option value="Email">Email</option>
                <option value="Radio">Radio</option>
                <option value="Television">Television</option>
                <option value="WhatsApp Group">WhatsApp Group</option>
                <option value="Social organisations">Social organisations</option>
                <option value="Gold councils">Gold councils</option>
                <option value="Residential Community">Residential Community</option>
                <option value="Lang/Cultural group">Lang/Cultural group</option>
                <option value="Religious group">Religious group</option>
                <option value="Bluecollar Camp">Bluecollar Camp</option>
                <option value="Neighbourhood Community">Neighbourhood Community</option>
                <option value="Event">Event</option>
                <option value="Exhibition">Exhibition</option>
                <option value="Channel Partners">Channel Partners</option>
                <option value="Corporate Partners">Corporate Partners</option>
                <option value="Hotel">Hotel</option>
                <option value="Tour Driver">Tour Driver</option>
                <option value="Tours&Travel Agency">Tours&Travel Agency</option>
                <option value="New collection Launch">New collection Launch</option>
                <option value="Print Media">Print Media</option>
                <option value="Referral">Referral</option>
                <option value="Storefront">Storefront</option>
                <option value="Outdoor Ads">Outdoor Ads</option>
                <option value="Others">Others</option>
              </select>
            </div>
            <div>
              <label for="channelTag" class="block text-sm font-medium text-purple-700">Channel Tag</label>
              <input id="channelTag" name="channel_tag" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="Optional">
            </div>
            <div>
              <label for="addTag" class="block text-sm font-medium text-purple-700">Add Tag</label>
              <input id="addTag" name="add_tag" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="Optional">
            </div>
            <div>
              <label for="mobileNo" class="block text-sm font-medium text-purple-700">Mobile No</label>
              <input id="mobileNo" name="Mobile_no" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="Optional">
            </div>
            <div>
              <label for="totImpressions" class="block text-sm font-medium text-purple-700">Total Impressions</label>
              <input id="totImpressions" name="Tot_impressions" type="number" min="0" value="0" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
            </div>
            <div>
              <label for="totConversions" class="block text-sm font-medium text-purple-700">Total Conversions</label>
              <input id="totConversions" name="Tot_conversions" type="number" min="0" value="0" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
            </div>
            <div class="sm:col-span-2">
              <label for="companyName" class="block text-sm font-medium text-purple-700">Company Name</label>
              <input id="companyName" name="Company_name" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="Optional">
            </div>
            <div class="col-span-full flex justify-end gap-2">
              <button type="button" id="cancelChannelBtn" class="btn-secondary py-2 px-6 rounded-md">Cancel</button>
              <button type="submit" class="btn-primary py-2 px-6 rounded-md">Save Channel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Priority Channels Section -->
      <div id="priorityChannels" class="hidden mt-6">
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div id="priority-channels-content">
            <p class="text-gray-600">Loading priority channels data...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Campaign Section -->
    <div id="delete-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-red-700 mb-4">Delete</h2>
      <div class="space-y-6">
        <div id="deleteManualEntryContainer" class="flex gap-2 items-end hidden">
          <input id="deleteCampaignCodeInput" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter Marketing Code (e.g., MK_000001)">
          <button id="deleteManualBtn" class="btn-secondary py-2 px-4 rounded-md">Delete</button>
        </div>
        <div id="deleteResultMsg" class="hidden mt-4"></div>
      </div>
      <script>
        function setDeleteCampaignInputVisibility(visible) {
          const manualInput = document.getElementById('deleteManualEntryContainer');
          if (manualInput) {
            if (visible) {
              manualInput.classList.remove('hidden');
            } else {
              manualInput.classList.add('hidden');
            }
          }
        }
        function addDeleteCampaignMenuFunctionality() {
          const deleteMenuBtn = document.querySelector("button[onclick=\"showSection('delete-campaign')\"]");
          if (!deleteMenuBtn) { console.log('Delete menu button not found'); return; }
          deleteMenuBtn.addEventListener('click', function(event) {
            event.preventDefault();
            // Check if user has permission to delete campaigns
            if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
              alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
              return;
            }
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
            if (selectedRadio) {
              setDeleteCampaignInputVisibility(false);
              showSection('delete-campaign');
              // Auto-delete the selected campaign
              const campaignId = selectedRadio.value;
              const campaign = originalCampaigns.find(c => c._id === campaignId);
              if (campaign) {
                const confirmDelete = confirm(`Are you sure you want to delete the campaign "${campaign.campaignId}"?\n\nThis action cannot be undone.`);
                if (confirmDelete) {
                  deleteCampaignById(campaignId);
                }
              }
            } else {
              showSection('delete-campaign');
              setDeleteCampaignInputVisibility(true);
            }
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          // Ensure delete section is properly hidden on page load
          const deleteSection = document.getElementById('delete-campaign');
          if (deleteSection) {
            deleteSection.classList.add('hidden');
          }
          
          addDeleteCampaignMenuFunctionality();
          const deleteManualBtn = document.getElementById('deleteManualBtn');
          if (deleteManualBtn) {
            deleteManualBtn.addEventListener('click', async function() {
              // Check if user has permission to delete campaigns
              if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
                alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
                return;
              }
              
              const code = document.getElementById('deleteCampaignCodeInput').value.trim();
              const resultMsg = document.getElementById('deleteResultMsg');
              if (!code) {
                alert('Please enter a campaign code.');
                return;
              }
              const campaign = originalCampaigns.find(c => c.campaignId === code);
              if (!campaign) {
                alert('Campaign not found.');
                return;
              }
              // Confirm delete
              const confirmDelete = confirm(`Are you sure you want to delete the campaign "${campaign.campaignId}"?\n\nThis action cannot be undone.`);
              if (!confirmDelete) return;
              try {
                deleteManualBtn.textContent = 'Deleting...';
                deleteManualBtn.disabled = true;
                const response = await fetch(`/api/campaigns/${campaign._id}`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                  originalCampaigns = originalCampaigns.filter(c => c._id !== campaign._id);
                  
                  // Clear any radio selection
                  const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
                  if (selectedRadio) {
                    selectedRadio.checked = false;
                  }
                  
                  // Force table refresh with empty state handling
                  if (originalCampaigns.length === 0) {
                    const tableBody = document.getElementById('campaigns-table-body');
                    if (tableBody) {
                      tableBody.innerHTML = '<tr><td colspan="21" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
                    }
                  }
                  
                  // Refresh the table
                  displayCampaignsTable(originalCampaigns);
                  
                  // Update campaigns count
                  const campaignsCount = document.getElementById('campaigns-count');
                  if (campaignsCount) {
                    campaignsCount.textContent = originalCampaigns.length;
                  }
                  
                  // Clear the input field for next deletion
                  document.getElementById('deleteCampaignCodeInput').value = '';
                  
                  // Keep result message hidden (no need to show success message below input)
                  resultMsg.classList.add('hidden');
                  
                  console.log('Campaign deleted, campaigns remaining:', originalCampaigns.length);
                  alert('Campaign deleted successfully!');
                } else {
                  const error = await response.json();
                  resultMsg.textContent = `Failed to delete campaign: ${error.error || 'Unknown error'}`;
                  resultMsg.className = 'text-red-700 mt-4';
                  resultMsg.classList.remove('hidden');
                  alert(`Failed to delete campaign: ${error.error || 'Unknown error'}`);
                }
              } catch (error) {
                resultMsg.textContent = 'Failed to delete campaign. Please try again.';
                resultMsg.className = 'text-red-700 mt-4';
                resultMsg.classList.remove('hidden');
                alert('Failed to delete campaign. Please try again.');
              } finally {
                deleteManualBtn.textContent = 'Delete Campaign';
                deleteManualBtn.disabled = false;
              }
            });
          }
          // Don't show delete input by default - wait for user interaction
          setDeleteCampaignInputVisibility(false);
          document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'selected_campaign') {
              setDeleteCampaignInputVisibility(false);
            }
          });
        });
      </script>
    </div>
  </div>

  <script>
    function updateChannelFields(select) {
      const entry = select.closest('.channelEntry');
      const fieldsDiv = entry.querySelector('.channelFields');
      const type = select.value;

      // Clear existing fields
      fieldsDiv.innerHTML = '';

      // If no channel type selected, show message and disable all inputs
      if (!type) {
        fieldsDiv.innerHTML = `
          <div class="col-span-4 flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-md">
            <p class="text-gray-500 text-sm">Please select a channel type to configure fields</p>
          </div>
        `;
        return;
      }

      let html = '';
      if (type === 'Outdoor Events') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Venue</label>
            <input type="text" class="channelVenue p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Print Media') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Publication</label>
            <input type="text" class="channelPublication p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Newspaper Ad">Newspaper Ad</option>
              <option value="Magazine Article">Magazine Article</option>
              <option value="Flyer">Flyer</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Area</label>
            <input type="text" class="channelArea p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Television') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Commercial">Commercial</option>
              <option value="News Feature">News Feature</option>
              <option value="Interview">Interview</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Email') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Newsletter">Newsletter</option>
              <option value="Promotional Email">Promotional Email</option>
              <option value="Welcome Email">Welcome Email</option>
              <option value="Product launch">Product launch</option>
              <option value="Transactional mail">Transactional mail</option>
              <option value="Follow up email">Follow up email</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for Email
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (type === 'Message') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Radio') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Station</label>
            <input type="text" class="channelStation p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Festival Spot ad">Festival Spot ad</option>
              <option value="National hols spot ad">National hols spot ad</option>
              <option value="Shopping festival spot ad">Shopping festival spot ad</option>
              <option value="Summer Surprise spot ad">Summer Surprise spot ad</option>
              <option value="Paid interview">Paid interview</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Promotional Items') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Item Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Promotional Offer') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Offer Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'SMS') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Promotional SMS">Promotional SMS</option>
              <option value="Offer SMS">Offer SMS</option>
              <option value="Product launch">Product launch</option>
              <option value="Transactional SMS">Transactional SMS</option>
              <option value="Follow up SMS">Follow up SMS</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Outdoor Ads') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Billboard / Hoarding">Billboard / Hoarding</option>
              <option value="Metro/Bus Ad">Metro/Bus Ad</option>
              <option value="Roadside Pole Kiosk">Roadside Pole Kiosk</option>
              <option value="Billboard">Billboard</option>
              <option value="Metro Station Panel">Metro Station Panel</option>
              <option value="Bus Stop Poster">Bus Stop Poster</option>
              <option value="Pedestrian Bridge Banner">Pedestrian Bridge Banner</option>
              <option value="Lamp Post Ad">Lamp Post Ad</option>
              <option value="Roadside Banner">Roadside Banner</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Location</label>
            <input type="text" class="channelVenue p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Instagram') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" min="0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
              <option value="">Select Type *</option>
              <option value="Instagram Post">Instagram Post</option>
              <option value="Instagram Video">Instagram Video</option>
              <option value="Instagram Live Video">Instagram Live Video</option>
              <option value="Instagram Photo Ad">Instagram Photo Ad</option>
              <option value="Instagram Story Ad">Instagram Story Ad</option>
              <option value="Instagram Reel Ad">Instagram Reel Ad</option>
              <option value="Instagram Carousel Ad">Instagram Carousel Ad</option>
              <option value="Instagram Explore Page Ad">Instagram Explore Page Ad</option>
              <option value="Instagram Giveaway Contest">Instagram Giveaway Contest</option>
              <option value="Instagram Influencer Collaboration">Instagram Influencer Collaboration</option>
              <option value="Instagram Shop Product Tag">Instagram Shop Product Tag</option>
              <option value="Instagram Poll or Quiz Post">Instagram Poll or Quiz Post</option>
              <option value="Instagram Click-to-WhatsApp Ad">Instagram Click-to-WhatsApp Ad</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Facebook') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" min="0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
              <option value="">Select Type *</option>
              <option value="Facebook Post">Facebook Post</option>
              <option value="Facebook Video">Facebook Video</option>
              <option value="Facebook Live Video">Facebook Live Video</option>
              <option value="Facebook Feed Ad">Facebook Feed Ad</option>
              <option value="Facebook Story Ad">Facebook Story Ad</option>
              <option value="Facebook Video Ad">Facebook Video Ad</option>
              <option value="Facebook Carousel Ad">Facebook Carousel Ad</option>
              <option value="Facebook Collection Ad">Facebook Collection Ad</option>
              <option value="Facebook Lead Ad">Facebook Lead Ad</option>
              <option value="Facebook Event Ad">Facebook Event Ad</option>
              <option value="Facebook Page Like Ad">Facebook Page Like Ad</option>
              <option value="Facebook App Install Ad">Facebook App Install Ad</option>
              <option value="Facebook Messenger Ad">Facebook Messenger Ad</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'TikTok') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" min="0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
              <option value="">Select Type *</option>
              <option value="TikTok Post">TikTok Post</option>
              <option value="TikTok Video">TikTok Video</option>
              <option value="TikTok Live Video">TikTok Live Video</option>
              <option value="TikTok In-Feed Ad">TikTok In-Feed Ad</option>
              <option value="TikTok TopView Ad">TikTok TopView Ad</option>
              <option value="TikTok Branded Hashtag Challenge">TikTok Branded Hashtag Challenge</option>
              <option value="TikTok Branded Effect">TikTok Branded Effect</option>
              <option value="TikTok Collection Ad">TikTok Collection Ad</option>
              <option value="TikTok Dynamic Showcase Ad">TikTok Dynamic Showcase Ad</option>
              <option value="TikTok Spark Ad">TikTok Spark Ad</option>
              <option value="TikTok Video Shopping Ad">TikTok Video Shopping Ad</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Google') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" min="0" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Google Search Ad">Google Search Ad</option>
              <option value="Google Display Ad">Google Display Ad</option>
              <option value="Google Shopping Ad">Google Shopping Ad</option>
              <option value="Google Video Ad">Google Video Ad</option>
              <option value="Google App Ad">Google App Ad</option>
              <option value="Google Local Ad">Google Local Ad</option>
              <option value="Google Smart Display Ad">Google Smart Display Ad</option>
              <option value="Google Responsive Search Ad">Google Responsive Search Ad</option>
              <option value="Google Performance Max">Google Performance Max</option>
              <option value="SEO optimization">SEO optimization</option>
              <option value="Google Maps / Business optimization">Google Maps / Business optimization</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Storefront') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Exterior Brand Signage">Exterior Brand Signage</option>
              <option value="Showcase Window Display">Showcase Window Display</option>
              <option value="In-Store Digital Signage">In-Store Digital Signage</option>
              <option value="Seasonal & Festive Decor">Seasonal & Festive Decor</option>
              <option value="Promotional Posters Display">Promotional Posters Display</option>
              <option value="Promotional Hangers">Promotional Hangers</option>
              <option value="Footpath Carpet">Footpath Carpet</option>
              <option value="Store Entrance Arch">Store Entrance Arch</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for Storefront
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (type === 'YouTube') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="YouTube Video">YouTube Video</option>
              <option value="YouTube Short">YouTube Short</option>
              <option value="YouTube Channel Page">YouTube Channel Page</option>
              <option value="YouTube Live">YouTube Live</option>
              <option value="YouTube Ad">YouTube Ad</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for YouTube
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (type === 'WhatsApp Group') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Insta Reel Link Post">Insta Reel Link Post</option>
              <option value="Promotional Post">Promotional Post</option>
              <option value="Festive Wishes Post">Festive Wishes Post</option>
              <option value="Product Launch Post">Product Launch Post</option>
              <option value="Group Admin Post">Group Admin Post</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for WhatsApp Group
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (type === 'Gold councils') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Seasonal/Festive Promotions">Seasonal/Festive Promotions</option>
              <option value="Training & Certification">Training & Certification</option>
              <option value="Gold & Diamond Exhibitions">Gold & Diamond Exhibitions</option>
              <option value="WhatsApp Discussion">WhatsApp Discussion</option>
              <option value="Monthly Meeting / Networking">Monthly Meeting / Networking</option>
              <option value="Direct Referral (Member)">Direct Referral (Member)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for Gold councils
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                const tagNumberInput = entry.querySelector('.channelTagNumber');
                const channelTagInput = entry.querySelector('.channelTag');
                const channelTypeSelect = entry.querySelector('.channelType');
                
                // Skip platform select, channel type select, channel tag input, and tag number input
                if (input !== platformSelect && input !== channelTypeSelect && input !== channelTagInput && input !== tagNumberInput) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (['Residential Community', 'Lang/Cultural group', 'Religious group', 'Bluecollar Camp', 'Neighbourhood Community', 'Social organisations'].includes(type)) {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stall/ Kiosk">
                <span class="text-sm">Stall/ Kiosk</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Event Sponsorship">
                <span class="text-sm">Event Sponsorship</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Flyer Handout">
                <span class="text-sm">Flyer Handout</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Event Arch">
                <span class="text-sm">Event Arch</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Discount Voucher">
                <span class="text-sm">Discount Voucher</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Lucky Draw">
                <span class="text-sm">Lucky Draw</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Raffle Ticket">
                <span class="text-sm">Raffle Ticket</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Social Follow & Win">
                <span class="text-sm">Social Follow & Win</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stage Branding">
                <span class="text-sm">Stage Branding</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Standee">
                <span class="text-sm">Standee</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Exhibition') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Exhibition Booth Purchase">
                <span class="text-sm">Exhibition Booth Purchase</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Flyer Handout">
                <span class="text-sm">Flyer Handout</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Exhibition Arch">
                <span class="text-sm">Exhibition Arch</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Discount/Gift Voucher">
                <span class="text-sm">Discount/Gift Voucher</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Lucky Draw">
                <span class="text-sm">Lucky Draw</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Raffle Ticket">
                <span class="text-sm">Raffle Ticket</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Social Follow & Win">
                <span class="text-sm">Social Follow & Win</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stage Branding">
                <span class="text-sm">Stage Branding</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Attendies Bag Insert">
                <span class="text-sm">Attendies Bag Insert</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Speaking Slot">
                <span class="text-sm">Speaking Slot</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Standee">
                <span class="text-sm">Standee</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Event') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stall/ Kiosk">
                <span class="text-sm">Stall/ Kiosk</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Event Sponsorship">
                <span class="text-sm">Event Sponsorship</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Flyer Handout">
                <span class="text-sm">Flyer Handout</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Event Arch">
                <span class="text-sm">Event Arch</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Discount/Gift Voucher">
                <span class="text-sm">Discount/Gift Voucher</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Lucky Draw">
                <span class="text-sm">Lucky Draw</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Raffle Ticket">
                <span class="text-sm">Raffle Ticket</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Social Follow & Win">
                <span class="text-sm">Social Follow & Win</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stage Branding">
                <span class="text-sm">Stage Branding</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Standee">
                <span class="text-sm">Standee</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'New collection Launch') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Invitation Card">
                <span class="text-sm">Invitation Card</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Flyer Handout">
                <span class="text-sm">Flyer Handout</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Stage Presentation">
                <span class="text-sm">Stage Presentation</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Discount/Gift Voucher">
                <span class="text-sm">Discount/Gift Voucher</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="PR Release">
                <span class="text-sm">PR Release</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Launch Event">
                <span class="text-sm">Launch Event</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Launch Social Post">
                <span class="text-sm">Launch Social Post</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Launch Email">
                <span class="text-sm">Launch Email</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Launch WhatsApp Blast">
                <span class="text-sm">Launch WhatsApp Blast</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Channel Partners') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="B2B Referral">
                <span class="text-sm">B2B Referral</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Shared Promotion">
                <span class="text-sm">Shared Promotion</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Cross promo Collateral">
                <span class="text-sm">Cross promo Collateral</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Corporate Partners') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="HR Announcement">
                <span class="text-sm">HR Announcement</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="HR Email">
                <span class="text-sm">HR Email</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Hotel') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Concierge Recommendation">
                <span class="text-sm">Concierge Recommendation</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Reception Recommendation">
                <span class="text-sm">Reception Recommendation</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Lobby Banner/standee">
                <span class="text-sm">Lobby Banner/standee</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Hotel Staff Referral">
                <span class="text-sm">Hotel Staff Referral</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Room Key Card Ad">
                <span class="text-sm">Room Key Card Ad</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Tour Driver') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Driver Verbal Referral">
                <span class="text-sm">Driver Verbal Referral</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Commission Card">
                <span class="text-sm">Commission Card</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Driver WhatsApp Group">
                <span class="text-sm">Driver WhatsApp Group</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Driver Agency">
                <span class="text-sm">Driver Agency</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Company Brochure/Card">
                <span class="text-sm">Company Brochure/Card</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Tours&Travel Agency') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Booking Voucher">
                <span class="text-sm">Booking Voucher</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Itinerary Inclusion">
                <span class="text-sm">Itinerary Inclusion</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Tour Operator Referral">
                <span class="text-sm">Tour Operator Referral</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Tour Company Brochure">
                <span class="text-sm">Tour Company Brochure</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Company Brochure">
                <span class="text-sm">Company Brochure</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Tour Desk Display">
                <span class="text-sm">Tour Desk Display</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Travel Guide Referral">
                <span class="text-sm">Travel Guide Referral</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Referral') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Verbal Referral">
                <span class="text-sm">Verbal Referral</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Accompanied Visit">
                <span class="text-sm">Accompanied Visit</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Business Card">
                <span class="text-sm">Business Card</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Commission Card">
                <span class="text-sm">Commission Card</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="WhatsApp Group">
                <span class="text-sm">WhatsApp Group</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Company">
                <span class="text-sm">Company</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="TG Company Brochure/Card/coupon">
                <span class="text-sm">TG Company Brochure/Card/coupon</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add checkbox validation for Referral
        setTimeout(() => {
          const checkboxes = entry.querySelectorAll('.channelTypeCheckbox');
          const allInputs = entry.querySelectorAll('input, select');
          const tagNumberInput = entry.querySelector('.channelTagNumber');
          const channelTagInput = entry.querySelector('.channelTag');
          const channelTypeSelect = entry.querySelector('.channelType');
          
          function updateFieldStates() {
            const hasSelection = Array.from(checkboxes).some(cb => cb.checked);
            const checkboxArray = Array.from(checkboxes);
            
            allInputs.forEach(input => {
              // Skip checkboxes, channel type select, channel tag input, and tag number input
              const isCheckbox = checkboxArray.includes(input);
              if (!isCheckbox && input !== channelTypeSelect && input !== channelTagInput && input !== tagNumberInput) {
                input.disabled = !hasSelection;
                if (!hasSelection) {
                  input.value = '';
                  input.classList.add('bg-gray-100');
                } else {
                  input.classList.remove('bg-gray-100');
                }
              }
            });
            
            // Auto-generate tag when at least one type is selected
            if (hasSelection && !entry.hasAttribute('data-populating')) {
              const tempButton = document.createElement('button');
              tempButton.style.display = 'none';
              entry.appendChild(tempButton);
              generateTagNumber(tempButton);
              entry.removeChild(tempButton);
            }
          }
          
          checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateFieldStates);
          });
          
          // Initial state check
          updateFieldStates();
        }, 100);
      } else if (type === 'Website') {
        html = `
          <div class="col-span-4">
            <label class="block text-sm font-medium text-purple-700 mb-2">Types (Select Multiple)</label>
            <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-md bg-gray-50">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Direct Visit (Typed URL)">
                <span class="text-sm">Direct Visit (Typed URL)</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Blog Article">
                <span class="text-sm">Blog Article</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Chatbot / Web Widget">
                <span class="text-sm">Chatbot / Web Widget</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Website Landing Page">
                <span class="text-sm">Website Landing Page</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Contact Form">
                <span class="text-sm">Contact Form</span>
              </label>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" class="channelTypeCheckbox" value="Offer Page">
                <span class="text-sm">Offer Page</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Snapchat') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Type</option>
              <option value="Snap Ad">Snap Ad</option>
              <option value="Story">Story</option>
              <option value="Spotlight">Spotlight</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Others') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Reference Code</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      }

      // Insert new fields
      fieldsDiv.innerHTML = html;
      
      // Add platform validation for Referral (after HTML is inserted)
      if (type === 'Referral') {
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                const tagNumberInput = entry.querySelector('.channelTagNumber');
                const channelTypeSelect = entry.querySelector('.channelType');
                
                // Skip platform select, channel type select, and tag number input
                if (input !== platformSelect && input !== channelTypeSelect && input !== tagNumberInput) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
          // Create a temporary button element to pass the correct entry reference
          const tempButton = document.createElement('button');
          tempButton.style.display = 'none';
          entry.appendChild(tempButton);
          generateTagNumber(tempButton);
          entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      }
      
      // Add platform validation for Outdoor Ads (after HTML is inserted)
      if (type === 'Outdoor Ads') {
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                const tagNumberInput = entry.querySelector('.channelTagNumber');
                const channelTypeSelect = entry.querySelector('.channelType');
                
                // Skip platform select, channel type select, and tag number input
                if (input !== platformSelect && input !== channelTypeSelect && input !== tagNumberInput) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected && !platformSelect.hasAttribute('data-populating')) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      }
      
      // Auto-generate tag for channel types that don't require platform selection
      // BUT ONLY if no tag number already exists (to preserve existing tags during edit)
      if (type && type !== 'Storefront' && type !== 'Email' && type !== 'YouTube' && type !== 'WhatsApp Group' && type !== 'Gold councils' && type !== 'Outdoor Ads') {
        setTimeout(() => {
          // Check if tag number already exists or is being populated - if so, don't generate a new one
          const tagNumberInput = entry.querySelector('.channelTagNumber');
          if (tagNumberInput) {
            // Check if tag already has a value
            if (tagNumberInput.value && tagNumberInput.value.trim() !== '') {
              console.log('Tag number already exists, skipping auto-generation:', tagNumberInput.value);
              return; // Don't generate if tag already exists
            }
            // Check if we're currently populating (during edit)
            if (tagNumberInput.hasAttribute('data-populating')) {
              console.log('Tag number is being populated, skipping auto-generation');
              return; // Don't generate if we're populating
            }
          }
          
          // Verify the channelType is still set before generating tag
          const channelTypeSelect = entry.querySelector('.channelType');
          if (channelTypeSelect && channelTypeSelect.value === type) {
            // Create a temporary button element to pass the correct entry reference
            const tempButton = document.createElement('button');
            tempButton.style.display = 'none';
            entry.appendChild(tempButton);
            generateTagNumber(tempButton);
            entry.removeChild(tempButton);
          } else {
            console.warn('Channel type mismatch or not set. Expected:', type, 'Found:', channelTypeSelect?.value);
          }
        }, 150);
      }
      // Set initial placeholder for tag input
      setTimeout(() => {
        const tagInput = entry.querySelector('.channelTagNumber');
        if (tagInput) {
          tagInput.placeholder = 'Auto-generated';
        }
      }, 0);

      // Populate channel tags based on selected channel type
      if (type && type.trim() !== '') {
        setTimeout(() => {
          populateChannelTagList(type, entry);
        }, 200);
      }

      // Remove button is handled in the main channel entry structure
      // No need to create additional remove buttons here
    }

    // Function to fetch and populate channel tags datalist (defined globally)
    // channelType: optional - if provided, filters tags by channel type
    window.populateChannelTagList = async function populateChannelTagList(channelType = null, entryElement = null) {
      try {
        // Build URL with optional channel_type query parameter
        let url = '/api/channels/tags';
        if (channelType && channelType.trim() !== '') {
          url += `?channel_type=${encodeURIComponent(channelType.trim())}`;
        }
        
        const response = await fetch(url);
        
        // Handle 404 or other errors gracefully
        if (!response.ok) {
          if (response.status === 404) {
            console.warn('Channel tags endpoint not found. Make sure the server is restarted.');
            return; // Silently fail - users can still type custom tags
          }
          throw new Error('Failed to fetch channel tags');
        }
        
        const data = await response.json();
        
        // If entryElement is provided, find datalist within that entry, otherwise use global one
        let datalist;
        if (entryElement) {
          const tagInput = entryElement.querySelector('.channelTag');
          if (tagInput && tagInput.list) {
            datalist = tagInput.list;
          } else {
            // Create datalist if it doesn't exist for this entry
            const datalistId = `channelTagList_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const newDatalist = document.createElement('datalist');
            newDatalist.id = datalistId;
            tagInput.setAttribute('list', datalistId);
            entryElement.appendChild(newDatalist);
            datalist = newDatalist;
          }
        } else {
          datalist = document.getElementById('channelTagList');
        }
        
        if (!datalist) return;
        
        // Clear existing options
        datalist.innerHTML = '';
        
        // Add options from database (if any)
        if (data.tags && Array.isArray(data.tags)) {
          data.tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            datalist.appendChild(option);
          });
        }
      } catch (error) {
        // Silently handle errors - users can still type custom tags
        // Only log if it's not a network error (which is expected if server isn't running)
        if (error.message !== 'Failed to fetch') {
          console.warn('Error loading channel tags:', error.message);
        }
      }
    };

    function addChannelEntry() {
      const container = document.getElementById('channelContainer');
      const entry = document.createElement('div');
      entry.className = 'channelEntry grid grid-cols-8 gap-2 items-end mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50';
      entry.innerHTML = `
        <div class="col-span-1">
          <label class="block text-sm font-medium text-purple-700">Channel Type</label>
          <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
            <option value="">Select Channel</option>
            <option value="Instagram">Instagram</option>
            <option value="Facebook">Facebook</option>
            <option value="TikTok">TikTok</option>
            <option value="YouTube">YouTube</option>
            <option value="Snapchat">Snapchat</option>
            <option value="Google">Google</option>
            <option value="Website">Website</option>
            <option value="SMS">SMS</option>
            <option value="Email">Email</option>
            <option value="Radio">Radio</option>
            <option value="Television">Television</option>
            <option value="WhatsApp Group">WhatsApp Group</option>
            <option value="Social organisations">Social organisations</option>
            <option value="Gold councils">Gold councils</option>
            <option value="Residential Community">Residential Community</option>
            <option value="Lang/Cultural group">Lang/Cultural group</option>
            <option value="Religious group">Religious group</option>
            <option value="Bluecollar Camp">Bluecollar Camp</option>
            <option value="Neighbourhood Community">Neighbourhood Community</option>
            <option value="Event">Event</option>
            <option value="Exhibition">Exhibition</option>
            <option value="Channel Partners">Channel Partners</option>
            <option value="Corporate Partners">Corporate Partners</option>
            <option value="Hotel">Hotel</option>
            <option value="Tour Driver">Tour Driver</option>
            <option value="Tours&Travel Agency">Tours&Travel Agency</option>
            <option value="New collection Launch">New collection Launch</option>
            <option value="Print Media">Print Media</option>
            <option value="Referral">Referral</option>
            <option value="Storefront">Storefront</option>
            <option value="Outdoor Ads">Outdoor Ads</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-medium text-purple-700">Channel Tag</label>
          <input 
            type="text" 
            class="channelTag p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" 
            list="channelTagList" 
            placeholder="Optional - Select or type"
            autocomplete="off"
          >
        </div>
        <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
                    <div class="col-span-1 flex items-center justify-start">
              <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
                Remove
              </button>
            </div>
      `;
      container.appendChild(entry);
      // Populate datalist for this new entry (without filtering by type initially)
      populateChannelTagList(null, entry);
    }

    function removeChannelEntry(button) {
      const entry = button.closest('.channelEntry');
      if (entry) entry.remove();
      // If no channel entries left, add a new one
      const container = document.getElementById('channelContainer');
      if (container.children.length === 0) {
        addChannelEntry();
      }
    }

    async function submitCampaign() {
      console.log('Submit button clicked - starting validation...');
      
      // Validate Status (mandatory)
      const status = document.getElementById('status').value;
      if (!status || status.trim() === '') {
        alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this campaign.');
        return;
      }
      
      // Validate Gender (mandatory)
      const gender = document.getElementById('targetGender').value;
      if (!gender || gender.trim() === '') {
        alert('‚ö†Ô∏è Warning: Gender is mandatory. Please select a gender for this campaign.');
        return;
      }
      
      // Validate Work Start Date (mandatory only when status is "Planned")
      const workStartDate = document.getElementById('workStartDate').value;
      if (status === 'Planned' && (!workStartDate || workStartDate.trim() === '')) {
        alert('‚ö†Ô∏è Warning: Work Start Date is mandatory when status is "Planned". Please select a date when the team started working on this campaign.');
        return;
      }
      
      // Validate Type selection for Instagram, Facebook, TikTok, and Google platforms
      const channelEntries = document.querySelectorAll('.channelEntry');
      console.log('Found channel entries:', channelEntries.length);
      
      for (const entry of channelEntries) {
        const type = entry.querySelector('.channelType').value;
        console.log('Channel type:', type);
        
        if (type === 'Instagram' || type === 'Facebook' || type === 'TikTok') {
          const adType = entry.querySelector('.channelAdType')?.value;
          if (!adType || adType.trim() === '') {
            alert(`‚ö†Ô∏è Warning: Please select a Type for ${type}. Type selection is mandatory.`);
            return;
          }
        }
      }
      
      const channels = Array.from(channelEntries).map(entry => {
        const type = entry.querySelector('.channelType').value;
        if (type === 'Television') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            adType: entry.querySelector('.channelAdType')?.value || '',
            startDate: entry.querySelector('.channelStartDate')?.value,
            endDate: entry.querySelector('.channelEndDate')?.value,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Radio') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            station: entry.querySelector('.channelStation')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            adType: entry.querySelector('.channelAdType')?.value || '',
            startDate: entry.querySelector('.channelStartDate')?.value,
            endDate: entry.querySelector('.channelEndDate')?.value,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Print Media') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            publication: entry.querySelector('.channelPublication').value,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            adType: entry.querySelector('.channelAdType')?.value || '',
            startDate: entry.querySelector('.channelStartDate').value,
            endDate: entry.querySelector('.channelEndDate').value,
            area: entry.querySelector('.channelArea').value,
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Storefront') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'SMS') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            adType: entry.querySelector('.channelAdType')?.value || '',
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'YouTube') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'WhatsApp Group') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Email') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Message') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Outdoor Ads') {
          // Outdoor Ads uses dropdown (platform) instead of simple fields
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            venue: entry.querySelector('.channelVenue')?.value || '',
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Outdoor Events') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            venue: entry.querySelector('.channelVenue').value,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Promotional Items') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Promotional Offer') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Instagram' || type === 'Facebook' || type === 'TikTok' || type === 'Google' || type === 'Snapchat') {
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            adType: entry.querySelector('.channelAdType')?.value || '',
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Gold councils') {
          // Gold councils uses dropdown (platform) instead of checkboxes
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            platform: entry.querySelector('.channelPlatform')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Referral') {
          // Referral uses checkboxes (types) instead of dropdown
          const checkedTypes = Array.from(entry.querySelectorAll('.channelTypeCheckbox:checked')).map(cb => cb.value);
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            types: checkedTypes,
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Referral') {
          // Referral uses checkboxes (types) instead of dropdown
          const checkedTypes = Array.from(entry.querySelectorAll('.channelTypeCheckbox:checked')).map(cb => cb.value);
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            types: checkedTypes,
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Event' || type === 'Exhibition' || type === 'New collection Launch' || type === 'Channel Partners' || type === 'Corporate Partners' || type === 'Hotel' || type === 'Tour Driver' || type === 'Tours&Travel Agency' || type === 'Website' || ['Residential Community', 'Lang/Cultural group', 'Religious group', 'Bluecollar Camp', 'Neighbourhood Community', 'Social organisations'].includes(type)) {
          // Collect checked types as array
          const checkedTypes = Array.from(entry.querySelectorAll('.channelTypeCheckbox:checked')).map(cb => cb.value);
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
            types: checkedTypes, // Array of selected types
          };
        } else {
          // Generic handler for all other channel types
          return {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost')?.value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
            // Include optional fields that might exist
            venue: entry.querySelector('.channelVenue')?.value || '',
            qty: parseInt(entry.querySelector('.channelQty')?.value) || 0,
          };
        }
      }).filter(channel => channel);

      const campaignData = {
        // campaignId will be assigned by the backend persistent counter
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        workStartDate: document.getElementById('workStartDate').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        budget: parseFloat(document.getElementById('budget').value) || 0,
        status: document.getElementById('status').value,
        jobAssignedTo: document.getElementById('jobAssignedTo').value,
        targetAudience: {
          age: document.getElementById('targetAge').value,
          gender: document.getElementById('targetGender').value
        },
        goals: {
          sales: parseFloat(document.getElementById('goalSales').value) || 0,
          impressions: parseFloat(document.getElementById('goalImpressions').value) || 0,
          conversions: parseFloat(document.getElementById('goalConversions').value) || 0,
        },
        achieved: {
          sales: parseFloat(document.getElementById('achievedSales').value) || 0,
          impressions: parseFloat(document.getElementById('achievedImpressions').value) || 0,
          conversions: parseFloat(document.getElementById('achievedConversions').value) || 0,
        },
        channels,
      };
      
      console.log('=== FINAL CAMPAIGN DATA BEFORE SUBMISSION ===');
      console.log('Campaign data:', JSON.stringify(campaignData, null, 2));
      console.log('Channels with impressions:', channels.map(ch => ({ type: ch.type, platform: ch.platform, impressions: ch.impressions })));

      try {
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('campaignData', JSON.stringify(campaignData));
        
        // Add all image files
        const imageInputs = document.querySelectorAll('.image-upload-input');
        console.log('=== IMAGE UPLOAD DEBUG ===');
        console.log('Total image inputs found:', imageInputs.length);
        
        let imageCount = 0;
        imageInputs.forEach((input, index) => {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            console.log(`Image ${index}: ${file.name} (${file.size} bytes, ${file.type})`);
            formData.append(`campaignImage${index}`, file);
            imageCount++;
          } else {
            console.log(`Image input ${index}: No file selected`);
          }
        });
        
        console.log(`Total images to upload: ${imageCount}`);
        console.log('=== SENDING REQUEST TO SERVER ===');
        console.log('FormData entries:');
        for (let pair of formData.entries()) {
          if (pair[1] instanceof File) {
            console.log(`  ${pair[0]}: File(${pair[1].name}, ${pair[1].size} bytes, ${pair[1].type})`);
          } else {
            console.log(`  ${pair[0]}: ${typeof pair[1] === 'string' ? pair[1].substring(0, 100) + '...' : pair[1]}`);
          }
        }
        
        const response = await fetch('/api/campaigns', {
          method: 'POST',
          body: formData, // Don't set Content-Type header, let browser set it for FormData
        });
        
        console.log('=== SERVER RESPONSE ===');
        console.log('Status:', response.status);
        console.log('Status Text:', response.statusText);
        
        const result = await response.json();
        console.log('Response data:', result);
        
        if (response.ok) {
          // Display the campaignId assigned by the backend
          document.getElementById('campaignId').value = result.campaignId;
          console.log('‚úì Campaign created successfully with ID:', result.campaignId);
          alert(result.message);
          clearForm();
        } else {
          console.error('‚úó Server error:', result.error);
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('‚úó Request failed:', err);
        alert('Error: ' + err.message);
      }
    }

    // Function to load employees for job assignment dropdown
    async function loadUsersForJobAssignment() {
      try {
        const response = await fetch('/api/employees');
        if (response.ok) {
          const employees = await response.json();
          const jobAssignedToSelect = document.getElementById('jobAssignedTo');
          if (jobAssignedToSelect) {
            // Clear existing options except the first one
            jobAssignedToSelect.innerHTML = '<option value="">Select Employee</option>';
            
            // Add all employees sorted by name
            employees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            employees.forEach(employee => {
              if (employee.name) {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = employee.name;
                jobAssignedToSelect.appendChild(option);
              }
            });
          }
        } else {
          console.error('Failed to load employees:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading employees:', error);
      }
    }

    // Function to get existing job assignments from campaigns
    async function getExistingJobAssignments() {
      try {
        const response = await fetch('/api/campaigns');
        if (response.ok) {
          const campaigns = await response.json();
          const assignments = new Set();
          campaigns.forEach(campaign => {
            if (campaign.jobAssignedTo && campaign.jobAssignedTo.trim() !== '') {
              assignments.add(campaign.jobAssignedTo);
            }
          });
          return Array.from(assignments);
        }
        return [];
      } catch (error) {
        console.error('Error fetching existing job assignments:', error);
        return [];
      }
    }

    // Function to refresh job assignment dropdowns (call this when users are added/updated)
    // Note: Not called when users are deleted to preserve existing job assignments
    function refreshJobAssignmentDropdowns() {
      // Refresh dropdown in new campaign form
      const newCampaignSelect = document.getElementById('jobAssignedTo');
      if (newCampaignSelect) {
        loadUsersForJobAssignment();
      }
      
      // Refresh dropdown in edit form if it exists
      const editForm = document.getElementById('editCampaignForm');
      if (editForm) {
        const editSelect = editForm.querySelector('#jobAssignedTo');
        if (editSelect) {
          // Get current assigned user from the dropdown value
          const currentAssignedUser = editSelect.value || null;
          loadUsersForJobAssignmentInForm(editForm, currentAssignedUser);
        }
      }
      
      // Refresh filter dropdown in campaigns table
      loadUsersForJobAssignmentFilter();
    }

    // Make refresh function globally available
    window.refreshJobAssignmentDropdowns = refreshJobAssignmentDropdowns;
    
    // Make loadUsersForJobAssignment globally available for testing
    window.loadUsersForJobAssignment = loadUsersForJobAssignment;

    // Function to load employees for job assignment dropdown in a specific form
    async function loadUsersForJobAssignmentInForm(formContainer, currentAssignedEmployee = null) {
      try {
        const response = await fetch('/api/employees');
        if (response.ok) {
          const employees = await response.json();
          const jobAssignedToSelect = formContainer.querySelector('#jobAssignedTo');
          if (jobAssignedToSelect) {
            // Clear existing options except the first one
            jobAssignedToSelect.innerHTML = '<option value="">Select Employee</option>';
            
            // Add all employees sorted by name
            employees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            employees.forEach(employee => {
              if (employee.name) {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = employee.name;
                jobAssignedToSelect.appendChild(option);
              }
            });
            
            // Special case: If the campaign being edited has an employee assigned that no longer exists,
            // add that specific employee to the dropdown so the current assignment is preserved
            if (currentAssignedEmployee) {
              const isActiveEmployee = employees.find(emp => emp.name === currentAssignedEmployee);
              if (!isActiveEmployee && currentAssignedEmployee) {
                const option = document.createElement('option');
                option.value = currentAssignedEmployee;
                option.textContent = currentAssignedEmployee + ' (Inactive)';
                option.style.color = '#6B7280';
                jobAssignedToSelect.appendChild(option);
              }
            }
          }
        } else {
          console.error('Failed to load employees for edit form:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading employees for edit form:', error);
      }
    }

    // Function to load employees for job assignment filter dropdown
    async function loadUsersForJobAssignmentFilter() {
      try {
        const response = await fetch('/api/employees');
        if (response.ok) {
          const employees = await response.json();
          const filterSelect = document.getElementById('filter-job-assigned-to');
          if (filterSelect) {
            // Clear existing options except the first one
            filterSelect.innerHTML = '<option value="">All Job Assigned To</option>';
            
            // Get existing job assignments to include deleted employees
            const existingAssignments = await getExistingJobAssignments();
            
            // Add all employees sorted by name
            employees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            employees.forEach(employee => {
              if (employee.name) {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = employee.name;
                filterSelect.appendChild(option);
              }
            });
            
            // Add previously assigned employees who might have been deleted
            existingAssignments.forEach(employeeName => {
              if (employeeName) {
                const isActiveEmployee = employees.find(emp => emp.name === employeeName);
                if (!isActiveEmployee) {
                  // Employee was deleted but has existing assignments - show as inactive
                  const option = document.createElement('option');
                  option.value = employeeName;
                  option.textContent = employeeName + ' (Inactive)';
                  option.style.color = '#6B7280';
                  filterSelect.appendChild(option);
                }
              }
            });
          }
        } else {
          console.error('Failed to load employees for filter:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading employees for filter:', error);
      }
    }

    function clearForm() {
      // Clear basic fields
      document.getElementById('name').value = '';
      document.getElementById('description').value = '';
      document.getElementById('workStartDate').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('budget').value = '';
      document.getElementById('status').value = '';
      document.getElementById('jobAssignedTo').value = '';
      
      // Clear all image fields
      document.querySelectorAll('.image-upload-input').forEach(input => {
        input.value = '';
      });
      document.querySelectorAll('.image-preview').forEach(preview => {
        preview.classList.add('hidden');
        preview.querySelector('img').src = '';
      });
      
      // Reset image counter and remove extra image items
      imageCounter = 1;
      const imageContainer = document.getElementById('imageUploadContainer');
      const imageItems = imageContainer.querySelectorAll('.image-upload-item');
      for (let i = 1; i < imageItems.length; i++) {
        imageItems[i].remove();
      }
      
      // Clear campaignId field - it will be assigned by backend
      document.getElementById('campaignId').value = '';

      // Clear target audience
      document.getElementById('targetAge').value = '';
      document.getElementById('targetGender').value = '';

      // Clear goals
      document.getElementById('goalSales').value = '';
      document.getElementById('goalImpressions').value = '';
      document.getElementById('goalConversions').value = '';

      // Clear achieved
      document.getElementById('achievedSales').value = '';
      document.getElementById('achievedImpressions').value = '';
      document.getElementById('achievedConversions').value = '';

      // Clear channels
      const channelContainer = document.getElementById('channelContainer');
      channelContainer.innerHTML = '';
      addChannelEntry(); // Add one empty channel entry
    }

    // Function to query selected campaign (new radio-based approach)
    window.querySelectedCampaign = async function(campaignId) {
      console.log('querySelectedCampaign function called');
      let idToUse = campaignId;
      if (!idToUse) {
      const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
      if (!selectedRadio) {
        console.log('No campaign selected');
        alert('Please select a campaign from the Campaigns Table first.');
        // Reset the indicator
        const indicator = document.getElementById('campaign-selected-indicator');
        const instructions = document.getElementById('query-instructions');
        if (indicator && instructions) {
          indicator.classList.add('hidden');
          instructions.classList.remove('hidden');
        }
        return;
      }
        idToUse = selectedRadio.value;
      }
      const queryCampaignForm = document.getElementById('queryCampaignForm');
      if (!queryCampaignForm) {
        console.error('queryCampaignForm element not found');
        return;
      }
      // Check if originalCampaigns is available
      if (!originalCampaigns || !Array.isArray(originalCampaigns)) {
        console.error('originalCampaigns is not available or not an array');
        console.log('originalCampaigns:', originalCampaigns);
        return;
      }
      console.log('originalCampaigns length:', originalCampaigns.length);
      console.log('Looking for campaign with ID:', idToUse);
      // Find the campaign in original data
      const campaign = originalCampaigns.find(c => c._id === idToUse);
      if (!campaign) {
        console.log('Campaign not found in original data');
        console.log('Available campaign IDs:', originalCampaigns.map(c => c._id));
        return;
      }
      console.log('Found campaign:', campaign);
      try {
        // Use the campaign data directly instead of making an API call
        const result = campaign;
        // Show the queryCampaignForm div
        queryCampaignForm.classList.remove('hidden');
        // Show the Download as Excel button
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.remove('hidden');
        // Create plain text description layout
        let formHTML = `
          <div class="space-y-4">
            <!-- Marketing ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Marketing ID</label>
                <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Name</label>
                <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
              </div>
            </div>
            <!-- Description -->
            <div>
              <label class="block text-sm font-medium text-purple-700">Description</label>
              <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
            </div>
            <!-- Work Start Date, Start Date and End Date -->
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Work Start Date</label>
                <p class="text-base text-gray-900">${result.workStartDate ? formatDateDDMMYY(result.workStartDate) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Start Date</label>
                <p class="text-base text-gray-900">${result.startDate ? formatDateDDMMYY(result.startDate) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">End Date</label>
                <p class="text-base text-gray-900">${result.endDate ? formatDateDDMMYY(result.endDate) : 'N/A'}</p>
              </div>
            </div>
            <!-- Budget and Status -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Budget (AED)</label>
                <p class="text-base text-gray-900">${result.budget ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.budget) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Status</label>
                <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
              </div>
            </div>
            <!-- Target Audience -->
            ${result.targetAudience ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Target Audience</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-purple-700">Age</label>
                  <p class="text-base text-gray-900">${result.targetAudience.age || 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Gender</label>
                  <p class="text-base text-gray-900">${result.targetAudience.gender || 'N/A'}</p>
                </div>
              </div>
            </div>` : ''}
            <!-- Goals -->
            ${result.goals ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Goals</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-purple-700">Sales (AED)</label>
                  <p class="text-base text-gray-900">${result.goals.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.goals.sales) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Impressions</label>
                  <p class="text-base text-gray-900">${result.goals.impressions ? new Intl.NumberFormat().format(result.goals.impressions) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Conversions</label>
                  <p class="text-base text-gray-900">${result.goals.conversions ? new Intl.NumberFormat().format(result.goals.conversions) : 'N/A'}</p>
                </div>
              </div>
            </div>` : ''}

            <!-- Achieved -->
            ${result.achieved ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-green-600 mb-2">üéØ Achieved</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-green-700">Sales (AED)</label>
                  <p class="text-base text-green-900">${result.achieved.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.achieved.sales) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-green-700">Impressions</label>
                  <p class="text-base text-green-900">${result.achieved.impressions ? new Intl.NumberFormat().format(result.achieved.impressions) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-green-700">Conversions</label>
                  <p class="text-base text-green-900">${result.achieved.conversions ? new Intl.NumberFormat().format(result.achieved.conversions) : 'N/A'}</p>
                </div>
              </div>
            </div>` : ''}
            
            <!-- Channels -->
            ${result.channels && result.channels.length > 0 ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Channels</h3>
              <div class="space-y-6">
                ${result.channels.map((channel, index) => {
                  // Determine label based on channel type
                  const nameLabelTypes = ['Instagram', 'Facebook', 'TikTok', 'YouTube', 'Snapchat', 'Google', 'WhatsApp Group', 'Outdoor Ads', 'Promotional Items', 'Promotional Offer'];
                  const labelText = nameLabelTypes.includes(channel.type) ? 'Name' : 'Description';
                  
                  // Build fields array for proper layout
                  const fields = [];
                  
                  // Always show Name/Description first
                  if (channel.adName) {
                    fields.push({ label: labelText, value: channel.adName, span: 1 });
                  }
                  
                  // Platform (for Social Media, Email, etc.)
                  if (channel.platform) {
                    fields.push({ label: 'Platform', value: channel.platform, span: 1 });
                  }
                  
                  // Publication (for Print Media)
                  if (channel.publication) {
                    fields.push({ label: 'Publication', value: channel.publication, span: 1 });
                  }
                  
                  // Station (for Radio)
                  if (channel.station) {
                    fields.push({ label: 'Station', value: channel.station, span: 1 });
                  }
                  
                  // Cost
                  if (channel.cost !== undefined && channel.cost !== null) {
                    fields.push({ label: 'Cost', value: channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A', span: 1 });
                  }
                  
                  // Ad Type
                  if (channel.adType) {
                    fields.push({ label: 'Type', value: channel.adType, span: 1 });
                  }
                  
                  // Types (multi-select types)
                  if (channel.types && Array.isArray(channel.types) && channel.types.length > 0) {
                    fields.push({ label: 'Types', value: channel.types.join(', '), span: 4 });
                  }
                  
                  // Venue/Location
                  if (channel.venue) {
                    fields.push({ label: 'Venue', value: channel.venue, span: 1 });
                  }
                  
                  // Area
                  if (channel.area) {
                    fields.push({ label: 'Area', value: channel.area, span: 1 });
                  }
                  
                  // Quantity
                  if (channel.qty !== undefined && channel.qty !== null) {
                    fields.push({ label: 'Quantity', value: channel.qty, span: 1 });
                  }
                  
                  // Start Date
                  if (channel.startDate) {
                    fields.push({ label: 'Start Date', value: formatDateDDMMYY(channel.startDate), span: 1 });
                  }
                  
                  // End Date
                  if (channel.endDate) {
                    fields.push({ label: 'End Date', value: formatDateDDMMYY(channel.endDate), span: 1 });
                  }
                  
                  // Impressions
                  if (channel.impressions !== undefined && channel.impressions !== null) {
                    fields.push({ label: 'Impressions', value: new Intl.NumberFormat().format(channel.impressions), span: 1 });
                  }
                  
                  // Conversions
                  if (channel.conversions !== undefined && channel.conversions !== null) {
                    fields.push({ label: 'Conversions', value: new Intl.NumberFormat().format(channel.conversions), span: 1 });
                  }
                  
                  // Reference Code
                  if (channel.tagNumber) {
                    fields.push({ label: 'Reference Code', value: channel.tagNumber, span: 1, isCode: true });
                  }
                  
                  // Channel Tag
                  if (channel.channelTag) {
                    fields.push({ label: 'Channel Tag', value: channel.channelTag, span: 1 });
                  }
                  
                  // Render fields in rows
                  let fieldsHTML = '';
                  let currentRow = [];
                  let currentRowSpan = 0;
                  
                  fields.forEach((field, idx) => {
                    if (field.span === 4 || currentRowSpan + field.span > 4) {
                      // Start new row
                      if (currentRow.length > 0) {
                        fieldsHTML += `<div class="grid grid-cols-4 gap-2 mb-2">${currentRow.join('')}</div>`;
                      }
                      currentRow = [];
                      currentRowSpan = 0;
                    }
                    
                    const fieldHTML = `
                      <div class="${field.span === 4 ? 'col-span-4' : ''}">
                        <label class="block text-sm font-medium text-purple-700">${field.label}</label>
                        <p class="text-base text-gray-900 ${field.isCode ? 'font-mono bg-yellow-100 px-2 py-1 rounded inline-block' : ''}">${field.value}</p>
                    </div>
                    `;
                    currentRow.push(fieldHTML);
                    currentRowSpan += field.span;
                  });
                  
                  // Add remaining fields in current row
                  if (currentRow.length > 0) {
                    fieldsHTML += `<div class="grid grid-cols-4 gap-2 mb-2">${currentRow.join('')}</div>`;
                  }
                  
                  return `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-purple-700 mb-1">Channel Type</label>
                        <p class="text-base font-semibold text-gray-900">${channel.type || 'N/A'}</p>
                      </div>
                      ${fieldsHTML}
                      </div>
                  `;
                }).join('')}
              </div>
                      </div>` : ''}
            
            <!-- Campaign Images -->
            ${result.images && Array.isArray(result.images) && result.images.length > 0 ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-4">Campaign Images</h3>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                ${result.images.map((imagePath, index) => {
                  if (!imagePath || imagePath.trim() === '') return '';
                  const cleanPath = imagePath.trim();
                  return `
                    <div class="relative group">
                      <img src="${cleanPath}" 
                           alt="Campaign Image ${index + 1}" 
                           class="w-full h-48 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity"
                           onclick="window.open('${cleanPath}', '_blank')"
                           onerror="console.error('Failed to load image:', '${cleanPath}'); this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                      <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                        ${index + 1} / ${result.images.length}
                    </div>
                      <div class="absolute top-2 right-2 bg-blue-500 bg-opacity-75 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
                           onclick="window.open('${cleanPath}', '_blank'); event.stopPropagation();"
                           title="Click to view full size">
                        View
                  </div>
              </div>
                  `;
                }).filter(html => html !== '').join('')}
              </div>
              <p class="text-xs text-gray-500 mt-2">Click on any image to view it in full size</p>
            </div>` : result.images && typeof result.images === 'string' && result.images.trim() !== '' ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-4">Campaign Images</h3>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div class="relative group">
                  <img src="${result.images.trim()}" 
                       alt="Campaign Image" 
                       class="w-full h-48 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity"
                       onclick="window.open('${result.images.trim()}', '_blank')"
                       onerror="console.error('Failed to load image:', '${result.images.trim()}'); this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                  <div class="absolute top-2 right-2 bg-blue-500 bg-opacity-75 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
                       onclick="window.open('${result.images.trim()}', '_blank'); event.stopPropagation();"
                       title="Click to view full size">
                    View
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-2">Click on the image to view it in full size</p>
            </div>` : ''}
          </div>`;
        queryCampaignForm.innerHTML = formHTML;
        console.log('Query successful, form displayed.');
      } catch (err) {
        if (queryCampaignForm) {
          queryCampaignForm.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">Error: ${err.message}</p>
            </div>`;
          queryCampaignForm.classList.remove('hidden');
        }
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
      console.log('querySelectedCampaign function finished.');
    }

    // Debug function to check selected campaign
    window.checkSelectedCampaign = function() {
      console.log('=== DEBUG: Checking Selected Campaign ===');
      const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
      console.log('Selected radio:', selectedRadio);
      
      if (selectedRadio) {
        console.log('Selected campaign ID:', selectedRadio.value);
        console.log('originalCampaigns available:', !!originalCampaigns);
        console.log('originalCampaigns length:', originalCampaigns ? originalCampaigns.length : 'N/A');
        
        if (originalCampaigns) {
          const campaign = originalCampaigns.find(c => c._id === selectedRadio.value);
          console.log('Found campaign in data:', !!campaign);
          if (campaign) {
            console.log('Campaign name:', campaign.name);
            console.log('Campaign ID:', campaign.campaignId);
          }
        }
      } else {
        console.log('No campaign selected');
      }
      
      console.log('querySelectedCampaign function exists:', typeof window.querySelectedCampaign);
      console.log('=== END DEBUG ===');
    };

    // Keep the old function for backward compatibility (but it's no longer used)
    async function queryCampaign() {
      
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        
        if (response.ok) {
          // Show the queryResult div
          queryResult.classList.remove('hidden');
          // Show the Download as Excel button
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.remove('hidden');
          let formattedResult = `
            <div class="space-y-6">
              <!-- Basic Information -->
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Campaign Information</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Campaign ID</p>
                    <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Name</p>
                    <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Status</p>
                    <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Job Assigned To</p>
                    <p class="text-base text-gray-900">${result.jobAssignedTo || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Budget</p>
                    <p class="text-base text-gray-900">${result.budget ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.budget) : 'N/A'}</p>
                  </div>
                </div>
                <div class="mt-3">
                  <p class="text-sm font-medium text-gray-600">Offers</p>
                  <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-3">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Work Start Date</p>
                    <p class="text-base text-gray-900">${result.workStartDate ? formatDateDDMMYY(result.workStartDate) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Start Date</p>
                    <p class="text-base text-gray-900">${result.startDate ? formatDateDDMMYY(result.startDate) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">End Date</p>
                    <p class="text-base text-gray-900">${result.endDate ? formatDateDDMMYY(result.endDate) : 'N/A'}</p>
                  </div>
                </div>
              </div>

              <!-- Target Audience -->
              ${result.targetAudience ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Target Audience</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Age</p>
                    <p class="text-base text-gray-900">${result.targetAudience.age || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Gender</p>
                    <p class="text-base text-gray-900">${result.targetAudience.gender || 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Goals -->
              ${result.goals ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Campaign Goals</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Sales Target</p>
                    <p class="text-base text-gray-900">${result.goals.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.goals.sales) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Target Impressions</p>
                    <p class="text-base text-gray-900">${result.goals.impressions ? new Intl.NumberFormat().format(result.goals.impressions) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Target Conversions</p>
                    <p class="text-base text-gray-900">${result.goals.conversions ? new Intl.NumberFormat().format(result.goals.conversions) : 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Achieved -->
              ${result.achieved ? `
              <div class="bg-white p-4 rounded-lg border border-green-200">
                <h4 class="text-lg font-semibold text-green-700 mb-3">üéØ Campaign Achievements</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Sales Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.achieved.sales) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Impressions Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.impressions ? new Intl.NumberFormat().format(result.achieved.impressions) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Conversions Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.conversions ? new Intl.NumberFormat().format(result.achieved.conversions) : 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Channels -->
              ${result.channels && result.channels.length > 0 ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Marketing Channels</h4>
                <div class="space-y-4">
                  ${result.channels.map((channel, index) => `
                    <div class="${index > 0 ? 'border-t pt-4' : ''}">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <p class="text-sm font-medium text-gray-600">Channel Type</p>
                          <p class="text-base text-gray-900">${channel.type || 'N/A'}</p>
                        </div>
                        <div>
                          <p class="text-sm font-medium text-gray-600">${['Instagram', 'Facebook', 'TikTok', 'YouTube', 'Snapchat', 'Google', 'WhatsApp Group'].includes(channel.type) ? 'Name' : 'Description'}</p>
                          <p class="text-base text-gray-900">${channel.adName || 'N/A'}</p>
                        </div>
                        ${channel.platform ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Platform</p>
                          <p class="text-base text-gray-900">${channel.platform}</p>
                        </div>` : ''}
                        ${channel.publication ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Publication</p>
                          <p class="text-base text-gray-900">${channel.publication}</p>
                        </div>` : ''}
                        <div>
                          <p class="text-sm font-medium text-gray-600">Cost</p>
                          <p class="text-base text-gray-900">${channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A'}</p>
                        </div>
                        ${channel.adType ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Type</p>
                          <p class="text-base text-gray-900">${channel.adType}</p>
                        </div>` : ''}
                        ${channel.qty ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Quantity</p>
                          <p class="text-base text-gray-900">${channel.qty}</p>
                        </div>` : ''}
                        ${channel.impressions ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Impressions</p>
                          <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.impressions)}</p>
                        </div>` : ''}
                        ${channel.conversions ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Conversions</p>
                          <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.conversions)}</p>
                        </div>` : ''}
                        ${channel.tagNumber ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Reference Code</p>
                          <p class="text-base text-gray-900 font-mono bg-yellow-100 px-2 py-1 rounded">${channel.tagNumber}</p>
                        </div>` : ''}
                        ${channel.startDate ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Start Date</p>
                          <p class="text-base text-gray-900">${formatDateDDMMYY(channel.startDate)}</p>
                        </div>` : ''}
                        ${channel.endDate ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">End Date</p>
                          <p class="text-base text-gray-900">${formatDateDDMMYY(channel.endDate)}</p>
                        </div>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>` : ''}
            </div>`;

          queryResult.innerHTML = formattedResult;
          queryResult.classList.remove('hidden');
          console.log('Query successful, result displayed.');
        } else {
          queryResult.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">${result.error}</p>
            </div>`;
          queryResult.classList.remove('hidden');
          console.warn('Query failed, displaying error:', result.error);
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.add('hidden');
        }
      } catch (err) {
        queryResult.innerHTML = `
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <p class="text-red-700">Error: ${err.message}</p>
          </div>`;
        queryResult.classList.remove('hidden');
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
        console.log('queryCampaign function finished.');
    }

    function exportCampaigns() {
      console.log('exportCampaigns function called');
      window.location.href = '/api/campaigns/export';
       console.log('exportCampaigns function finished.');
    }

    // Export the currently queried campaign to Excel
    function exportQueriedCampaign() {
      console.log('exportQueriedCampaign function called');
      
      // Get the campaign ID from the query form or selected radio
      let campaignId = null;
      
      // First, try to get from query form (most reliable - it's what's displayed)
      const queryForm = document.getElementById('queryCampaignForm');
      if (queryForm && !queryForm.classList.contains('hidden')) {
        // Look for the Marketing ID label and its value
        const formLabels = queryForm.querySelectorAll('label');
        formLabels.forEach(label => {
          if (label.textContent.includes('Marketing ID')) {
            const nextElement = label.nextElementSibling;
            if (nextElement && nextElement.tagName === 'P') {
              const idValue = nextElement.textContent.trim();
              if (idValue && idValue !== 'N/A') {
                campaignId = idValue;
              }
            }
          }
        });
      }
      
      // If not found, try to get from selected radio button
      if (!campaignId) {
        const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
        if (selectedRadio) {
          // Find the campaign in originalCampaigns to get the campaignId (human-readable ID)
          const campaign = originalCampaigns.find(c => {
            const cId = c._id ? (typeof c._id === 'string' ? c._id : c._id.toString()) : null;
            return cId === selectedRadio.value || c._id === selectedRadio.value;
          });
          if (campaign && campaign.campaignId) {
            campaignId = campaign.campaignId;
          }
        }
      }
      
      // If still not found, try manual input
      if (!campaignId) {
        const manualInput = document.getElementById('queryCampaignCodeInput');
        if (manualInput && manualInput.value) {
          campaignId = manualInput.value.trim();
        }
      }
      
      if (campaignId && campaignId !== 'N/A') {
        console.log('Exporting campaign:', campaignId);
        window.location.href = `/api/campaigns/${campaignId}/export`;
      } else {
        console.warn('No campaign ID found, exporting all campaigns instead');
        alert('No specific campaign found. Exporting all campaigns instead.');
        window.location.href = '/api/campaigns/export';
      }
      
      console.log('exportQueriedCampaign function finished.');
    }

    // Export channels to Excel
    function exportChannels() {
      console.log('exportChannels function called');
      window.location.href = '/api/channels/export';
      console.log('exportChannels function finished.');
    }

    // Campaign ID will be assigned by the backend persistent counter
    // No need to pre-generate IDs on the frontend


    // Helper to show/hide edit campaign input section
    function setEditCampaignInputVisibility(visible) {
      const editInputSection = document.querySelector('#edit-campaign > .space-y-6 > .mb-6');
      if (editInputSection) {
        if (visible) {
          editInputSection.classList.remove('hidden');
        } else {
          editInputSection.classList.add('hidden');
        }
      }
      // Also hide the edit form if not visible
      const editForm = document.getElementById('editCampaignForm');
      if (!visible && editForm) {
        editForm.classList.remove('hidden');
      }
    }

    // Update addEditCampaignMenuFunctionality to handle both entry points
    function addEditCampaignMenuFunctionality() {
      const editMenuBtn = document.querySelector("button[onclick=\"showSection('edit-campaign')\"]");
      if (!editMenuBtn) { console.log('Edit menu button not found'); return; }
      editMenuBtn.addEventListener('click', async function(event) {
        event.preventDefault();
        // Find selected campaign
        const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
        console.log('Edit menu clicked. Selected radio:', selectedRadio);
        if (selectedRadio) {
          // Edit via radio selection: hide input, show form
          const selectedCampaignId = selectedRadio.value;
          console.log('Selected campaign ID:', selectedCampaignId);
          const campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
          console.log('Found campaign:', campaign);
          if (campaign) {
            const editInput = document.getElementById('editCampaignId');
            if (editInput) editInput.value = campaign.campaignId;
            showSection('edit-campaign');
            setEditCampaignInputVisibility(false);
            await loadCampaignForEditDirect(campaign);
            // Ensure the edit form is visible
            const editForm = document.getElementById('editCampaignForm');
            if (editForm) editForm.classList.remove('hidden');
            console.log('Edit form should now be visible.');
          } else {
            console.log('Campaign not found in originalCampaigns.');
          }
        } else {
          // Edit via menu: show input, hide form
          showSection('edit-campaign');
          setEditCampaignInputVisibility(true);
          const editForm = document.getElementById('editCampaignForm');
          if (editForm) editForm.classList.add('hidden');
          console.log('No campaign selected, showing input.');
        }
      });
    }

    // Update loadCampaignForEdit to prevent empty input
    async function loadCampaignForEdit() {
      const campaignId = document.getElementById('editCampaignId').value.trim();
      if (!campaignId) {
        alert('Please enter a Campaign ID.');
        return;
      }
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        if (response.ok) {
          setEditCampaignInputVisibility(false);
          await loadCampaignForEditDirect(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function loadCampaignForEditDirect(campaign) {
      // Clone the new campaign form
      const newCampaignFormTemplate = document.querySelector('#new-campaign .space-y-6');
      const editFormContainer = document.getElementById('editCampaignForm');
      
      // Clear previous content
      editFormContainer.innerHTML = '';

      // Create a new form element and append cloned children
      const editForm = document.createElement('div');
      editForm.className = newCampaignFormTemplate.className; // Copy classes
      
      Array.from(newCampaignFormTemplate.children).forEach(child => {
          editForm.appendChild(child.cloneNode(true));
      });
      
      // Load users for job assignment dropdown AFTER cloning
      await loadUsersForJobAssignmentInForm(editForm, campaign.jobAssignedTo);

      // Add hidden input for MongoDB _id
      const hiddenIdInput = document.createElement('input');
      hiddenIdInput.type = 'hidden';
      hiddenIdInput.id = 'editCampaignMongoId';
      hiddenIdInput.value = campaign._id;
      editForm.appendChild(hiddenIdInput);

      // Clear initial channel entries from cloned template
      const channelContainerInClonedForm = editForm.querySelector('#channelContainer');
      if (channelContainerInClonedForm) {
          channelContainerInClonedForm.innerHTML = '';
      }
      
      // Fill in the form with campaign data
      fillFormWithCampaignData(editForm, campaign);

      // Add one empty channel entry if campaign had none
      if (!campaign.channels || campaign.channels.length === 0) {
          addChannelEntryInEditForm(editForm);
      }

      // Modify the submit button to handle updates
      const submitButton = editForm.querySelector('button[onclick="submitCampaign()"]');
      if (submitButton) {
         submitButton.onclick = () => submitCampaignUpdate();
         submitButton.textContent = 'Update Marketing record';
      }
      
      // Show the form
      editFormContainer.appendChild(editForm);
      editFormContainer.classList.remove('hidden');

      // Re-attach event listeners for channel fields in the loaded form
      editForm.querySelectorAll('.channelType').forEach(select => {
          select.onchange = () => updateChannelFields(select);
      });

       // Re-attach event listener for add channel button
       const addChannelButton = editForm.querySelector('button[onclick="addChannelEntry()"]');
        if(addChannelButton) {
            addChannelButton.onclick = () => addChannelEntryInEditForm(editForm);
        }
        
    }

    // A variation of addChannelEntry for the edit form to ensure correct scoping
    function addChannelEntryInEditForm(editFormElement) {
        const container = editFormElement.querySelector('#channelContainer');
        if (!container) return null;

        const entry = document.createElement('div');
        entry.className = 'channelEntry grid grid-cols-8 gap-2 items-end mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50';
        entry.innerHTML = `
          <div class="col-span-1">
            <label class="block text-sm font-medium text-purple-700">Channel Type</label>
            <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
              <option value="">Select Channel</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="TikTok">TikTok</option>
              <option value="YouTube">YouTube</option>
              <option value="Snapchat">Snapchat</option>
              <option value="Google">Google</option>
              <option value="Website">Website</option>
              <option value="SMS">SMS</option>
              <option value="Email">Email</option>
              <option value="Radio">Radio</option>
              <option value="Television">Television</option>
              <option value="WhatsApp Group">WhatsApp Group</option>
              <option value="Social organisations">Social organisations</option>
              <option value="Gold councils">Gold councils</option>
              <option value="Residential Community">Residential Community</option>
              <option value="Lang/Cultural group">Lang/Cultural group</option>
              <option value="Religious group">Religious group</option>
              <option value="Bluecollar Camp">Bluecollar Camp</option>
              <option value="Neighbourhood Community">Neighbourhood Community</option>
              <option value="Event">Event</option>
              <option value="Exhibition">Exhibition</option>
              <option value="Channel Partners">Channel Partners</option>
              <option value="Corporate Partners">Corporate Partners</option>
              <option value="Hotel">Hotel</option>
              <option value="Tour Driver">Tour Driver</option>
              <option value="Tours&Travel Agency">Tours&Travel Agency</option>
              <option value="New collection Launch">New collection Launch</option>
              <option value="Print Media">Print Media</option>
              <option value="Referral">Referral</option>
              <option value="Storefront">Storefront</option>
              <option value="Outdoor Ads">Outdoor Ads</option>
              <option value="Others">Others</option>
            </select>
          </div>
          <div class="col-span-1">
            <label class="block text-sm font-medium text-purple-700">Channel Tag</label>
          <input 
            type="text" 
            class="channelTag p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" 
            list="channelTagList" 
            placeholder="Optional - Select or type"
            autocomplete="off"
          >
          </div>
          <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
          <div class="col-span-1 flex items-center justify-start">
            <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
              Remove
            </button>
          </div>
        `;
         // Re-attach updateChannelFields listener to the new select
         const newSelect = entry.querySelector('.channelType');
         if(newSelect) newSelect.onchange = () => updateChannelFields(newSelect);
         // Populate datalist for this new entry (without filtering by type initially)
         populateChannelTagList(null, entry);

         // Re-attach removeChannelEntry listener to the new remove button if it exists
         const removeBtn = entry.querySelector('.btn-secondary');
         if (removeBtn) {
             removeBtn.onclick = function() { removeChannelEntry(removeBtn); };
         }

        // Append the entry to the container
        container.appendChild(entry);

        return entry;
    }

    async function submitCampaignUpdate() {
      try {
        // Get the edit form
        const editForm = document.getElementById('editCampaignForm');
        
        // Validate category selection
        const editCategorySelects = editForm.querySelectorAll('.targetCategory');
        // All dropdowns must be selected (not empty)
        const allCategoriesSelected = Array.from(editCategorySelects).every(select => select.value && select.value.trim() !== '');
        if (!allCategoriesSelected) {
          alert('‚ö†Ô∏è Warning: Please select a category for every row before updating the campaign.');
          return;
        }
        
        // Validate Status (mandatory)
        const status = editForm.querySelector('#status')?.value;
        if (!status || status.trim() === '') {
          alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this campaign.');
          return;
        }
        
        // Validate Gender (mandatory)
        const gender = editForm.querySelector('#targetGender')?.value;
        if (!gender || gender.trim() === '') {
          alert('‚ö†Ô∏è Warning: Gender is mandatory. Please select a gender for this campaign.');
          return;
        }
        
        // Validate Work Start Date (mandatory only when status is "Planned")
        const workStartDate = editForm.querySelector('#workStartDate')?.value;
        if (status === 'Planned' && (!workStartDate || workStartDate.trim() === '')) {
          alert('‚ö†Ô∏è Warning: Work Start Date is mandatory when status is "Planned". Please select a date when the team started working on this campaign.');
          return;
        }
        
        if (!editForm) {
          throw new Error('Edit form not found');
        }

        // Get the MongoDB _id from the hidden input
        const mongoIdInput = editForm.querySelector('#editCampaignMongoId');
        if (!mongoIdInput || !mongoIdInput.value) {
          throw new Error('Campaign ID for update not found');
        }
        const campaignId = mongoIdInput.value;

        // Get all form fields
        const formData = {
          campaignId: editForm.querySelector('#campaignId')?.value || '',
          name: editForm.querySelector('#name')?.value || '',
          description: editForm.querySelector('#description')?.value || '',
          workStartDate: editForm.querySelector('#workStartDate')?.value || '',
          startDate: editForm.querySelector('#startDate')?.value || '',
          endDate: editForm.querySelector('#endDate')?.value || '',
          budget: parseFloat(editForm.querySelector('#budget')?.value) || 0,
          status: editForm.querySelector('#status')?.value || 'Active',
          jobAssignedTo: editForm.querySelector('#jobAssignedTo')?.value || '',
          targetAudience: {
            age: editForm.querySelector('#targetAge')?.value || '',
            gender: editForm.querySelector('#targetGender')?.value
          },
          goals: {
            sales: parseFloat(editForm.querySelector('#goalSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#goalImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#goalConversions')?.value) || 0,
          },
          achieved: {
            sales: parseFloat(editForm.querySelector('#achievedSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#achievedImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#achievedConversions')?.value) || 0,
          },
          channels: []
        };

        // Get channel data
        const channelEntries = editForm.querySelectorAll('.channelEntry');
        channelEntries.forEach(entry => {
          const type = entry.querySelector('.channelType').value;
          if (!type) return;

          const channelData = {
            type,
            channelTag: entry.querySelector('.channelTag')?.value || '',
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0
          };

          if (type === 'Television') {
            channelData.startDate = entry.querySelector('.channelStartDate')?.value || '';
            channelData.endDate = entry.querySelector('.channelEndDate')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Radio') {
            channelData.station = entry.querySelector('.channelStation')?.value || '';
            channelData.adType = entry.querySelector('.channelAdType')?.value || '';
            channelData.startDate = entry.querySelector('.channelStartDate')?.value || '';
            channelData.endDate = entry.querySelector('.channelEndDate')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Print Media') {
            channelData.publication = entry.querySelector('.channelPublication')?.value || '';
            channelData.adType = entry.querySelector('.channelAdType')?.value || '';
            channelData.startDate = entry.querySelector('.channelStartDate')?.value || '';
            channelData.endDate = entry.querySelector('.channelEndDate')?.value || '';
            channelData.area = entry.querySelector('.channelArea')?.value || '';
            channelData.qty = parseInt(entry.querySelector('.channelQty').value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Storefront') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'SMS') {
            channelData.adType = entry.querySelector('.channelAdType')?.value || '';
            channelData.qty = parseInt(entry.querySelector('.channelQty')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'YouTube') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'WhatsApp Group') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Email') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.qty = parseInt(entry.querySelector('.channelQty')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Message') {
            channelData.qty = parseInt(entry.querySelector('.channelQty')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Gold councils') {
            // Gold councils uses dropdown (platform) instead of checkboxes
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Referral') {
            // Referral uses checkboxes (types) instead of dropdown
            const checkedTypes = Array.from(entry.querySelectorAll('.channelTypeCheckbox:checked')).map(cb => cb.value);
            channelData.types = checkedTypes;
            channelData.adName = entry.querySelector('.channelAdName')?.value || '';
            channelData.cost = parseFloat(entry.querySelector('.channelCost')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Outdoor Ads') {
            // Outdoor Ads uses dropdown (platform) instead of simple fields
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.venue = entry.querySelector('.channelVenue')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Event' || type === 'Exhibition' || type === 'New collection Launch' || type === 'Channel Partners' || type === 'Corporate Partners' || type === 'Hotel' || type === 'Tour Driver' || type === 'Tours&Travel Agency' || type === 'Website' || ['Residential Community', 'Lang/Cultural group', 'Religious group', 'Bluecollar Camp', 'Neighbourhood Community', 'Social organisations'].includes(type)) {
            // Collect checked types as array
            const checkedTypes = Array.from(entry.querySelectorAll('.channelTypeCheckbox:checked')).map(cb => cb.value);
            channelData.types = checkedTypes;
            channelData.adName = entry.querySelector('.channelAdName')?.value || '';
            channelData.cost = parseFloat(entry.querySelector('.channelCost')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Outdoor Events') {
            channelData.venue = entry.querySelector('.channelVenue')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Promotional Items') {
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Promotional Offer') {
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Instagram' || type === 'Facebook' || type === 'TikTok' || type === 'Google' || type === 'Snapchat') {
            channelData.adType = entry.querySelector('.channelAdType')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else {
            // Generic handler for all other channel types
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
            // Include optional fields
            channelData.venue = entry.querySelector('.channelVenue')?.value || '';
            channelData.qty = parseInt(entry.querySelector('.channelQty')?.value) || 0;
          }
          formData.channels.push(channelData);
        });

        // Collect images to remove (marked for removal)
        const imagesToRemove = [];
        const existingImageItems = editForm.querySelectorAll('.existing-image-item');
        console.log('=== COLLECTING IMAGES TO REMOVE ===');
        console.log('Total existing image items found:', existingImageItems.length);
        
        existingImageItems.forEach((item, index) => {
          const markedForRemoval = item.dataset.markedForRemoval;
          const imagePath = item.dataset.imagePath;
          console.log(`Item ${index + 1}:`, {
            imagePath: imagePath,
            markedForRemoval: markedForRemoval,
            willBeRemoved: markedForRemoval === 'true'
          });
          
          if (markedForRemoval === 'true') {
            if (imagePath) {
              imagesToRemove.push(imagePath);
              console.log(`  ‚úì Added to removal list: ${imagePath}`);
            } else {
              console.log(`  ‚ö† No imagePath found for item ${index + 1}`);
            }
          }
        });
        
        console.log('=== IMAGES TO REMOVE SUMMARY ===');
        console.log('Total images to remove:', imagesToRemove.length);
        console.log('Images marked for removal:', imagesToRemove);
        
        // Add imagesToRemove to formData
        formData.imagesToRemove = imagesToRemove;

        // Create FormData for file upload (same as create)
        const formDataWithFiles = new FormData();
        formDataWithFiles.append('campaignData', JSON.stringify(formData));
        
        // Add all image files from the edit form
        const imageInputs = editForm.querySelectorAll('.image-upload-input');
        console.log('=== EDIT FORM IMAGE UPLOAD DEBUG ===');
        console.log('Total image inputs found in edit form:', imageInputs.length);
        
        let imageCount = 0;
        imageInputs.forEach((input, index) => {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            console.log(`Edit Image ${index}: ${file.name} (${file.size} bytes, ${file.type})`);
            formDataWithFiles.append(`campaignImage${index}`, file);
            imageCount++;
          } else {
            console.log(`Edit Image input ${index}: No file selected`);
          }
        });
        
        console.log(`Total images to upload in edit: ${imageCount}`);
        console.log('=== SENDING EDIT REQUEST TO SERVER ===');
        console.log('FormData entries:');
        for (let pair of formDataWithFiles.entries()) {
          if (pair[1] instanceof File) {
            console.log(`  ${pair[0]}: File(${pair[1].name}, ${pair[1].size} bytes, ${pair[1].type})`);
          } else {
            const valueStr = typeof pair[1] === 'string' ? pair[1] : JSON.stringify(pair[1]);
            if (pair[0] === 'campaignData') {
              try {
                const parsed = JSON.parse(valueStr);
                console.log(`  ${pair[0]}:`, {
                  hasImagesToRemove: !!parsed.imagesToRemove,
                  imagesToRemove: parsed.imagesToRemove,
                  imagesToRemoveLength: parsed.imagesToRemove?.length || 0
                });
              } catch (e) {
                console.log(`  ${pair[0]}: ${valueStr.substring(0, 100)}...`);
              }
            } else {
              console.log(`  ${pair[0]}: ${valueStr.substring(0, 100)}...`);
            }
          }
        }

        // Send update request with FormData
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'PUT',
          body: formDataWithFiles // Don't set Content-Type header, let browser set it for FormData
        });
        const result = await response.json();
        if (response.ok) {
          alert('Campaign updated successfully!');
          showSection('campaigns-table');
          // Optionally reload campaigns
        } else {
          throw new Error('Server returned an error: ' + JSON.stringify(result));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function fillFormWithCampaignData(form, campaign) {
      console.log('=== fillFormWithCampaignData called ===');
      console.log('Form element:', form);
      console.log('Campaign data:', campaign);
      console.log('Campaign structure:', {
        _id: campaign._id,
        campaignId: campaign.campaignId,
        name: campaign.name,
        targetAudience: campaign.targetAudience,
        channels: campaign.channels
      });
      
      // Fill in basic fields
      const campaignIdInput = form.querySelector('#campaignId');
      if (campaignIdInput) campaignIdInput.value = campaign.campaignId || '';
      const nameInput = form.querySelector('#name');
      if (nameInput) nameInput.value = campaign.name || '';
      const descInput = form.querySelector('#description');
      if (descInput) descInput.value = campaign.description || '';
      const workStartDateInput = form.querySelector('#workStartDate');
      if (workStartDateInput) workStartDateInput.value = campaign.workStartDate || '';
      const startDateInput = form.querySelector('#startDate');
      if (startDateInput) startDateInput.value = campaign.startDate || '';
      const endDateInput = form.querySelector('#endDate');
      if (endDateInput) endDateInput.value = campaign.endDate || '';
      const budgetInput = form.querySelector('#budget');
      if (budgetInput) budgetInput.value = campaign.budget || '';
      const statusInput = form.querySelector('#status');
      if (statusInput) {
        statusInput.value = campaign.status || '';
        
        // Add event listener for status change to validate Work Start Date
        statusInput.addEventListener('change', function() {
          const workStartDateInput = form.querySelector('#workStartDate');
          if (this.value === 'Planned' && (!workStartDateInput.value || workStartDateInput.value.trim() === '')) {
            alert('‚ö†Ô∏è Warning: Work Start Date is now required since status changed to "Planned". Please select a date when the team started working on this campaign.');
            workStartDateInput.focus();
          }
        });
      }
      const jobAssignedToSelect = form.querySelector('#jobAssignedTo');
      if (jobAssignedToSelect) {
        // Set the value if it exists in the dropdown options
        const optionExists = Array.from(jobAssignedToSelect.options).some(option => option.value === campaign.jobAssignedTo);
        if (optionExists) {
          jobAssignedToSelect.value = campaign.jobAssignedTo || '';
        } else {
          // If the assigned user doesn't exist in current users, add it as an option
          if (campaign.jobAssignedTo) {
            const option = document.createElement('option');
            option.value = campaign.jobAssignedTo;
            option.textContent = campaign.jobAssignedTo;
            jobAssignedToSelect.appendChild(option);
            jobAssignedToSelect.value = campaign.jobAssignedTo;
          }
        }
      }

      // Fill in target audience
      console.log('Filling target audience...');
      console.log('Campaign targetAudience:', campaign.targetAudience);
      
      if (campaign.targetAudience) {
        const ageInput = form.querySelector('#targetAge');
        if (ageInput) {
          ageInput.value = campaign.targetAudience.age || '';
          console.log('Set age:', campaign.targetAudience.age);
        } else {
          console.log('Age input not found');
        }
        
        const genderInput = form.querySelector('#targetGender');
        if (genderInput) {
          genderInput.value = campaign.targetAudience.gender || 'Male';
          console.log('Set gender:', campaign.targetAudience.gender);
        } else {
          console.log('Gender input not found');
        }
        
      } else {
        console.log('No targetAudience found in campaign');
        const ageInput = form.querySelector('#targetAge');
        if (ageInput) ageInput.value = '';
        const genderInput = form.querySelector('#targetGender');
        if (genderInput) genderInput.value = 'Male';
        const catInput = form.querySelector('#targetCategory');
        if (catInput) catInput.value = '';
      }

      // Fill in goals
      if (campaign.goals) {
        const salesInput = form.querySelector('#goalSales');
        if (salesInput) salesInput.value = campaign.goals.sales || '';
        const impressionsInput = form.querySelector('#goalImpressions');
        if (impressionsInput) impressionsInput.value = campaign.goals.impressions || '';
        const conversionsInput = form.querySelector('#goalConversions');
        if (conversionsInput) conversionsInput.value = campaign.goals.conversions || '';
      }

      // Fill in achieved
      if (campaign.achieved) {
        const achievedSalesInput = form.querySelector('#achievedSales');
        if (achievedSalesInput) achievedSalesInput.value = campaign.achieved.sales || '';
        const achievedImpressionsInput = form.querySelector('#achievedImpressions');
        if (achievedImpressionsInput) achievedImpressionsInput.value = campaign.achieved.impressions || '';
        const achievedConversionsInput = form.querySelector('#achievedConversions');
        if (achievedConversionsInput) achievedConversionsInput.value = campaign.achieved.conversions || '';
      }

      // Fill in existing images
      const imageUploadContainer = form.querySelector('#imageUploadContainer');
      if (imageUploadContainer) {
        // Clear existing image items (keep the first one for new uploads)
        const existingItems = imageUploadContainer.querySelectorAll('.image-upload-item');
        existingItems.forEach(item => item.remove());
        
        // Display existing images from campaign
        if (campaign.images && Array.isArray(campaign.images) && campaign.images.length > 0) {
          campaign.images.forEach((imagePath, index) => {
            if (imagePath && imagePath.trim() !== '') {
              const existingImageItem = document.createElement('div');
              existingImageItem.className = 'existing-image-item mb-4 p-3 border border-gray-300 rounded-md bg-gray-50';
              existingImageItem.dataset.imagePath = imagePath;
              existingImageItem.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <img src="${imagePath}" alt="Campaign Image" class="w-20 h-20 object-cover rounded-md border">
                    <div>
                      <p class="text-sm font-medium text-gray-700">Existing Image ${index + 1}</p>
                      <p class="text-xs text-gray-500">${imagePath}</p>
                    </div>
                  </div>
                  <button type="button" class="remove-existing-image-btn btn-secondary py-1 px-3 text-sm text-red-600 hover:text-red-800 rounded-md" data-image-path="${imagePath}">
                    Remove
                  </button>
                </div>
              `;
              imageUploadContainer.appendChild(existingImageItem);
            }
          });
        }
        
        // Add one empty upload field for new images
        const newImageItem = document.createElement('div');
        newImageItem.className = 'image-upload-item mb-4';
        newImageItem.innerHTML = `
          <input type="file" accept="image/*" class="image-upload-input w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
          <p class="text-xs text-gray-500 mt-1">Upload a new image for this campaign (JPG, PNG, GIF - Max 5MB)</p>
          <div class="image-preview mt-2 hidden">
            <img src="" alt="Campaign Preview" class="max-w-xs h-32 object-cover rounded-md border">
            <button type="button" class="remove-image-btn mt-1 text-sm text-red-600 hover:text-red-800">Remove Image</button>
          </div>
        `;
        imageUploadContainer.appendChild(newImageItem);
        
        // Setup event handlers for existing images
        const removeExistingImageBtns = imageUploadContainer.querySelectorAll('.remove-existing-image-btn');
        console.log('=== SETUP REMOVE BUTTONS ===');
        console.log('Found remove buttons:', removeExistingImageBtns.length);
        removeExistingImageBtns.forEach((btn, index) => {
          console.log(`Setting up remove button ${index + 1}:`, btn.dataset.imagePath);
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Remove button clicked for image:', this.dataset.imagePath);
            const imagePath = this.dataset.imagePath;
            const imageItem = this.closest('.existing-image-item');
            console.log('Image item found:', !!imageItem);
            console.log('Current markedForRemoval:', imageItem?.dataset.markedForRemoval);
            
            if (confirm(`Are you sure you want to remove this image?`)) {
              imageItem.classList.add('opacity-50');
              imageItem.dataset.markedForRemoval = 'true';
              this.textContent = 'Removed';
              this.disabled = true;
              this.classList.add('bg-gray-400');
              this.classList.remove('hover:text-red-800');
              console.log('‚úì Image marked for removal:', imagePath);
              console.log('Updated markedForRemoval:', imageItem.dataset.markedForRemoval);
            } else {
              console.log('User cancelled removal');
            }
          });
        });
        
        // Setup event handlers for new image uploads
        const newImageInput = newImageItem.querySelector('.image-upload-input');
        const newRemoveBtn = newImageItem.querySelector('.remove-image-btn');
        if (newImageInput) {
          // Use the global setupImageHandling function if available, otherwise define inline
          if (typeof setupImageHandling === 'function') {
            setupImageHandling(newImageInput);
          } else {
            // Define inline handler
            newImageInput.addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                if (file.size > 5 * 1024 * 1024) {
                  alert('File size must be less than 5MB');
                  this.value = '';
                  return;
                }
                if (!file.type.startsWith('image/')) {
                  alert('Please select an image file');
                  this.value = '';
                  return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                  const preview = newImageInput.closest('.image-upload-item').querySelector('.image-preview');
                  const previewImg = preview.querySelector('img');
                  previewImg.src = e.target.result;
                  preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
              }
            });
          }
        }
        if (newRemoveBtn) {
          // Use the global setupRemoveImage function if available, otherwise define inline
          if (typeof setupRemoveImage === 'function') {
            setupRemoveImage(newRemoveBtn);
          } else {
            newRemoveBtn.addEventListener('click', function() {
              const imageItem = this.closest('.image-upload-item');
              const imageInput = imageItem.querySelector('.image-upload-input');
              const preview = imageItem.querySelector('.image-preview');
              imageInput.value = '';
              preview.classList.add('hidden');
              preview.querySelector('img').src = '';
            });
          }
        }
      }

      // Fill in channels
      const channelContainer = form.querySelector('#channelContainer');
      if (!channelContainer) {
        console.error('#channelContainer not found in form.');
        return; // Ensure container exists
      }

      channelContainer.innerHTML = '';

      if (campaign.channels && campaign.channels.length > 0) {
        campaign.channels.forEach(channel => {
          console.log('Processing channel:', channel);
          
                    // Create channel entry
          const channelEntry = addChannelEntryInEditForm(form);
          if (!channelEntry) {
            console.error('Failed to create channel entry');
            return;
          }
          
          // Set channel type first
          const typeSelect = channelEntry.querySelector('.channelType');
          if (typeSelect) {
            typeSelect.value = channel.type;
            console.log('Set channel type:', channel.type);
            
            // Store the tag number before updateChannelFields (which might trigger auto-generation)
            const existingTagNumber = channel.tagNumber || '';
            
            // Update channel fields to show the correct inputs
            updateChannelFields(typeSelect);
            
            // IMPORTANT: Set tag number IMMEDIATELY after updateChannelFields
            // Use a small delay to ensure the input exists, but before auto-generation timeout (150ms)
            setTimeout(() => {
              const tagNumberInput = channelEntry.querySelector('.channelTagNumber');
              if (tagNumberInput && existingTagNumber) {
                tagNumberInput.value = existingTagNumber;
                console.log('Set tagNumber AFTER updateChannelFields:', existingTagNumber);
                // Mark that we're populating to prevent auto-generation
                tagNumberInput.setAttribute('data-populating', 'true');
              }
            }, 50);
            
            // Fill values after fields are updated
            fillChannelEntryValues(channelEntry, channel);
          }
          
          // Set channel tag
          const channelTagInput = channelEntry.querySelector('.channelTag');
          if (channelTagInput && channel.channelTag) {
            channelTagInput.value = channel.channelTag || '';
            console.log('Set channelTag:', channel.channelTag);
          }
          
          // Append to container after all configuration is complete
          channelContainer.appendChild(channelEntry);
          
          // Ensure the entry is visible and properly rendered
          console.log('Channel entry added to container:', channelEntry);
        });
      }

      // Ensure Add Channel button works after filling
      const addChannelButton = form.querySelector('.btn-secondary');
      if(addChannelButton && addChannelButton.textContent.includes('Add Channel')) {
        addChannelButton.onclick = () => addChannelEntryInEditForm(form);
      }
    }

    // Helper function to fill in channel entry values
    function fillChannelEntryValues(channelEntry, channel) {
      console.log('Filling channel entry values:', channel);
      console.log('Channel entry element:', channelEntry);
      
      // Fill in common fields
      const adNameInput = channelEntry.querySelector('.channelAdName');
      if (adNameInput) {
        adNameInput.value = channel.adName || '';
        console.log('Set adName:', channel.adName, 'in element:', adNameInput);
      } else {
        console.log('AdName input not found');
      }
      
      const costInput = channelEntry.querySelector('.channelCost');
      if (costInput) {
        costInput.value = channel.cost || '';
        console.log('Set cost:', channel.cost, 'in element:', costInput);
      } else {
        console.log('Cost input not found');
      }
      
      const impressionsInput = channelEntry.querySelector('.channelImpressions');
      if (impressionsInput) {
        impressionsInput.value = channel.impressions || '';
        console.log('Set impressions:', channel.impressions, 'in element:', impressionsInput);
      } else {
        console.log('Impressions input not found');
      }
      
      const conversionsInput = channelEntry.querySelector('.channelConversions');
      if (conversionsInput) {
        conversionsInput.value = channel.conversions || '';
        console.log('Set conversions:', channel.conversions, 'in element:', conversionsInput);
      } else {
        console.log('Conversions input not found');
      }
      
      const tagNumberInput = channelEntry.querySelector('.channelTagNumber');
      if (tagNumberInput) {
        if (channel.tagNumber && channel.tagNumber.trim() !== '') {
          tagNumberInput.value = channel.tagNumber;
          // Mark as populated to prevent auto-generation
          tagNumberInput.setAttribute('data-populating', 'true');
        console.log('Set tagNumber:', channel.tagNumber, 'in element:', tagNumberInput);
        } else {
          // Clear the data-populating attribute if no tag exists (allow auto-generation)
          tagNumberInput.removeAttribute('data-populating');
        }
      } else {
        console.log('TagNumber input not found');
      }
      
      // Fill in channel-specific fields based on type
      // Handle Instagram, Facebook, TikTok, Google, and Snapchat with adType dropdown
      if (channel.type === 'Instagram' || channel.type === 'Facebook' || channel.type === 'TikTok' || channel.type === 'Google' || channel.type === 'Snapchat') {
        console.log('Processing', channel.type, 'channel with adType...');
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          // Check if the ad type value exists in the dropdown options
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set ad type:', channel.adType, 'in element:', adTypeSelect);
          } else {
            console.log('Ad type value not found in dropdown options:', channel.adType);
            console.log('Available options:', Array.from(adTypeSelect.options).map(opt => opt.value));
          }
        } else {
          console.log('Ad type select not found');
        }
      } else if (channel.type === 'Social Media' && channel.platform) {
        // Handle legacy Social Media type for backward compatibility
        console.log('Processing legacy Social Media channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set platform:', channel.platform, 'in element:', platformSelect);
          // Trigger platform change to enable fields and populate ad type
          // But don't generate new tags during edit form population
          if (channel.platform) {
            // Temporarily disable tag generation during form population
            platformSelect.setAttribute('data-populating', 'true');
            platformSelect.dispatchEvent(new Event('change'));
            platformSelect.removeAttribute('data-populating');
          }
        } else {
          console.log('Platform select not found');
        }
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          // Check if the ad type value exists in the dropdown options
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set ad type:', channel.adType, 'in element:', adTypeSelect);
          } else {
            console.log('Ad type value not found in dropdown options:', channel.adType);
            console.log('Available options:', Array.from(adTypeSelect.options).map(opt => opt.value));
          }
        } else {
          console.log('Ad type select not found');
        }
      } else if (channel.type === 'Television') {
        console.log('Processing TV channel...');
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
      } else if (channel.type === 'Radio') {
        console.log('Processing Radio channel...');
        
        const stationInput = channelEntry.querySelector('.channelStation');
        if (stationInput) stationInput.value = channel.station || '';
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set Radio ad type:', channel.adType);
          }
        }
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
      } else if (channel.type === 'Print Media') {
        console.log('Processing Print Media channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          // Trigger platform change to enable fields
          if (channel.platform) {
            platformSelect.dispatchEvent(new Event('change'));
          }
        }
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set Print Media ad type:', channel.adType);
          }
        }
        
        const publicationInput = channelEntry.querySelector('.channelPublication');
        if (publicationInput) publicationInput.value = channel.publication || '';
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
        
        const areaInput = channelEntry.querySelector('.channelArea');
        if (areaInput) areaInput.value = channel.area || '';
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'SMS') {
        console.log('Processing SMS channel...');
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set SMS ad type:', channel.adType);
          }
        }
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Print Media') {
        console.log('Processing Print Media channel...');
        
        const publicationInput = channelEntry.querySelector('.channelPublication');
        if (publicationInput) publicationInput.value = channel.publication || '';
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) adTypeSelect.value = channel.adType || '';
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
        
        const areaInput = channelEntry.querySelector('.channelArea');
        if (areaInput) areaInput.value = channel.area || '';
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Storefront') {
        console.log('Processing Storefront channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set Storefront platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
      } else if (channel.type === 'YouTube') {
        console.log('Processing YouTube channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set YouTube platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
      } else if (channel.type === 'WhatsApp Group') {
        console.log('Processing WhatsApp Group channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set WhatsApp Group platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
      } else if (channel.type === 'Email') {
        console.log('Processing Email channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set Email platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Message') {
        console.log('Processing Message channel...');
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Gold councils') {
        console.log('Processing Gold councils channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set Gold councils platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields if needed
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
      } else if (channel.type === 'Referral') {
        console.log('Processing Referral channel...');
        
        // Check the checkboxes based on saved types array
        if (channel.types && Array.isArray(channel.types)) {
          const checkboxes = channelEntry.querySelectorAll('.channelTypeCheckbox');
          checkboxes.forEach(checkbox => {
            if (channel.types.includes(checkbox.value)) {
              checkbox.checked = true;
              console.log('Checked type:', checkbox.value);
            }
          });
          // Trigger change event on first checked checkbox to enable fields
          const firstChecked = Array.from(checkboxes).find(cb => cb.checked);
          if (firstChecked) {
            firstChecked.dispatchEvent(new Event('change', { bubbles: true }));
          }
        } else if (channel.platform) {
          // Backward compatibility: if old data has platform, try to match it
          const checkboxes = channelEntry.querySelectorAll('.channelTypeCheckbox');
          const matchingCheckbox = Array.from(checkboxes).find(cb => cb.value === channel.platform);
          if (matchingCheckbox) {
            matchingCheckbox.checked = true;
            matchingCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
      } else if (channel.type === 'Event' || channel.type === 'Exhibition' || channel.type === 'New collection Launch' || channel.type === 'Channel Partners' || channel.type === 'Corporate Partners' || channel.type === 'Hotel' || channel.type === 'Tour Driver' || channel.type === 'Tours&Travel Agency' || channel.type === 'Website' || ['Residential Community', 'Lang/Cultural group', 'Religious group', 'Bluecollar Camp', 'Neighbourhood Community', 'Social organisations'].includes(channel.type)) {
        console.log('Processing', channel.type, 'channel with types...');
        
        // Check the checkboxes based on saved types array
        if (channel.types && Array.isArray(channel.types)) {
          const checkboxes = channelEntry.querySelectorAll('.channelTypeCheckbox');
          checkboxes.forEach(checkbox => {
            if (channel.types.includes(checkbox.value)) {
              checkbox.checked = true;
              console.log('Checked type:', checkbox.value);
            }
          });
        }
      } else if (channel.type === 'Outdoor Ads') {
        console.log('Processing Outdoor Ads channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set Outdoor Ads platform:', channel.platform);
          
          // Trigger the platform change event to enable/disable fields
          const event = new Event('change', { bubbles: true });
          platformSelect.dispatchEvent(event);
        }
        
        const venueInput = channelEntry.querySelector('.channelVenue');
        if (venueInput) venueInput.value = channel.venue || '';
      } else if (channel.type === 'Outdoor Events') {
        console.log('Processing Outdoor Events channel...');
        
        const venueInput = channelEntry.querySelector('.channelVenue');
        if (venueInput) venueInput.value = channel.venue || '';
      } else if (channel.type === 'Promotional Items') {
        console.log('Processing Promotional Items channel...');
      } else if (channel.type === 'Promotional Offer') {
        console.log('Processing Promotional Offer channel...');
      }
      
      // Enable all fields after setting values (for edit mode)
      const allInputs = channelEntry.querySelectorAll('input, select');
      allInputs.forEach(input => {
        if (input !== channelEntry.querySelector('.channelType') && 
            input !== channelEntry.querySelector('.channelTagNumber')) {
          input.disabled = false;
          input.classList.remove('bg-gray-100');
        }
      });
      
      // Force a re-render to ensure values are visible
      channelEntry.style.display = 'none';
      channelEntry.offsetHeight; // Force reflow
      channelEntry.style.display = '';
      
      console.log('Channel entry values filled successfully');
    }

    // --- CATEGORY DYNAMIC ADD/REMOVE ---
    // Global function for updating remove category buttons

    // Reference Code Generation
    let tagCounter = 1;
    
    async function generateTagNumber(button) {
      const entry = button ? button.closest('.channelEntry') : document.querySelector('.channelEntry:last-child');
      
      if (!entry) {
        console.error('Channel entry not found');
        return;
      }
      
      const tagInput = entry.querySelector('.channelTagNumber');
      if (!tagInput) {
        console.error('Tag input not found in entry');
        return;
      }
      
      const channelTypeSelect = entry.querySelector('.channelType');
      if (!channelTypeSelect) {
        console.error('Channel type select not found in entry');
        return;
      }
      
      const channelType = channelTypeSelect.value ? channelTypeSelect.value.trim() : '';
      const platform = entry.querySelector('.channelPlatform')?.value || '';
      
      // Don't show alert if this is an automatic call (button is null) and no channel type is selected
      // This prevents unwanted alerts during edit mode when fields are being populated
      if (!channelType && !button) {
        console.log('Skipping tag generation - no channel type selected and no button provided');
        return;
      }
      
      if (!channelType) {
        console.error('Channel type is empty. Select element:', channelTypeSelect, 'Entry:', entry, 'Available options:', Array.from(channelTypeSelect.options).map(opt => opt.value));
        if (button) {
        alert('Please select a channel type first');
        }
        return;
      }
      
      
      try {
        console.log('Frontend sending tag generation request:', { channelType, platform });
        console.log('Platform type:', typeof platform);
        console.log('Platform length:', platform ? platform.length : 'null');
        
        // Use server endpoint to generate unique tag
        const response = await fetch('/api/tags/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelType: channelType.trim(), platform: platform.trim() })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('Server error response:', errorData);
          throw new Error(errorData.error || `Server returned ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.tagNumber) {
          tagInput.value = result.tagNumber;
          tagInput.disabled = true;
          tagInput.placeholder = 'Auto-generated';
          tagInput.classList.remove('bg-gray-50');
          tagInput.classList.add('bg-blue-50', 'text-blue-900');
          
          // Tags are auto-generated, no buttons to hide
          
          // Make platform uneditable after tag generation
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.disabled = true;
            platformSelect.classList.add('bg-gray-100');
            platformSelect.title = "Platform cannot be changed after tag generation";
          }
          
          // Make channel type uneditable after tag generation
          const channelTypeSelect = entry.querySelector('.channelType');
          if (channelTypeSelect) {
            channelTypeSelect.disabled = true;
            channelTypeSelect.classList.add('bg-gray-100');
            channelTypeSelect.title = "Channel type cannot be changed after tag generation";
          }

          console.log(`Generated unique tag: ${result.tagNumber}`);
        } else {
          throw new Error(result.error || 'Failed to generate tag');
        }
      } catch (err) {
        console.error('Error generating unique tag:', err);
        alert('Error generating tag number. Please try again.');
      }
    }

    // Impression Tracking Functions
    async function loadImpressionStats() {
      try {
        console.log('=== LOAD IMPRESSION STATS FUNCTION CALLED ===');
        const statsContainer = document.getElementById('impressionStats');
        if (!statsContainer) {
          console.error('impressionStats container not found');
          alert('Error: Impression stats container not found');
          return;
        }
        
        // Show loading state
        statsContainer.innerHTML = '<p class="text-gray-500">Loading statistics...</p>';
        
        console.log('Loading impression stats...');
        const response = await fetch('/api/impressions/stats');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Error response:', errorData);
          statsContainer.innerHTML = `<p class="text-red-500">Error loading impression stats: ${errorData.error || 'Server error'}</p>`;
          alert('Error loading impression stats: ' + (errorData.error || 'Server error'));
          return;
        }
        
        const stats = await response.json();
        console.log('Raw stats response:', stats); // Debug log
        console.log('Raw stats response type:', typeof stats); // Debug log
        console.log('Raw stats response keys:', Object.keys(stats)); // Debug log
        console.log('Total impressions:', stats.totalImpressions); // Debug log
        console.log('Campaigns with impressions:', stats.campaignsWithImpressions); // Debug log
        console.log('Channels by type:', stats.channelsByType); // Debug log
        console.log('Impressions by platform:', stats.impressionsByPlatform); // Debug log
        
        if (stats) {
          displayImpressionStats(stats);
          console.log('‚úì Impression stats displayed successfully');
        } else {
          console.error('Invalid response format:', stats);
          if (statsContainer) {
            statsContainer.innerHTML = '<p class="text-red-500">Invalid response format from server</p>';
          }
          alert('Error: Invalid response format from server');
        }
      } catch (err) {
        console.error('Error loading impression stats:', err);
        const statsContainer = document.getElementById('impressionStats');
        if (statsContainer) {
          statsContainer.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
        }
        alert('Error loading impression statistics: ' + err.message);
      }
    }

    function displayImpressionStats(stats) {
      console.log('Received impression stats:', stats); // Debug log
      
      // Display overall statistics
      const statsContainer = document.getElementById('impressionStats');
      statsContainer.innerHTML = `
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-indigo-600 mb-4">üìà Marketing Summary</h3>
          <div class="grid grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <h4 class="text-sm font-medium text-blue-700 mb-2">Total Number of Marketing Initiatives</h4>
              <p class="text-2xl font-bold text-blue-900">${new Intl.NumberFormat().format(stats.totalMarketingInitiatives || 0)}</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
              <h4 class="text-sm font-medium text-green-700 mb-2">Total Impressions</h4>
              <p class="text-2xl font-bold text-green-900">${new Intl.NumberFormat().format(stats.totalImpressions || 0)}</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
          <h4 class="text-sm font-medium text-red-700 mb-2">Total Conversions</h4>
          <p class="text-2xl font-bold text-red-900">${new Intl.NumberFormat().format(stats.totalConversions || 0)}</p>
        </div>
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
              <h4 class="text-sm font-medium text-purple-700 mb-2">Marketing Records with Impressions</h4>
              <p class="text-2xl font-bold text-purple-900">${stats.campaignsWithImpressions}</p>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
            <h4 class="text-lg font-semibold text-indigo-700 mb-3">Channel Types Summary</h4>
            ${Object.keys(stats.channelsByType || {}).length > 0 ? `
          <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-indigo-200">
                  <thead class="bg-indigo-100">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Channel Type</th>
                      <th class="px-4 py-2 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Total Impressions</th>
                      <th class="px-4 py-2 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Total Conversions</th>
                </tr>
              </thead>
                  <tbody class="bg-white divide-y divide-indigo-200">
                    ${Object.entries(stats.channelsByType || {})
                      .sort((a, b) => {
                        // Primary sort: impressions (descending)
                        if (b[1].impressions !== a[1].impressions) {
                          return b[1].impressions - a[1].impressions;
                        }
                        // Secondary sort: conversions (descending)
                        return b[1].conversions - a[1].conversions;
                      })
                      .map(([channelType, data]) => `
                      <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${channelType}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-semibold text-indigo-600">${new Intl.NumberFormat().format(data.impressions || 0)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-semibold text-indigo-600">${new Intl.NumberFormat().format(data.conversions || 0)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
            ` : '<p class="text-gray-500 text-sm">No channel data available.</p>'}
              </div>
          </div>
        `;

    }

    async function searchByTag() {
      const tagNumber = document.getElementById('searchTagNumber').value.trim();
      console.log('Searching for reference code:', tagNumber);
      
      if (!tagNumber) {
        alert('Please enter a reference code to search');
        return;
      }

      try {
        console.log('Making API request to:', `/api/campaigns/tag/${tagNumber}`);
        const response = await fetch(`/api/campaigns/tag/${tagNumber}`);
        console.log('Response status:', response.status);
        
        const result = await response.json();
        console.log('Response data:', result);
        
        if (response.ok) {
          displayTagSearchResults(result);
        } else {
          document.getElementById('tagSearchResults').innerHTML = 
            `<p class="text-red-500">${result.error}</p>`;
        }
      } catch (err) {
        console.error('Error searching by tag:', err);
        document.getElementById('tagSearchResults').innerHTML = 
          '<p class="text-red-500">Error searching for tag</p>';
      }
    }

    async function loadAllTags() {
      try {
        const response = await fetch('/api/tags');
        const result = await response.json();
        
        if (response.ok) {
          displayAllTags(result);
        } else {
          alert('Error loading tags: ' + result.error);
        }
      } catch (err) {
        console.error('Error loading tags:', err);
        alert('Error loading tags');
      }
    }

    function displayTagSearchResults(result) {
      const container = document.getElementById('tagSearchResults');
      
      if (result.campaigns.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No campaigns found with this tag.</p>';
        return;
      }

      let html = `
        <div class="bg-green-50 p-3 rounded-lg mb-4">
          <h4 class="text-sm font-medium text-green-700">Found ${result.count || result.campaigns?.length || 0} Marketing Initiative(s) with reference code: ${result.tagNumber}</h4>
        </div>
      `;

      result.campaigns.forEach(campaign => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4 mb-4">
            <h5 class="font-semibold text-purple-700 mb-2">${campaign.name} (${campaign.campaignId})</h5>
            <p class="text-sm text-gray-600 mb-3">${campaign.description || 'No description'}</p>
            
            <h6 class="text-sm font-medium text-gray-700 mb-2">Channels with tag ${result.tagNumber}:</h6>
            <div class="space-y-2">
        `;

        campaign.channels.forEach((channel, index) => {
          if (channel.tagNumber === result.tagNumber) {
            html += `
              <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                  <div>
                    <span class="font-medium">Type:</span> ${channel.type}
                  </div>
                  <div>
                    <span class="font-medium">Name:</span> ${channel.adName}
                  </div>
                  ${channel.platform ? `<div><span class="font-medium">Platform:</span> ${channel.platform}</div>` : ''}
                  <div>
                    <span class="font-medium">Cost:</span> ${channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A'}
                  </div>
                  ${channel.impressions ? `<div><span class="font-medium">Impressions:</span> ${new Intl.NumberFormat().format(channel.impressions)}</div>` : ''}
                  <div>
                    <span class="font-medium">Reference Code:</span> <span class="font-mono bg-yellow-200 px-2 py-1 rounded">${channel.tagNumber}</span>
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function displayAllTags(result) {
      const container = document.getElementById('tagSearchResults');
      
      if (result.tags.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No tags found in any campaigns.</p>';
        return;
      }

      let html = `
        <div class="bg-blue-50 p-3 rounded-lg mb-4">
          <h4 class="text-sm font-medium text-blue-700">Found ${result.count} unique tag(s)</h4>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
      `;

      result.tags.forEach(tag => {
        html += `
          <div class="bg-gray-50 p-2 rounded border text-center">
            <span class="font-mono text-sm">${tag}</span>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    async function loadTagCounters() {
      console.log('=== LOAD TAG COUNTERS FUNCTION CALLED ===');
      try {
        const container = document.getElementById('tagCountersContent');
        if (!container) {
          console.error('tagCountersContent container not found');
          alert('Error: Tag counters container not found');
          return;
        }
        
        // Show loading state
        container.innerHTML = '<p class="text-gray-500">Loading counters...</p>';
        
        const response = await fetch('/api/tags/counters');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Error response:', errorData);
          container.innerHTML = `<p class="text-red-500">Error loading tag counters: ${errorData.error || 'Server error'}</p>`;
          alert('Error loading tag counters: ' + (errorData.error || 'Server error'));
          return;
        }
        
        const result = await response.json();
        console.log('Tag counters result:', result);
        
        if (result && result.counters) {
          displayTagCounters(result);
          console.log('‚úì Tag counters displayed successfully');
        } else {
          console.error('Invalid response format:', result);
          container.innerHTML = '<p class="text-red-500">Invalid response format from server</p>';
          alert('Error: Invalid response format from server');
        }
      } catch (err) {
        console.error('Error loading tag counters:', err);
        const container = document.getElementById('tagCountersContent');
        if (container) {
          container.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
        }
        alert('Error loading tag counters: ' + err.message);
      }
    }

    function displayTagCounters(result) {
      const container = document.getElementById('tagCountersContent');
      
      if (result.counters.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No tag counters found.</p>';
        return;
      }



      let html = '';

      result.counters.forEach(counter => {
        html += `
          <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
            <div class="text-center">
              <div class="text-lg font-bold text-purple-700 mb-1">${counter.prefix}</div>
              <div class="text-sm text-gray-600 mb-1">${counter.platformName}</div>
              <div class="text-sm text-gray-600 mb-2">Last Used: ${counter.lastNumber}</div>
              <div class="text-xs font-mono bg-purple-100 px-2 py-1 rounded">
                Next: ${counter.nextTag}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function loadCampaignChannels() {
      const campaignId = document.getElementById('updateCampaignId').value.trim();
      
      if (!campaignId) {
        alert('Please enter a campaign ID');
        return;
      }

      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        
        if (response.ok) {
          displayCampaignChannels(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('Error loading campaign channels:', err);
        alert('Error loading campaign channels: ' + err.message);
      }
    }

    function displayCampaignChannels(campaign) {
      const displayDiv = document.getElementById('campaignChannelsDisplay');
      const channelsList = document.getElementById('channelsList');
      const marketingAchievedDiv = document.getElementById('marketingAchievedDisplay');
      
      // Display marketing achieved impressions and conversions
      if (marketingAchievedDiv) {
        const currentImpressions = campaign.achieved?.impressions || 0;
        const currentConversions = campaign.achieved?.conversions || 0;
        
        document.getElementById('currentMarketingImpressions').textContent = new Intl.NumberFormat().format(currentImpressions);
        document.getElementById('currentMarketingConversions').textContent = new Intl.NumberFormat().format(currentConversions);
        document.getElementById('marketingImpressions').value = currentImpressions;
        document.getElementById('marketingConversions').value = currentConversions;
        
        marketingAchievedDiv.classList.remove('hidden');
      }
      
      if (!campaign.channels || campaign.channels.length === 0) {
        channelsList.innerHTML = '<p class="text-gray-500">No channels found for this campaign.</p>';
        displayDiv.classList.remove('hidden');
        return;
      }

      let html = '';
      campaign.channels.forEach((channel, index) => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
              <div>
                <p class="text-sm font-medium text-gray-700">Channel ${index + 1}</p>
                <p class="text-xs text-gray-500">${channel.type}${channel.platform ? ' - ' + channel.platform : ''}</p>
                <p class="text-xs text-gray-500">${channel.adName || 'N/A'}</p>
                ${channel.tagNumber ? `<p class="text-xs font-mono bg-yellow-100 px-2 py-1 rounded mt-1">${channel.tagNumber}</p>` : ''}
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700">Current Impressions</p>
                <p class="text-lg font-bold text-purple-600">${channel.impressions ? new Intl.NumberFormat().format(channel.impressions) : '0'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">New Impressions</label>
                <input type="number" 
                       id="impressions_${channel.tagNumber || index}" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" 
                       placeholder="Enter new value" 
                       min="0"
                       value="${channel.impressions || 0}">
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700">Current Conversions</p>
                <p class="text-lg font-bold text-green-600">${channel.conversions ? new Intl.NumberFormat().format(channel.conversions) : '0'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">New Conversions</label>
                <input type="number" 
                       id="conversions_${channel.tagNumber || index}" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       placeholder="Enter new value" 
                       min="0"
                       value="${channel.conversions || 0}">
              </div>
              <div class="flex items-end">
                <button onclick="updateChannelMetrics('${channel.tagNumber || index}', ${index})" 
                        class="btn-primary py-2 px-4 rounded-md text-sm">
                  Update
                </button>
              </div>
            </div>
          </div>
        `;
      });

      channelsList.innerHTML = html;
      displayDiv.classList.remove('hidden');
    }

    async function updateMarketingAchieved() {
      const campaignId = document.getElementById('updateCampaignId').value.trim();
      const impressions = parseInt(document.getElementById('marketingImpressions').value);
      const conversions = parseInt(document.getElementById('marketingConversions').value);

      if (!campaignId) {
        alert('Please enter a Marketing ID first.');
        return;
      }

      if (isNaN(impressions) || impressions < 0) {
        alert('Please enter a valid impressions value (must be a positive number).');
        return;
      }

      if (isNaN(conversions) || conversions < 0) {
        alert('Please enter a valid conversions value (must be a positive number).');
        return;
      }

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/achieved`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ impressions, conversions })
        });

        const result = await response.json();
        
        if (response.ok) {
          alert('Marketing achieved impressions and conversions updated successfully!');
          // Refresh the campaign display
          loadCampaignChannels();
          // Refresh the statistics
          loadImpressionStats();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('Error updating marketing achieved:', err);
        alert('Error updating marketing achieved: ' + err.message);
      }
    }

    async function updateChannelMetrics(tagNumber, channelIndex) {
      const impressionsInput = document.getElementById(`impressions_${tagNumber}`);
      const conversionsInput = document.getElementById(`conversions_${tagNumber}`);
      const impressions = parseInt(impressionsInput.value);
      const conversions = parseInt(conversionsInput.value);

      if (isNaN(impressions) || impressions < 0) {
        alert('Please enter a valid impressions value (must be a positive number).');
        return;
      }

      if (isNaN(conversions) || conversions < 0) {
        alert('Please enter a valid conversions value (must be a positive number).');
        return;
      }

      const campaignId = document.getElementById('updateCampaignId').value.trim();

      try {
        let response;
        if (tagNumber && tagNumber !== channelIndex.toString()) {
          // Use reference code if available
          response = await fetch(`/api/campaigns/impressions/${tagNumber}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ impressions, conversions })
          });
        } else {
          // Fallback to channel index
          response = await fetch(`/api/campaigns/${campaignId}/channels/${channelIndex}/impressions`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ impressions, conversions })
          });
        }

        const result = await response.json();
        
        if (response.ok) {
          alert(`Impressions updated successfully!`);
          // Refresh the channels display
          loadCampaignChannels();
          // Refresh the statistics
          loadImpressionStats();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('Error updating impressions:', err);
        alert('Error updating impressions: ' + err.message);
      }
    }

    // Toggle impression tracking sections
    function toggleImpressionSection(sectionId) {
      // Hide all sections first
      const sections = ['overallStats', 'updateImpressions', 'searchByTag', 'tagCounters'];
      sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) {
          section.classList.add('hidden');
        }
      });
      
      // Show the selected section
      const selectedSection = document.getElementById(sectionId);
      if (selectedSection) {
        selectedSection.classList.remove('hidden');
        
        // Auto-load data when section is shown
        if (sectionId === 'overallStats') {
          loadImpressionStats();
        } else if (sectionId === 'tagCounters') {
          loadTagCounters();
        }
      }
    }

    // Toggle Priority Channels in Channel Manager
    window.togglePriorityChannels = function() {
      const section = document.getElementById('priorityChannels');
      if (!section) return;
      
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        showPriorityChannels();
      } else {
        section.classList.add('hidden');
      }
    };

    // Auto-load impression stats when the section is shown
    window.showSection = function(sectionId) {
      console.log(`Attempting to show section: ${sectionId}`);
      // Hide all sections and clear their content where necessary
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
        // Clear content for specific sections
        if (section.id === 'query-campaign') {
          console.log('Clearing query section content');
          const queryCampaignForm = section.querySelector('#queryCampaignForm');
          if (queryCampaignForm) {
            queryCampaignForm.classList.add('hidden');
            queryCampaignForm.innerHTML = ''; // Clear form HTML
          }
          const downloadBtn = section.querySelector('#downloadExcelBtn');
          if (downloadBtn) {
            downloadBtn.classList.add('hidden');
          }
        } else if (section.id === 'edit-campaign') {
          console.log('Clearing edit section content');
          const editCampaignId = section.querySelector('#editCampaignId');
          if (editCampaignId) {
            editCampaignId.value = '';
          }
          const editCampaignForm = section.querySelector('#editCampaignForm');
          if (editCampaignForm) {
            editCampaignForm.classList.add('hidden');
            editCampaignForm.innerHTML = ''; // Clear loaded form
          }
        } else if (section.id === 'new-campaign') {
             console.log('Clearing new campaign form');
             clearForm();
             // Campaign ID will be assigned by backend when form is submitted
        }
      });
      
      // Show selected section
      const selectedSection = document.getElementById(sectionId);
      if (selectedSection) {
        selectedSection.classList.remove('hidden');
        console.log(`Section ${sectionId} is now visible.`);
        
        // Auto-load impression stats when impression tracking section is shown
        if (sectionId === 'impression-tracking') {
          loadImpressionStats();
          loadTagCounters();
        }
        
        // Load users for job assignment dropdown when new-campaign section is shown
        if (sectionId === 'new-campaign') {
          // Add a small delay to ensure the DOM is ready
          setTimeout(() => {
            loadUsersForJobAssignment();
          }, 100);
        }
      } else {
        console.error(`Section with ID ${sectionId} not found.`);
      }
      
      // Update active state of buttons
      document.querySelectorAll('.mb-8 .grid button').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-purple-500');
      });
      
      // Find the button that triggers the current section and highlight it by text content
      const menuButtons = document.querySelectorAll('.mb-8 .grid button');
      let buttonTextToMatch = '';
      if (sectionId === 'new-campaign') buttonTextToMatch = 'New Campaign';
      else if (sectionId === 'edit-campaign') buttonTextToMatch = 'Edit Campaign';
      else if (sectionId === 'query-campaign') buttonTextToMatch = 'Query Campaign';
      else if (sectionId === 'export-campaign') buttonTextToMatch = 'Export Campaigns';
      else if (sectionId === 'impression-tracking') buttonTextToMatch = 'Impression Tracking';
      else if (sectionId === 'user-manager') buttonTextToMatch = 'User & Role Manager';
      else if (sectionId === 'campaigns-table') buttonTextToMatch = 'Campaigns Table';
      else if (sectionId === 'channel-manager') buttonTextToMatch = 'Channel Manager';

      if (buttonTextToMatch) {
          menuButtons.forEach(button => {
              // Use textContent and trim for reliable matching
              if (button.textContent.trim() === buttonTextToMatch) {
                  button.classList.add('ring-2', 'ring-purple-500');
                  console.log(`Highlighted button for section: ${sectionId}`);
              }
          });
      } else {
          console.warn(`No button text defined for sectionId: ${sectionId}`);
      }

      // Special actions for specific sections when shown
      if (sectionId === 'new-campaign') {
         // Campaign ID will be assigned by backend when form is submitted
         // Ensure campaignId field is empty
         const campaignIdField = document.getElementById('campaignId');
         if (campaignIdField) campaignIdField.value = '';
      } else if (sectionId === 'query-campaign') {
          // Auto-load campaign details if a campaign is already selected
          console.log('Query Campaign section shown, checking for selected campaign...');
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) {
              console.log('Campaign already selected, auto-loading details...');
              console.log('Selected campaign ID:', selectedRadio.value);
              console.log('querySelectedCampaign function exists:', typeof window.querySelectedCampaign);
              // Add a small delay to ensure the section is fully visible
              setTimeout(() => {
                  console.log('Calling querySelectedCampaign after delay...');
                  querySelectedCampaign();
              }, 100);
          } else {
              console.log('No campaign selected yet');
          }
      } else if (sectionId === 'edit-campaign') {
          // Nothing needed here, load is triggered by button click
      } else if (sectionId === 'export-campaign') {
          // Nothing needed here, export is triggered by button click
      } else if (sectionId === 'impression-tracking') {
          // Auto-load stats when section is shown
          loadImpressionStats();
      } else if (sectionId === 'campaigns-table') {
          // Auto-load campaigns when table section is shown
          loadCampaignsTable();
      } else if (sectionId === 'user-manager') {
          // Only load user manager if user has permission
          if (window.sessionManager && window.sessionManager.hasPermission('manage_users')) {
              console.log('[DEBUG] showSection: user-manager section requested with permission');
              if (typeof renderUsersTable === 'function') {
                  console.log('[DEBUG] Calling renderUsersTable...');
                  renderUsersTable();
              } else {
                  console.error('[DEBUG] renderUsersTable function not found!');
              }
          } else {
              console.log('[DEBUG] User does not have permission to access user-manager');
              alert('You do not have permission to access User & Role Manager');
              // Hide the section again
              selectedSection.classList.add('hidden');
              return;
          }
      }
       console.log(`Finished showing section: ${sectionId}`);
    };

    // Function to load campaigns table
    async function loadCampaignsTable() {
      try {
        console.log('[DEBUG] Loading campaigns table...');
        const response = await fetch('/api/campaigns');
        const campaigns = await response.json();
        
        console.log('[DEBUG] API Response status:', response.status);
        console.log('[DEBUG] API Response data:', campaigns);
        
        if (response.ok) {
          // Load job assignment filter dropdown
          loadUsersForJobAssignmentFilter();
          displayCampaignsTable(campaigns);
        } else {
          console.error('Error loading campaigns:', campaigns.error);
        }
      } catch (err) {
        console.error('Error loading campaigns:', err);
      }
    }

    // Store original campaigns data for filtering
    let originalCampaigns = [];
    
    // Helper function to format dates in dd/mm/yy format
    function formatDateDDMMYY(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      
      return `${day}/${month}/${year}`;
    }
    
    // Function to display campaigns in table
    function displayCampaignsTable(campaigns) {
      console.log('displayCampaignsTable called with:', campaigns);
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      console.log('Original campaigns stored:', originalCampaigns.length);
      
      // Debug: Check which campaigns have images
      const campaignsWithImages = campaigns.filter(c => c.images && (
        (Array.isArray(c.images) && c.images.length > 0) ||
        (typeof c.images === 'string' && c.images.trim() !== '')
      ));
      console.log('Campaigns with images:', campaignsWithImages.length);
      campaignsWithImages.forEach(c => {
        console.log(`Campaign ${c.campaignId} has ${Array.isArray(c.images) ? c.images.length : 1} image(s):`, c.images);
      });
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to apply filters
    function applyFilters() {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody || !originalCampaigns) return;
      
      // Get filter values
      const campaignIdFilter = document.getElementById('filter-campaign-id')?.value.toLowerCase() || '';
      const campaignNameFilter = document.getElementById('filter-campaign-name')?.value.toLowerCase() || '';
      const offersFilter = document.getElementById('filter-offers')?.value.toLowerCase() || '';
      const workStartDateFrom = document.getElementById('filter-work-start-date-from')?.value || '';
      const workStartDateTo = document.getElementById('filter-work-start-date-to')?.value || '';
      const startDateFrom = document.getElementById('filter-start-date-from')?.value || '';
      const startDateTo = document.getElementById('filter-start-date-to')?.value || '';
      const endDateFrom = document.getElementById('filter-end-date-from')?.value || '';
      const endDateTo = document.getElementById('filter-end-date-to')?.value || '';
      const budgetMin = document.getElementById('filter-budget-min')?.value || '';
      const budgetMax = document.getElementById('filter-budget-max')?.value || '';
      const statusFilter = document.getElementById('filter-status')?.value || '';
      const jobAssignedToFilter = document.getElementById('filter-job-assigned-to')?.value || '';
      const targetAgeFilter = document.getElementById('filter-target-age')?.value.toLowerCase() || '';
      const targetGenderFilter = document.getElementById('filter-target-gender')?.value || '';
      const goalSalesMin = document.getElementById('filter-goal-sales-min')?.value || '';
      const goalSalesMax = document.getElementById('filter-goal-sales-max')?.value || '';
      const goalImpressionsMin = document.getElementById('filter-goal-impressions-min')?.value || '';
      const goalImpressionsMax = document.getElementById('filter-goal-impressions-max')?.value || '';
      const goalConversionsMin = document.getElementById('filter-goal-conversions-min')?.value || '';
      const goalConversionsMax = document.getElementById('filter-goal-conversions-max')?.value || '';
      const achievedSalesMin = document.getElementById('filter-achieved-sales-min')?.value || '';
      const achievedSalesMax = document.getElementById('filter-achieved-sales-max')?.value || '';
      const achievedImpressionsMin = document.getElementById('filter-achieved-impressions-min')?.value || '';
      const achievedImpressionsMax = document.getElementById('filter-achieved-impressions-max')?.value || '';
      const achievedConversionsMin = document.getElementById('filter-achieved-conversions-min')?.value || '';
      const achievedConversionsMax = document.getElementById('filter-achieved-conversions-max')?.value || '';
      const channelsFilter = document.getElementById('filter-channels')?.value || '';
      const channelTagsFilter = document.getElementById('filter-channel-tags')?.value.toLowerCase() || '';
      const tagNumbersFilter = document.getElementById('filter-tag-numbers')?.value.toLowerCase() || '';
      
      // Filter campaigns
      const filteredCampaigns = originalCampaigns.filter(campaign => {
        // Campaign ID filter
        if (campaignIdFilter && !(campaign.campaignId || '').toLowerCase().includes(campaignIdFilter)) return false;
        
        // Campaign Name filter
        if (campaignNameFilter && !(campaign.name || '').toLowerCase().includes(campaignNameFilter)) return false;
        
        // Offers filter
        if (offersFilter && !(campaign.description || '').toLowerCase().includes(offersFilter)) return false;
        
        // Work Start Date filter
        if (workStartDateFrom && campaign.workStartDate && new Date(campaign.workStartDate) < new Date(workStartDateFrom)) return false;
        if (workStartDateTo && campaign.workStartDate && new Date(campaign.workStartDate) > new Date(workStartDateTo)) return false;
        
        // Start Date filter
        if (startDateFrom && campaign.startDate && new Date(campaign.startDate) < new Date(startDateFrom)) return false;
        if (startDateTo && campaign.startDate && new Date(campaign.startDate) > new Date(startDateTo)) return false;
        
        // End Date filter
        if (endDateFrom && campaign.endDate && new Date(campaign.endDate) < new Date(endDateFrom)) return false;
        if (endDateTo && campaign.endDate && new Date(campaign.endDate) > new Date(endDateTo)) return false;
        
        // Budget filter
        if (budgetMin && (!campaign.budget || campaign.budget < parseFloat(budgetMin))) return false;
        if (budgetMax && (!campaign.budget || campaign.budget > parseFloat(budgetMax))) return false;
        
        // Status filter
        if (statusFilter && campaign.status !== statusFilter) return false;
        
        // Job Assigned To filter
        if (jobAssignedToFilter && campaign.jobAssignedTo !== jobAssignedToFilter) return false;
        
        // Target Age filter
        if (targetAgeFilter && !(campaign.targetAudience?.age || '').toLowerCase().includes(targetAgeFilter)) return false;
        
        // Target Gender filter
        if (targetGenderFilter && campaign.targetAudience?.gender !== targetGenderFilter) return false;
        
        // Goal Sales filter
        if (goalSalesMin && (!campaign.goals?.sales || campaign.goals.sales < parseFloat(goalSalesMin))) return false;
        if (goalSalesMax && (!campaign.goals?.sales || campaign.goals.sales > parseFloat(goalSalesMax))) return false;
        
        // Goal Impressions filter
        if (goalImpressionsMin && (!campaign.goals?.impressions || campaign.goals.impressions < parseFloat(goalImpressionsMin))) return false;
        if (goalImpressionsMax && (!campaign.goals?.impressions || campaign.goals.impressions > parseFloat(goalImpressionsMax))) return false;
        
        // Goal Conversions filter
        if (goalConversionsMin && (!campaign.goals?.conversions || campaign.goals.conversions < parseFloat(goalConversionsMin))) return false;
        if (goalConversionsMax && (!campaign.goals?.conversions || campaign.goals.conversions > parseFloat(goalConversionsMax))) return false;
        
        // Achieved Sales filter
        if (achievedSalesMin && (!campaign.achieved?.sales || campaign.achieved.sales < parseFloat(achievedSalesMin))) return false;
        if (achievedSalesMax && (!campaign.achieved?.sales || campaign.achieved.sales > parseFloat(achievedSalesMax))) return false;
        
        // Achieved Impressions filter
        if (achievedImpressionsMin && (!campaign.achieved?.impressions || campaign.achieved.impressions < parseFloat(achievedImpressionsMin))) return false;
        if (achievedImpressionsMax && (!campaign.achieved?.impressions || campaign.achieved.impressions > parseFloat(achievedImpressionsMax))) return false;
        
        // Achieved Conversions filter
        if (achievedConversionsMin && (!campaign.achieved?.conversions || campaign.achieved.conversions < parseFloat(achievedConversionsMin))) return false;
        if (achievedConversionsMax && (!campaign.achieved?.conversions || campaign.achieved.conversions > parseFloat(achievedConversionsMax))) return false;
        
        // Channels filter
        if (channelsFilter) {
          const channelTypes = campaign.channels ? 
            campaign.channels.map(channel => channel.type).filter(type => type) : [];
          if (!channelTypes.includes(channelsFilter)) return false;
        }
        
        // Channel Tags filter
        if (channelTagsFilter) {
          const allChannelTags = campaign.channels ? 
            campaign.channels.map(channel => channel.channelTag).filter(tag => tag).join(', ') : '';
          if (!allChannelTags.toLowerCase().includes(channelTagsFilter)) return false;
        }
        
        // Reference Codes filter
        if (tagNumbersFilter) {
          const allTagNumbers = campaign.channels ? 
            campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
          if (!allTagNumbers.toLowerCase().includes(tagNumbersFilter)) return false;
        }
        
        return true;
      });
      
      // Update count
      countSpan.textContent = filteredCampaigns.length;
      
      // Display filtered campaigns
        if (filteredCampaigns.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="22" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
        return;
      }
      
      let html = '';
      filteredCampaigns.forEach((campaign, index) => {
        const workStartDate = formatDateDDMMYY(campaign.workStartDate);
        const startDate = formatDateDDMMYY(campaign.startDate);
        const endDate = formatDateDDMMYY(campaign.endDate);
        const tagNumbers = campaign.channels ? 
          campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
        const channelTypes = campaign.channels ? 
          campaign.channels.map(channel => channel.type).filter(type => type).join(', ') : '';
        const channelTags = campaign.channels ? 
          campaign.channels.map(channel => channel.channelTag).filter(tag => tag).join(', ') : '';
        
        // Check for images - handle both array and string formats
        const hasImages = campaign.images && (
          (Array.isArray(campaign.images) && campaign.images.length > 0) ||
          (typeof campaign.images === 'string' && campaign.images.trim() !== '')
        );
        const imageCount = Array.isArray(campaign.images) ? campaign.images.length : (campaign.images ? 1 : 0);
        const campaignIdStr = campaign._id ? (typeof campaign._id === 'string' ? campaign._id : campaign._id.toString()) : '';
        
        // Build image button HTML
        // Debug: Log image data for each campaign
        console.log(`[IMAGE DEBUG] Campaign ${index + 1} (${campaign.campaignId || 'N/A'}):`);
        console.log('  - campaign.images:', campaign.images);
        console.log('  - typeof images:', typeof campaign.images);
        console.log('  - isArray:', Array.isArray(campaign.images));
        console.log('  - hasImages:', hasImages);
        console.log('  - imageCount:', imageCount);
        console.log('  - campaignIdStr:', campaignIdStr);
        
        let imageButtonHtml = '';
        if (hasImages) {
          imageButtonHtml = `<button onclick="toggleCampaignImages('${campaignIdStr}')" class="btn-secondary py-1 px-3 rounded-md text-sm" title="View Images (${imageCount})">üì∑ View (${imageCount})</button>`;
        } else {
          imageButtonHtml = '<span class="text-gray-400 text-sm">No images</span>';
        }
        
        console.log(`[IMAGE DEBUG] Generated HTML for ${campaign.campaignId}:`, imageButtonHtml.substring(0, 80) + '...');
        
        html += `
          <tr>
            <td><input type="radio" name="selected_campaign" value="${campaign._id}" class="select-campaign-radio"></td>
            <td>${index + 1}</td>
            <td>${campaign.campaignId || ''}</td>
            <td>${campaign.name || ''}</td>
            <td>${campaign.description || ''}</td>
            <td>${workStartDate}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${campaign.budget ? new Intl.NumberFormat().format(campaign.budget) : ''}</td>
            <td>${campaign.status || ''}</td>
            <td>${campaign.jobAssignedTo || ''}</td>
            <td>${campaign.targetAudience?.age || ''}</td>
            <td>${campaign.targetAudience?.gender || ''}</td>
            <td>${campaign.goals && campaign.goals.sales ? new Intl.NumberFormat().format(campaign.goals.sales) : ''}</td>
            <td>${campaign.goals && campaign.goals.impressions ? new Intl.NumberFormat().format(campaign.goals.impressions) : ''}</td>
            <td>${campaign.goals && campaign.goals.conversions ? new Intl.NumberFormat().format(campaign.goals.conversions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.sales ? new Intl.NumberFormat().format(campaign.achieved.sales) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.impressions ? new Intl.NumberFormat().format(campaign.achieved.impressions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.conversions ? new Intl.NumberFormat().format(campaign.achieved.conversions) : ''}</td>
            <td>${channelTypes}</td>
            <td>${channelTags}</td>
            <td>${tagNumbers}</td>
            <td>${imageButtonHtml}</td>
          </tr>
        `;
      });
      
      console.log('[TABLE RENDER] Total HTML length:', html.length);
      console.log('[TABLE RENDER] Number of rows:', filteredCampaigns.length);
      if (html.length > 0) {
        console.log('[TABLE RENDER] Sample row HTML (first 300 chars):', html.substring(0, 300));
      }
      
      tableBody.innerHTML = html;
      
      // Verify Image column is present
      setTimeout(() => {
        const firstRow = tableBody.querySelector('tr');
        if (firstRow) {
          const cells = firstRow.querySelectorAll('td');
          console.log('[TABLE RENDER] Number of cells in first row:', cells.length);
          const lastCell = cells[cells.length - 1];
          if (lastCell) {
            console.log('[TABLE RENDER] Last cell (Image column) content:', lastCell.innerHTML);
          }
        }
      }, 100);
    }
    
    // Function to populate channel tag filter datalist from campaigns
    async function populateFilterChannelTagList() {
      try {
        const response = await fetch('/api/campaigns/channel-tags');
        if (!response.ok) {
          console.warn('Failed to fetch channel tags from campaigns');
          return;
        }
        
        const data = await response.json();
        const datalist = document.getElementById('filterChannelTagList');
        
        if (!datalist) return;
        
        // Clear existing options
        datalist.innerHTML = '';
        
        // Add options from campaigns
        if (data.tags && Array.isArray(data.tags)) {
          data.tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            datalist.appendChild(option);
          });
        }
      } catch (error) {
        console.warn('Error loading channel tags for filter:', error);
      }
    }
    
    // Override the original displayCampaignsTable function
    function displayCampaignsTable(campaigns) {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      
      // Refresh channel tag filter list with new data
      populateFilterChannelTagList();
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to edit campaign from table
    function editCampaignFromTable(campaignId) {
      // Set the campaign ID in the edit form and show edit section
      const editInput = document.getElementById('editCampaignId');
      if (editInput) {
        editInput.value = campaignId;
        showSection('edit-campaign');
        // Trigger the load campaign function
        loadCampaign();
      }
    }

    // Function to view campaign details
    function viewCampaignDetails(campaignId) {
      // Set the campaign ID in the query form and show query section
      const queryInput = document.getElementById('queryCampaignId');
      if (queryInput) {
        queryInput.value = campaignId;
        showSection('query-campaign');
        // Trigger the query function
        queryCampaign();
      }
    }

    // Function to toggle campaign images display
    window.toggleCampaignImages = function(campaignId) {
      console.log('toggleCampaignImages called with ID:', campaignId);
      console.log('originalCampaigns length:', originalCampaigns.length);
      
      // Find the campaign in originalCampaigns - try multiple matching strategies
      const campaign = originalCampaigns.find(c => {
        const cId = c._id ? (typeof c._id === 'string' ? c._id : c._id.toString()) : null;
        return cId === campaignId || c._id === campaignId;
      });
      
      console.log('Found campaign:', campaign);
      console.log('Campaign images:', campaign?.images);
      
      if (!campaign) {
        console.error('Campaign not found. Available IDs:', originalCampaigns.map(c => c._id));
        alert('Campaign not found');
        return;
      }

      // Check if images exist - handle both array and string formats
      let imagesArray = [];
      if (Array.isArray(campaign.images)) {
        imagesArray = campaign.images.filter(img => img && img.trim() !== '');
      } else if (typeof campaign.images === 'string' && campaign.images.trim() !== '') {
        imagesArray = [campaign.images];
      }
      
      if (imagesArray.length === 0) {
        console.warn('No images found for campaign:', campaign.campaignId, 'Images data:', campaign.images);
        alert('No images available for this campaign');
        return;
      }

      console.log('Displaying images:', imagesArray);

      // Find or create image modal/container
      let imageModal = document.getElementById('campaign-images-modal');
      
      if (!imageModal) {
        // Create modal if it doesn't exist
        imageModal = document.createElement('div');
        imageModal.id = 'campaign-images-modal';
        imageModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden';
        imageModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button onclick="closeCampaignImages()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-purple-700 mb-4">Campaign Images - ${campaign.campaignId || campaign.name || 'Unknown'}</h3>
            <div id="campaign-images-container" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
          </div>
        `;
        document.body.appendChild(imageModal);
      }

      // Populate images
      const container = document.getElementById('campaign-images-container');
      container.innerHTML = imagesArray.map((imagePath, index) => {
        // Ensure image path is properly formatted
        const cleanPath = imagePath.trim();
        console.log(`Loading image ${index + 1}:`, cleanPath);
        
        return `
        <div class="relative">
          <img src="${cleanPath}" 
               alt="Campaign Image ${index + 1}" 
               class="w-full h-48 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80"
               onclick="window.open('${cleanPath}', '_blank')"
               onerror="console.error('Failed to load image:', '${cleanPath}'); this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\'%3EImage not found%3C/text%3E%3C/svg%3E';">
          <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
            ${index + 1} / ${imagesArray.length}
          </div>
        </div>
      `;
      }).join('');

      // Show modal
      imageModal.classList.remove('hidden');
    };

    // Function to close campaign images modal
    window.closeCampaignImages = function() {
      const imageModal = document.getElementById('campaign-images-modal');
      if (imageModal) {
        imageModal.classList.add('hidden');
      }
    };

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const imageModal = document.getElementById('campaign-images-modal');
      if (imageModal && e.target === imageModal) {
        closeCampaignImages();
      }
    });

    // Auto-load campaigns table when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Show campaigns table by default
      showSection('campaigns-table');
      
      // Add filter event listeners
      addFilterEventListeners();
      
      // Add edit selected functionality
      addEditSelectedFunctionality();
      
      // Populate channel tag filter list
      populateFilterChannelTagList();
    });
    
    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Function to add filter event listeners
    function addFilterEventListeners() {
      const filterInputs = [
        'filter-campaign-id', 'filter-campaign-name', 'filter-offers', 
        'filter-work-start-date-from', 'filter-work-start-date-to', 'filter-start-date-from', 'filter-start-date-to', 'filter-end-date-from', 'filter-end-date-to',
        'filter-budget-min', 'filter-budget-max', 'filter-status', 'filter-job-assigned-to', 'filter-target-age', 'filter-target-gender',
        'filter-categories', 'filter-goal-sales-min', 'filter-goal-sales-max', 'filter-goal-impressions-min',
        'filter-goal-impressions-max', 'filter-goal-conversions-min', 'filter-goal-conversions-max',
        'filter-achieved-sales-min', 'filter-achieved-sales-max', 'filter-achieved-impressions-min',
        'filter-achieved-impressions-max', 'filter-achieved-conversions-min', 'filter-achieved-conversions-max',
        'filter-channels', 'filter-channel-tags', 'filter-tag-numbers'
      ];
      
      // Create debounced version of applyFilters
      const debouncedApplyFilters = debounce(applyFilters, 300);
      
      filterInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedApplyFilters);
          element.addEventListener('change', applyFilters);
        }
      });
    }
    
    
    // Function to add edit and delete selected functionality
    function addEditSelectedFunctionality() {
      console.log('[DEBUG] Initializing edit and delete functionality...');
      const deleteBtn = document.getElementById('delete-selected-btn');
      let selectedCampaignId = null;
      
      console.log('[DEBUG] Delete button found:', !!deleteBtn);
      
      // Always set up radio button event listener, regardless of delete button
        document.addEventListener('change', function(e) {
          if (e.target.classList.contains('select-campaign-radio')) {
          console.log('Radio button selected:', e.target.value);
            selectedCampaignId = e.target.value;
          
          // Enable delete button if it exists
          if (deleteBtn) {
            deleteBtn.disabled = false;
            console.log('Delete button enabled:', deleteBtn.disabled);
          }
          
          // Auto-load campaign details for query section if it's visible
          const querySection = document.getElementById('query-campaign');
          if (querySection && !querySection.classList.contains('hidden')) {
            console.log('Query section is visible, auto-loading campaign details...');
            querySelectedCampaign();
          }
          
          // Update the indicator in query section if it exists
          const indicator = document.getElementById('campaign-selected-indicator');
          const instructions = document.getElementById('query-instructions');
          if (indicator && instructions) {
            indicator.classList.remove('hidden');
            instructions.classList.add('hidden');
          }
        }
      });
    }
    
    // Function to delete campaign by ID
    async function deleteCampaignById(campaignId) {
      // Check if user has permission to delete campaigns
      if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
        alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
        return;
      }
      
      try {
        // Make API call to delete campaign
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          // Remove from local data
          originalCampaigns = originalCampaigns.filter(c => c._id !== campaignId);
          
          // Clear any radio selection
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) {
            selectedRadio.checked = false;
          }
          
          // Force table refresh with empty state handling
          if (originalCampaigns.length === 0) {
            const tableBody = document.getElementById('campaigns-table-body');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="21" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
            }
          }
          
          // Refresh the table
          displayCampaignsTable(originalCampaigns);
          
          // Update campaigns count
          const campaignsCount = document.getElementById('campaigns-count');
          if (campaignsCount) {
            campaignsCount.textContent = originalCampaigns.length;
          }
          
          // Show delete input for manual deletion of other campaigns
          setDeleteCampaignInputVisibility(true);
          
          console.log('Campaign deleted, campaigns remaining:', originalCampaigns.length);
          alert('Campaign deleted successfully!');
        } else {
          const error = await response.json();
          alert(`Failed to delete campaign: ${error.error || 'Unknown error'}`);
              }
      } catch (error) {
        console.error('Delete campaign error:', error);
        alert('Failed to delete campaign. Please try again.');
      }
    }
    // Ensure handler is registered after DOMContentLoaded
    window.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] DOMContentLoaded - initializing functions...');
      addEditCampaignMenuFunctionality();
      console.log('[DEBUG] Calling addEditSelectedFunctionality...');
      try {
        addEditSelectedFunctionality();
        console.log('[DEBUG] addEditSelectedFunctionality completed successfully');
      } catch (error) {
        console.error('[DEBUG] Error in addEditSelectedFunctionality:', error);
      }
      console.log('[DEBUG] Functions initialized.');
      

    });
  </script>

<!-- Edit Roles Modal -->
        <div id="editRolesModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-xs relative">
        <h3 class="text-md font-semibold text-purple-700 mb-3">Edit User Roles</h3>
        <select id="editRolesSelect" multiple class="w-full mb-4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
        <div class="flex justify-end gap-2">
          <button id="editRolesCancelBtn" type="button" class="btn-secondary px-4 py-2 rounded">Cancel</button>
          <button id="editRolesSaveBtn" type="button" class="btn-primary px-4 py-2 rounded">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/public/sessionManager.js"></script>
  <script src="/public/userManager.js"></script>
  
  <!-- Initialize application -->
<script>
    // Simple test to see if JavaScript is working
    console.log('[TEST] JavaScript is working');
    
    // Initialize application when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for session manager to initialize
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Add login form submission handler
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            alert('Please enter both username and password');
            return;
          }
          
          // Show loading state
          const submitBtn = loginForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Signing in...';
          submitBtn.disabled = true;
          
          try {
            const result = await sessionManager.login(username, password);
            
            if (result.success) {
              // Login successful - session manager will handle the rest
            } else {
              // Login failed
              const errorMessage = result.error || 'Login failed. Please check your credentials.';
              
              // Clear password field first
              document.getElementById('password').value = '';
              
              // Show error message in the form
              const errorDiv = document.getElementById('loginError');
              if (errorDiv) {
                errorDiv.textContent = 'Please check your username and password and try again.';
                errorDiv.classList.remove('hidden');
                
                // Hide error after 5 seconds
                setTimeout(() => {
                  errorDiv.classList.add('hidden');
                }, 5000);
              }
              
              // Also show alert for immediate attention
              alert('Please check your username and password and try again.');
            }
          } catch (error) {
            console.error('‚ùå Login error:', error);
            alert('Login failed. Please try again.');
            // Clear password field
            document.getElementById('password').value = '';
          } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
        });
      }
      
      // Session manager will handle showing login or main content
      
      // Multiple image upload handling
      let imageCounter = 1;
      
      // Handle image upload for existing and new image inputs
      window.setupImageHandling = function(imageInput) {
        imageInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
              alert('File size must be less than 5MB');
              this.value = '';
              return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
              alert('Please select an image file');
              this.value = '';
              return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = imageInput.closest('.image-upload-item').querySelector('.image-preview');
              const previewImg = preview.querySelector('img');
              previewImg.src = e.target.result;
              preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      // Handle remove image button
      window.setupRemoveImage = function(removeBtn) {
        removeBtn.addEventListener('click', function() {
          const imageItem = this.closest('.image-upload-item');
          const imageInput = imageItem.querySelector('.image-upload-input');
          const preview = imageItem.querySelector('.image-preview');
          
          imageInput.value = '';
          preview.classList.add('hidden');
          preview.querySelector('img').src = '';
        });
      }
      
      // Handle remove image field button
      function setupRemoveImageField(removeFieldBtn) {
        removeFieldBtn.addEventListener('click', function() {
          const imageItem = this.closest('.image-upload-item');
          imageItem.remove();
        });
      }
      
      // Setup initial image handling
      document.querySelectorAll('.image-upload-input').forEach(setupImageHandling);
      document.querySelectorAll('.remove-image-btn').forEach(setupRemoveImage);
      document.querySelectorAll('.remove-image-field-btn').forEach(setupRemoveImageField);
      

      
      // Add more images functionality
      const addImageBtn = document.getElementById('addImageBtn');
      const imageContainer = document.getElementById('imageUploadContainer');
      
      if (addImageBtn) {
        addImageBtn.addEventListener('click', function() {
          imageCounter++;
          const newImageItem = document.createElement('div');
          newImageItem.className = 'image-upload-item mb-4';
          newImageItem.innerHTML = `
            <input type="file" accept="image/*" class="image-upload-input w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div class="flex items-center justify-between mt-1">
              <p class="text-xs text-gray-500">Upload an image for this campaign (JPG, PNG, GIF - Max 5MB)</p>
              <button type="button" class="remove-image-field-btn text-red-500 hover:text-red-700 text-lg font-bold ml-2">√ó</button>
            </div>
            <div class="image-preview mt-2 hidden">
              <img src="" alt="Campaign Preview" class="max-w-xs h-32 object-cover rounded-md border">
              <button type="button" class="remove-image-btn mt-1 text-sm text-red-600 hover:text-red-800">Remove Image</button>
            </div>
          `;
          
          imageContainer.appendChild(newImageItem);
          
          // Setup handling for new image input
          const newImageInput = newImageItem.querySelector('.image-upload-input');
          const newRemoveBtn = newImageItem.querySelector('.remove-image-btn');
          const newRemoveFieldBtn = newImageItem.querySelector('.remove-image-field-btn');
          setupImageHandling(newImageInput);
          setupRemoveImage(newRemoveBtn);
          setupRemoveImageField(newRemoveFieldBtn);
        });
      }
      
      // Ensure only campaigns table is visible by default
      const allSections = document.querySelectorAll('.section');
      allSections.forEach(section => {
        if (section.id === 'campaigns-table') {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });

      // ==================== Channel Manager Functions ====================
      
      let currentEditingChannelId = null;

      // Load channels table
      async function loadChannelsTable() {
        try {
          const response = await fetch('/api/channels');
          if (!response.ok) throw new Error('Failed to fetch channels');
          const channels = await response.json();
          displayChannelsTable(channels);
        } catch (error) {
          console.error('Error loading channels:', error);
          alert('Failed to load channels. Please try again.');
        }
      }

      // Display channels in table
      function displayChannelsTable(channels) {
        const tableBody = document.getElementById('channels-table-body');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (!channels || channels.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">No channels found</td></tr>';
          return;
        }

        channels.forEach(channel => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${channel.channel_id || 'N/A'}</td>
            <td>${channel.channel_type || 'N/A'}</td>
            <td>${channel.channel_tag || '-'}</td>
            <td>${channel.add_tag || '-'}</td>
            <td>${channel.Mobile_no || '-'}</td>
            <td>${channel.Company_name || '-'}</td>
            <td>${channel.Tot_impressions || 0}</td>
            <td>${channel.Tot_conversions || 0}</td>
            <td>
              <button onclick="editChannel('${channel.channel_id}')" class="btn-primary py-1 px-3 rounded-md text-sm mr-2">Edit</button>
              <button onclick="deleteChannel('${channel.channel_id}')" class="btn-secondary py-1 px-3 rounded-md text-sm" style="background: #EF4444; color: white;">Delete</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      }

      // Show channel form
      function showChannelForm(channel = null) {
        const formSection = document.getElementById('channel-form-section');
        const tableSection = document.getElementById('channel-table-section');
        const formTitle = document.getElementById('channel-form-title');
        const form = document.getElementById('channelForm');

        if (channel) {
          // Edit mode
          currentEditingChannelId = channel.channel_id;
          formTitle.textContent = 'Edit Channel';
          document.getElementById('channelId').value = channel.channel_id;
          document.getElementById('channelType').value = channel.channel_type || '';
          document.getElementById('channelTag').value = channel.channel_tag || '';
          document.getElementById('addTag').value = channel.add_tag || '';
          document.getElementById('mobileNo').value = channel.Mobile_no || '';
          document.getElementById('companyName').value = channel.Company_name || '';
          document.getElementById('totImpressions').value = channel.Tot_impressions || 0;
          document.getElementById('totConversions').value = channel.Tot_conversions || 0;
        } else {
          // Create mode
          currentEditingChannelId = null;
          formTitle.textContent = 'Create New Channel';
          form.reset();
          document.getElementById('channelId').value = '';
        }

        tableSection.classList.add('hidden');
        formSection.classList.remove('hidden');
      }

      // Hide channel form
      function hideChannelForm() {
        const formSection = document.getElementById('channel-form-section');
        const tableSection = document.getElementById('channel-table-section');
        
        formSection.classList.add('hidden');
        tableSection.classList.remove('hidden');
        currentEditingChannelId = null;
      }

      // Edit channel
      window.editChannel = async function(channelId) {
        try {
          const response = await fetch(`/api/channels/${channelId}`);
          if (!response.ok) throw new Error('Failed to fetch channel');
          const channel = await response.json();
          showChannelForm(channel);
        } catch (error) {
          console.error('Error fetching channel:', error);
          alert('Failed to load channel. Please try again.');
        }
      };

      // Delete channel
      window.deleteChannel = async function(channelId) {
        if (!confirm(`Are you sure you want to delete channel ${channelId}?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/channels/${channelId}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('Failed to delete channel');

          alert('Channel deleted successfully');
          loadChannelsTable();
        } catch (error) {
          console.error('Error deleting channel:', error);
          alert('Failed to delete channel. Please try again.');
        }
      };

      // Show Priority Channels
      window.showPriorityChannels = async function() {
        const content = document.getElementById('priority-channels-content');
        
        if (!content) return;
        
        content.innerHTML = '<p class="text-gray-600">Loading priority channels data...</p>';
        
        try {
          // Fetch channels from channels table
          const channelsResponse = await fetch('/api/channels');
          if (!channelsResponse.ok) throw new Error('Failed to fetch channels');
          const channels = await channelsResponse.json();
          
          // Fetch all campaigns (marketing records)
          const campaignsResponse = await fetch('/api/campaigns');
          if (!campaignsResponse.ok) throw new Error('Failed to fetch campaigns');
          const campaigns = await campaignsResponse.json();
          
          console.log('Priority Channels Debug:', {
            channelsCount: channels.length,
            campaignsCount: campaigns.length,
            sampleChannel: channels[0],
            sampleCampaign: campaigns[0] ? {
              campaignId: campaigns[0].campaignId,
              channelsCount: campaigns[0].channels?.length || 0,
              sampleChannel: campaigns[0].channels?.[0]
            } : null
          });
          
          // Group channels by channel_type and channel_tag
          const priorityGroups = {};
          
          channels.forEach(channel => {
            const key = `${channel.channel_type}${channel.channel_tag ? '::' + channel.channel_tag : ''}`;
            
            if (!priorityGroups[key]) {
              priorityGroups[key] = {
                channel_type: channel.channel_type,
                channel_tag: channel.channel_tag || '',
                channel_id: channel.channel_id,
                total_impressions: 0,
                total_conversions: 0,
                marketing_count: 0,
                marketing_ids: []
              };
            }
            
            // Find matching channels in campaigns
            campaigns.forEach(campaign => {
              if (campaign.channels && Array.isArray(campaign.channels)) {
                campaign.channels.forEach(campaignChannel => {
                  // Match by channel type and channel tag
                  // Normalize values for comparison (trim whitespace, handle null/undefined, case-insensitive)
                  const channelType = (channel.channel_type || '').trim().toLowerCase();
                  const channelTag = (channel.channel_tag || '').trim().toLowerCase();
                  const campaignType = (campaignChannel.type || '').trim().toLowerCase();
                  // Check both channelTag and channel_tag field names
                  const campaignTag = ((campaignChannel.channelTag || campaignChannel.channel_tag || '').toString()).trim().toLowerCase();
                  
                  const typeMatch = channelType && campaignType && channelType === campaignType;
                  // Tag match: if channel has no tag, match any campaign channel; if channel has tag, must match exactly
                  const tagMatch = !channelTag || (campaignTag && channelTag === campaignTag);
                  
                  if (typeMatch && tagMatch) {
                    const impressions = parseInt(campaignChannel.impressions) || 0;
                    const conversions = parseInt(campaignChannel.conversions) || 0;
                    
                    priorityGroups[key].total_impressions += impressions;
                    priorityGroups[key].total_conversions += conversions;
                    
                    // Track unique marketing records
                    if (campaign.campaignId && !priorityGroups[key].marketing_ids.includes(campaign.campaignId)) {
                      priorityGroups[key].marketing_ids.push(campaign.campaignId);
                      priorityGroups[key].marketing_count++;
                    }
                  }
                });
              }
            });
          });
          
          console.log('Priority Groups Result:', priorityGroups);
          
          // Convert to array and sort by total impressions (descending)
          const priorityArray = Object.values(priorityGroups).sort((a, b) => {
            if (b.total_impressions !== a.total_impressions) {
              return b.total_impressions - a.total_impressions;
            }
            return b.total_conversions - a.total_conversions;
          });
          
          // Update channels collection with calculated totals
          if (priorityArray.length > 0) {
            try {
              const updates = priorityArray.map(group => ({
                channel_id: group.channel_id,
                Tot_impressions: group.total_impressions,
                Tot_conversions: group.total_conversions
              }));
              
              console.log('Sending bulk update for channels:', updates);
              
              const updateResponse = await fetch('/api/channels/bulk-update-totals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates })
              });
              
              if (updateResponse.ok) {
                const updateResult = await updateResponse.json();
                console.log('Channels updated successfully:', updateResult);
                
                // Show success message
                if (updateResult.updatedCount > 0) {
                  // Add success message to the priority channels display
                  const successMsg = document.createElement('div');
                  successMsg.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4';
                  successMsg.innerHTML = `‚úì Successfully updated ${updateResult.updatedCount} channel(s) in the channels collection.`;
                  content.insertBefore(successMsg, content.firstChild);
                  
                  // Reload channels table if it's visible to reflect the updates
                  const channelTableSection = document.getElementById('channel-table-section');
                  if (channelTableSection && !channelTableSection.classList.contains('hidden')) {
                    loadChannelsTable();
                  }
                }
                
                // Show warnings if there were errors
                if (updateResult.errors && updateResult.errors.length > 0) {
                  console.warn('Some channels failed to update:', updateResult.errors);
                }
              } else {
                const errorText = await updateResponse.text();
                console.error('Failed to update channels:', errorText);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorMsg.innerHTML = `‚úó Failed to update channels collection. Check console for details.`;
                content.insertBefore(errorMsg, content.firstChild);
              }
            } catch (updateError) {
              console.error('Error updating channels:', updateError);
              alert('Error updating channels: ' + updateError.message);
            }
          }
          
          // Display results
          if (priorityArray.length === 0) {
            content.innerHTML = '<p class="text-gray-600">No priority channels found. No matching channels in marketing records.</p>';
            return;
          }
          
          content.innerHTML = `
            <div class="overflow-x-auto">
              <table class="crm-table w-full">
                <thead>
                  <tr>
                    <th class="text-lg font-bold">Channel ID</th>
                    <th class="text-lg font-bold">Channel Type</th>
                    <th class="text-lg font-bold">Channel Tag</th>
                    <th class="text-lg font-bold">Total Impressions</th>
                    <th class="text-lg font-bold">Total Conversions</th>
                    <th class="text-lg font-bold">Marketing Records</th>
                    <th class="text-lg font-bold">Marketing IDs</th>
                  </tr>
                </thead>
                <tbody>
                  ${priorityArray.map(group => `
                    <tr>
                      <td>${group.channel_id || 'N/A'}</td>
                      <td>${group.channel_type || 'N/A'}</td>
                      <td>${group.channel_tag || '-'}</td>
                      <td class="text-right">${new Intl.NumberFormat().format(group.total_impressions)}</td>
                      <td class="text-right">${new Intl.NumberFormat().format(group.total_conversions)}</td>
                      <td class="text-right">${group.marketing_count}</td>
                      <td>${group.marketing_ids.join(', ') || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } catch (error) {
          console.error('Error loading priority channels:', error);
          content.innerHTML = `<p class="text-red-600">Error loading priority channels: ${error.message}</p>`;
        }
      };


      // Setup channel form event listeners
      const addChannelBtn = document.getElementById('addChannelBtn');
      const cancelChannelBtn = document.getElementById('cancelChannelBtn');
      const channelForm = document.getElementById('channelForm');

      if (addChannelBtn) {
        addChannelBtn.addEventListener('click', () => showChannelForm());
      }

      if (cancelChannelBtn) {
        cancelChannelBtn.addEventListener('click', hideChannelForm);
      }

      if (channelForm) {
        channelForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = {
            channel_type: document.getElementById('channelType').value,
            channel_tag: document.getElementById('channelTag').value,
            add_tag: document.getElementById('addTag').value,
            Mobile_no: document.getElementById('mobileNo').value,
            Company_name: document.getElementById('companyName').value,
            Tot_conversions: parseInt(document.getElementById('totConversions').value) || 0
          };

          try {
            let response;
            if (currentEditingChannelId) {
              // Update existing channel
              response = await fetch(`/api/channels/${currentEditingChannelId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });
            } else {
              // Create new channel
              response = await fetch('/api/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });
            }

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Failed to save channel');
            }

            alert(currentEditingChannelId ? 'Channel updated successfully' : 'Channel created successfully');
            hideChannelForm();
            loadChannelsTable();
          } catch (error) {
            console.error('Error saving channel:', error);
            alert(error.message || 'Failed to save channel. Please try again.');
          }
        });
      }

      // Load channels when channel-manager section is shown
      const originalShowSection = window.showSection;
      window.showSection = function(sectionId) {
        originalShowSection(sectionId);
        if (sectionId === 'channel-manager') {
          loadChannelsTable();
        }
        if (sectionId === 'new-campaign') {
          populateChannelTagList();
        }
      };

      // Populate channel tags when page loads
      document.addEventListener('DOMContentLoaded', function() {
        populateChannelTagList();
      });
});

    // Employee Management Functions
    function showEmployeeSection() {
      const userSection = document.getElementById('user-manager-user-section');
      const roleSection = document.getElementById('user-manager-role-section');
      const employeeSection = document.getElementById('user-manager-employee-section');
      
      if (userSection) userSection.classList.add('hidden');
      if (roleSection) roleSection.classList.add('hidden');
      if (employeeSection) employeeSection.classList.remove('hidden');
      
      const toggleUserBtn = document.getElementById('toggleUserBtn');
      const toggleRoleBtn = document.getElementById('toggleRoleBtn');
      const toggleEmployeeBtn = document.getElementById('toggleEmployeeBtn');
      
      if (toggleUserBtn) {
        toggleUserBtn.classList.remove('btn-primary');
        toggleUserBtn.classList.add('btn-secondary');
      }
      if (toggleRoleBtn) {
        toggleRoleBtn.classList.remove('btn-primary');
        toggleRoleBtn.classList.add('btn-secondary');
      }
      if (toggleEmployeeBtn) {
        toggleEmployeeBtn.classList.remove('btn-secondary');
        toggleEmployeeBtn.classList.add('btn-primary');
      }
      
      const employeeTableSection = document.getElementById('employee-table-section');
      const employeeCreateFormSection = document.getElementById('employee-create-form-section');
      const employeeEditFormSection = document.getElementById('employee-edit-form-section');
      
      if (employeeTableSection) employeeTableSection.classList.remove('hidden');
      if (employeeCreateFormSection) employeeCreateFormSection.classList.add('hidden');
      if (employeeEditFormSection) employeeEditFormSection.classList.add('hidden');
      renderEmployeesTable();
    }

    function showEmployeeCreateForm() {
      const employeeTableSection = document.getElementById('employee-table-section');
      const employeeCreateFormSection = document.getElementById('employee-create-form-section');
      const employeeEditFormSection = document.getElementById('employee-edit-form-section');
      
      if (employeeTableSection) employeeTableSection.classList.add('hidden');
      if (employeeCreateFormSection) employeeCreateFormSection.classList.remove('hidden');
      if (employeeEditFormSection) employeeEditFormSection.classList.add('hidden');
      document.getElementById('createEmployeeForm').reset();
    }

    function hideEmployeeForm() {
      const employeeTableSection = document.getElementById('employee-table-section');
      const employeeCreateFormSection = document.getElementById('employee-create-form-section');
      
      if (employeeTableSection) employeeTableSection.classList.remove('hidden');
      if (employeeCreateFormSection) employeeCreateFormSection.classList.add('hidden');
    }

    function showEmployeeEditForm(employeeId) {
      const employeeTableSection = document.getElementById('employee-table-section');
      const employeeCreateFormSection = document.getElementById('employee-create-form-section');
      const employeeEditFormSection = document.getElementById('employee-edit-form-section');
      
      if (employeeTableSection) employeeTableSection.classList.add('hidden');
      if (employeeCreateFormSection) employeeCreateFormSection.classList.add('hidden');
      if (employeeEditFormSection) employeeEditFormSection.classList.remove('hidden');
      loadEmployeeForEdit(employeeId);
    }

    function hideEmployeeEditForm() {
      const employeeTableSection = document.getElementById('employee-table-section');
      const employeeEditFormSection = document.getElementById('employee-edit-form-section');
      
      if (employeeTableSection) employeeTableSection.classList.remove('hidden');
      if (employeeEditFormSection) employeeEditFormSection.classList.add('hidden');
    }

    async function renderEmployeesTable() {
      try {
        const response = await fetch('/api/employees');
        const employees = await response.json();
        const tbody = document.getElementById('employees-table-body');
        
        if (tbody) {
          tbody.innerHTML = '';
          if (Array.isArray(employees) && employees.length > 0) {
            employees.forEach(employee => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><b>${employee.employee_id || 'N/A'}</b></td>
                <td>${employee.name || 'N/A'}</td>
                <td>${employee.email || 'N/A'}</td>
                <td>${employee.phone || 'N/A'}</td>
                <td>${employee.department || 'N/A'}</td>
                <td>${employee.position || 'N/A'}</td>
                <td>
                  <button style="background:#FFC107;color:#222;font-weight:bold;border:none;padding:6px 18px;border-radius:6px;cursor:pointer;margin-right:6px;" onclick="showEmployeeEditForm('${employee._id}')">Edit</button>
                  <button style="background:#EF4444;color:white;font-weight:bold;border:none;padding:6px 18px;border-radius:6px;cursor:pointer;" onclick="deleteEmployee('${employee._id}')">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No employees found.</td></tr>';
          }
        }
      } catch (error) {
        console.error('Error fetching employees:', error);
        const tbody = document.getElementById('employees-table-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500 py-4">Error loading employees</td></tr>';
        }
      }
    }

    async function loadEmployeeForEdit(employeeId) {
      try {
        const response = await fetch(`/api/employees/${employeeId}`);
        const employee = await response.json();
        
        document.getElementById('editEmployeeId').value = employee._id;
        document.getElementById('editEmployeeName').value = employee.name || '';
        document.getElementById('editEmployeeEmail').value = employee.email || '';
        document.getElementById('editEmployeePhone').value = employee.phone || '';
        document.getElementById('editEmployeeDepartment').value = employee.department || '';
        document.getElementById('editEmployeePosition').value = employee.position || '';
      } catch (error) {
        console.error('Error loading employee:', error);
        alert('Error loading employee data');
      }
    }

    async function deleteEmployee(employeeId) {
      if (!confirm('Are you sure you want to delete this employee?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/employees/${employeeId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Employee deleted successfully');
          renderEmployeesTable();
          // Refresh job assignment dropdowns
          if (typeof window.refreshJobAssignmentDropdowns === 'function') {
            window.refreshJobAssignmentDropdowns();
          }
        } else {
          const error = await response.json();
          alert('Error: ' + (error.error || 'Failed to delete employee'));
        }
      } catch (error) {
        console.error('Error deleting employee:', error);
        alert('Error deleting employee');
      }
    }

    // Attach event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const toggleEmployeeBtn = document.getElementById('toggleEmployeeBtn');
      const addEmployeeBtn = document.getElementById('addEmployeeBtn');
      
      if (toggleEmployeeBtn) {
        toggleEmployeeBtn.addEventListener('click', showEmployeeSection);
      }
      
      if (addEmployeeBtn) {
        addEmployeeBtn.addEventListener('click', showEmployeeCreateForm);
      }

      // Employee form handlers
      const createEmployeeForm = document.getElementById('createEmployeeForm');
      if (createEmployeeForm) {
        createEmployeeForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = {
            name: document.getElementById('newEmployeeName').value,
            email: document.getElementById('newEmployeeEmail').value,
            phone: document.getElementById('newEmployeePhone').value,
            department: document.getElementById('newEmployeeDepartment').value,
            position: document.getElementById('newEmployeePosition').value
          };
          
          try {
            const response = await fetch('/api/employees', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            
            if (response.ok) {
              alert('Employee created successfully');
              hideEmployeeForm();
              renderEmployeesTable();
              // Refresh job assignment dropdowns
              if (typeof window.refreshJobAssignmentDropdowns === 'function') {
                window.refreshJobAssignmentDropdowns();
              }
            } else {
              const error = await response.json();
              alert('Error: ' + (error.error || 'Failed to create employee'));
            }
          } catch (error) {
            console.error('Error creating employee:', error);
            alert('Error creating employee');
          }
        });
      }

      const editEmployeeForm = document.getElementById('editEmployeeForm');
      if (editEmployeeForm) {
        editEmployeeForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const employeeId = document.getElementById('editEmployeeId').value;
          const formData = {
            name: document.getElementById('editEmployeeName').value,
            email: document.getElementById('editEmployeeEmail').value,
            phone: document.getElementById('editEmployeePhone').value,
            department: document.getElementById('editEmployeeDepartment').value,
            position: document.getElementById('editEmployeePosition').value
          };
          
          try {
            const response = await fetch(`/api/employees/${employeeId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            
            if (response.ok) {
              alert('Employee updated successfully');
              hideEmployeeEditForm();
              renderEmployeesTable();
              // Refresh job assignment dropdowns
              if (typeof window.refreshJobAssignmentDropdowns === 'function') {
                window.refreshJobAssignmentDropdowns();
              }
            } else {
              const error = await response.json();
              alert('Error: ' + (error.error || 'Failed to update employee'));
            }
          } catch (error) {
            console.error('Error updating employee:', error);
            alert('Error updating employee');
          }
        });
      }
    });

    // Make functions globally accessible
    window.showEmployeeEditForm = showEmployeeEditForm;
    window.deleteEmployee = deleteEmployee;
    window.hideEmployeeForm = hideEmployeeForm;
    window.hideEmployeeEditForm = hideEmployeeEditForm;
    window.renderEmployeesTable = renderEmployeesTable;
</script>

</body>